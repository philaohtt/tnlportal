<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.5, maximum-scale=3.0">
    <title>Student Directory - Admission Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
            <div class="flex justify-between items-start mb-4">
                <div class="flex items-center">
                    <div class="bg-blue-100 p-3 rounded-lg mr-4">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-semibold text-gray-900 mb-1 flex items-center">
                            📚 <span data-en="Student Directory" data-vi="Danh Sách Học Sinh">Student Directory</span>
                        </h1>
                        <p class="text-gray-600"><span data-en="Browse and manage student profiles" data-vi="Duyệt và quản lý hồ sơ học sinh">Browse and manage student profiles</span></p>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <!-- Language Switcher -->
                    <div class="flex items-center gap-2">
                        <button id="langEn" onclick="switchLanguage('en')" class="px-3 py-1 text-xs font-medium rounded-lg bg-blue-100 text-blue-800">EN</button>
                        <button id="langVi" onclick="switchLanguage('vi')" class="px-3 py-1 text-xs font-medium rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200">VI</button>
                    </div>
                    
                    <!-- Sync Status -->
                    <div id="syncIndicator" class="flex items-center px-3 py-2 rounded-lg text-xs border">
                        <div id="syncIcon" class="w-2 h-2 rounded-full mr-2 bg-green-500"></div>
                        <span id="syncText">Connected</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter Bar -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
            <div class="flex flex-wrap gap-4 items-center justify-between">
                <div class="flex gap-4 items-center">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Search students..." 
                               class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-64">
                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <select id="classFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Classes</option>
                        <option value="Class 9-A">Class 9-A</option>
                        <option value="Class 10-C">Class 10-C</option>
                        <option value="Class 11-A">Class 11-A</option>
                        <option value="Class 11-B">Class 11-B</option>
                        <option value="Class 12-A">Class 12-A</option>
                        <option value="Class 12-B">Class 12-B</option>
                    </select>
                </div>
                
                <div class="flex gap-2">
                    <button id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh
                    </button>
                    <span id="studentCount" class="flex items-center px-4 py-2 bg-gray-100 rounded-lg text-sm font-medium text-gray-700">
                        Total: 0 students
                    </span>
                </div>
            </div>

            <!-- Tabs -->
            <div class="mt-4">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8 overflow-x-auto">
                        <button onclick="switchTab('active')" id="activeTab" class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600">
                            Active Students (<span id="activeTabCount">0</span>)
                        </button>
                        <button onclick="switchTab('inactive')" id="inactiveTab" class="whitespace-nowrap py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm">
                            Inactive/Finished (<span id="inactiveTabCount">0</span>)
                        </button>
                        <button onclick="switchTab('dropped')" id="droppedTab" class="whitespace-nowrap py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm">
                            Dropped (<span id="droppedTabCount">0</span>)
                        </button>
                    </nav>
                </div>
            </div>
        </div>
        
        <!-- Students Table -->
        <div class="bg-white rounded-lg shadow-sm border overflow-hidden mb-6">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">DOB</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">School</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">Class</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden lg:table-cell">Year Enrolled</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden lg:table-cell">Parent</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden xl:table-cell">Contact</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Students will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Student Profile Modal -->
        <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <!-- Modal Header -->
                <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-t-lg">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div>
                                <h2 id="modalStudentName" class="text-2xl font-bold mb-1">Student Name</h2>
                                <p id="modalStudentId" class="text-blue-100">Student ID: ---</p>
                                <p id="modalStudentClass" class="text-blue-100">Class: ---</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button id="exportPdfBtn" class="bg-white/20 hover:bg-white/30 text-white px-3 py-2 rounded-lg flex items-center gap-2 text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                PDF
                            </button>
                            <button id="exportImageBtn" class="bg-white/20 hover:bg-white/30 text-white px-3 py-2 rounded-lg flex items-center gap-2 text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                Image
                            </button>
                            <button id="embedCodeBtn" class="bg-white/20 hover:bg-white/30 text-white px-3 py-2 rounded-lg flex items-center gap-2 text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                                </svg>
                                Embed
                            </button>
                            <button id="closeProfileModal" class="bg-white/20 hover:bg-white/30 text-white p-2 rounded-lg">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal Content -->
                <div id="profileContent" class="p-6">
                    <!-- Profile Tabs -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="flex space-x-8 overflow-x-auto">
                            <button type="button" onclick="switchProfileTab('basic')" id="basicProfileTab" class="py-2 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600 whitespace-nowrap">
                                📋 <span data-en="Basic & Contact" data-vi="Thông Tin & Liên Hệ">Basic & Contact</span>
                            </button>
                            <button type="button" onclick="switchProfileTab('attendance')" id="attendanceProfileTab" class="py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm whitespace-nowrap">
                                📅 <span data-en="Attendance" data-vi="Điểm Danh">Attendance</span>
                            </button>
                            <button type="button" onclick="switchProfileTab('studyprogress')" id="studyprogressProfileTab" class="py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm whitespace-nowrap">
                                📚 <span data-en="Study Progress" data-vi="Tiến Độ Học Tập">Study Progress</span>
                            </button>
                            <button type="button" onclick="switchProfileTab('accounts')" id="accountsProfileTab" class="py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm whitespace-nowrap">
                                👤 <span data-en="Study Accounts" data-vi="Tài Khoản Học Tập">Study Accounts</span>
                            </button>
                            <button type="button" onclick="switchProfileTab('tuition')" id="tuitionProfileTab" class="py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm whitespace-nowrap">
                                💰 <span data-en="Tuition" data-vi="Học Phí">Tuition</span>
                            </button>
                        </nav>
                    </div>

                    <!-- Basic & Contact Information Tab -->
                    <div id="basicProfileContent" class="space-y-6">
                        <!-- Basic Information Section -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                📋 <span data-en="Basic Information" data-vi="Thông Tin Cơ Bản">Basic Information</span>
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <label class="text-sm font-medium text-gray-600">Student ID</label>
                                    <p id="basicStudentId" class="text-gray-900 font-medium">---</p>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <label class="text-sm font-medium text-gray-600">Full Name</label>
                                    <p id="basicFullName" class="text-gray-900 font-medium">---</p>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <label class="text-sm font-medium text-gray-600">Date of Birth</label>
                                    <p id="basicDateOfBirth" class="text-gray-900 font-medium">---</p>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <label class="text-sm font-medium text-gray-600">Status</label>
                                    <span id="basicStatus" class="inline-flex px-2 py-1 text-xs font-semibold rounded-full">---</span>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <label class="text-sm font-medium text-gray-600">School</label>
                                    <p id="basicSchool" class="text-gray-900 font-medium">---</p>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <label class="text-sm font-medium text-gray-600">Class Assignment</label>
                                    <p id="basicClassAssignment" class="text-gray-900 font-medium">---</p>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-lg md:col-span-2">
                                    <label class="text-sm font-medium text-gray-600">Year Enrolled</label>
                                    <p id="basicYearEnrolled" class="text-gray-900 font-medium">---</p>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Information Section -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                📞 <span data-en="Contact Information" data-vi="Thông Tin Liên Hệ">Contact Information</span>
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <label class="text-sm font-medium text-gray-600">Student Phone</label>
                                    <p id="contactStudentPhone" class="text-gray-900 font-medium">---</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <label class="text-sm font-medium text-gray-600">Parent Name</label>
                                    <p id="contactParentName" class="text-gray-900 font-medium">---</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg md:col-span-2">
                                    <label class="text-sm font-medium text-gray-600">Parent Phone</label>
                                    <p id="contactParentPhone" class="text-gray-900 font-medium">---</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Study Progress Tab -->
                    <div id="studyprogressProfileContent" class="space-y-4 hidden">
                        <!-- Student Overview Banner -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <h4 class="font-semibold text-gray-900" id="progressStudentName">Student Name</h4>
                                    <p class="text-sm text-gray-600" id="progressStudentId">Student ID</p>
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full mt-1" id="progressStudentStatus">Status</span>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600"><span data-en="First Lesson" data-vi="Buổi Học Đầu">First Lesson</span></p>
                                    <p class="font-medium" id="progressFirstLesson">Not available</p>
                                    <p class="text-sm text-gray-600 mt-2"><span data-en="Recent Lesson" data-vi="Buổi Học Gần Nhất">Recent Lesson</span></p>
                                    <p class="font-medium" id="progressRecentLesson">Not available</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600"><span data-en="Total Lessons" data-vi="Tổng Số Buổi Học">Total Lessons</span></p>
                                    <p class="font-medium text-lg" id="progressTotalLessons">0</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600"><span data-en="Total Assessments" data-vi="Tổng Số Đánh Giá">Total Assessments</span></p>
                                    <div class="flex items-center mt-1">
                                        <span class="text-2xl font-bold" id="progressOverallScore">--</span>
                                        <span class="text-sm text-gray-500 ml-1" data-en="assessments" data-vi="đánh giá">assessments</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1"><span data-en="General Progress & Performance Notes" data-vi="Ghi Chú Tiến Độ & Hiệu Suất Chung">General Progress & Performance Notes</span></label>
                                <textarea id="generalProgress" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2" data-en-placeholder="Enter general progress observations and performance notes..." data-vi-placeholder="Nhập ghi chú quan sát tiến độ và hiệu suất chung..."></textarea>
                            </div>
                        </div>

                        <!-- Performance Results Section -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                📊 <span data-en="Assessment Results" data-vi="Kết Quả Đánh Giá">Assessment Results</span> (<span id="assessmentCount">0</span>)
                            </h4>
                            <div id="assessmentResultsList" class="space-y-3">
                                <!-- Assessment results will be loaded here -->
                            </div>
                        </div>

                        <!-- In Progress Courses -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                🔄 <span data-en="In Progress Courses" data-vi="Khóa Học Đang Học">In Progress Courses</span> (<span id="inprogressCount">0</span>)
                            </h4>
                            <div id="inprogressCoursesList" class="space-y-2">
                                <!-- In progress courses will be loaded here -->
                            </div>
                        </div>

                        <!-- Upcoming Courses -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                ⏳ <span data-en="Upcoming Courses" data-vi="Khóa Học Sắp Tới">Upcoming Courses</span> (<span id="upcomingCount">0</span>)
                            </h4>
                            <div id="upcomingCoursesList" class="space-y-2">
                                <!-- Upcoming courses will be loaded here -->
                            </div>
                        </div>

                        <!-- Finished Courses -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                ✅ <span data-en="Finished Courses" data-vi="Khóa Học Đã Hoàn Thành">Finished Courses</span> (<span id="finishedCount">0</span>)
                            </h4>
                            <div id="finishedCoursesList" class="space-y-2">
                                <!-- Finished courses will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Attendance Tab -->
                    <div id="attendanceProfileContent" class="space-y-4 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-semibold text-gray-900"><span data-en="Monthly Attendance Records" data-vi="Bản Ghi Điểm Danh Hàng Tháng">Monthly Attendance Records</span></h4>
                            <div class="flex items-center gap-4 text-sm">
                                <div class="flex items-center gap-1">
                                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                    <span data-en="Present" data-vi="Có Mặt">Present</span>
                                </div>
                                <div class="flex items-center gap-1">
                                    <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                    <span data-en="Absent" data-vi="Vắng Mặt">Absent</span>
                                </div>
                            </div>
                        </div>
                        <div id="attendanceRecords" class="space-y-4">
                            <!-- Attendance records will be loaded here -->
                        </div>
                    </div>



                    <!-- Study Accounts Tab -->
                    <div id="accountsProfileContent" class="space-y-4 hidden">
                        <h4 class="text-lg font-semibold text-gray-900 mb-3"><span data-en="Study Accounts" data-vi="Tài Khoản Học Tập">Study Accounts</span></h4>
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <p class="text-gray-600"><span data-en="Study accounts management will be implemented here." data-vi="Quản lý tài khoản học tập sẽ được triển khai tại đây.">Study accounts management will be implemented here.</span></p>
                        </div>
                    </div>

                    <!-- Tuition Tab -->
                    <div id="tuitionProfileContent" class="space-y-4 hidden">
                        <h4 class="text-lg font-semibold text-gray-900 mb-3"><span data-en="Tuition Information" data-vi="Thông Tin Học Phí">Tuition Information</span></h4>
                        
                        <p class="text-gray-600 mb-6"><span data-en="Below is the information regarding the tuition of the student." data-vi="Dưới đây là thông tin về học phí của học sinh.">Below is the information regarding the tuition of the student.</span></p>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Tuition Records -->
                            <div class="lg:col-span-2 space-y-4">
                                <!-- Unpaid Tuition Section -->
                                <div class="bg-red-50 border border-red-200 rounded-lg">
                                    <button onclick="toggleTuitionSection('unpaid')" class="w-full flex justify-between items-center p-4 text-left hover:bg-red-100 transition-colors">
                                        <h5 class="font-semibold text-red-800 flex items-center">
                                            🔴 <span data-en="Unpaid Tuition" data-vi="Học Phí Chưa Thanh Toán" class="ml-2">Unpaid Tuition</span>
                                            <span id="unpaidCount" class="ml-2 bg-red-200 text-red-800 px-2 py-1 rounded-full text-xs">(0)</span>
                                        </h5>
                                        <svg id="unpaidChevron" class="w-5 h-5 text-red-600 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div id="unpaidTuitionContent" class="px-4 pb-4">
                                        <div id="unpaidTuitionList" class="space-y-2">
                                            <!-- Unpaid tuition items will be loaded here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Processing Tuition Section -->
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg">
                                    <button onclick="toggleTuitionSection('processing')" class="w-full flex justify-between items-center p-4 text-left hover:bg-yellow-100 transition-colors">
                                        <h5 class="font-semibold text-yellow-800 flex items-center">
                                            🔄 <span data-en="Paid - Processing" data-vi="Đã Thanh Toán - Đang Xử Lý" class="ml-2">Paid - Processing</span>
                                            <span id="processingCount" class="ml-2 bg-yellow-200 text-yellow-800 px-2 py-1 rounded-full text-xs">(0)</span>
                                        </h5>
                                        <svg id="processingChevron" class="w-5 h-5 text-yellow-600 transform transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div id="processingTuitionContent" class="px-4 pb-4 hidden">
                                        <div id="processingTuitionList" class="space-y-2">
                                            <!-- Processing tuition items will be loaded here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Paid Tuition Section -->
                                <div class="bg-green-50 border border-green-200 rounded-lg">
                                    <button onclick="toggleTuitionSection('paid')" class="w-full flex justify-between items-center p-4 text-left hover:bg-green-100 transition-colors">
                                        <h5 class="font-semibold text-green-800 flex items-center">
                                            ✅ <span data-en="Paid Tuition" data-vi="Học Phí Đã Thanh Toán" class="ml-2">Paid Tuition</span>
                                            <span id="paidCount" class="ml-2 bg-green-200 text-green-800 px-2 py-1 rounded-full text-xs">(0)</span>
                                        </h5>
                                        <svg id="paidChevron" class="w-5 h-5 text-green-600 transform transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div id="paidTuitionContent" class="px-4 pb-4 hidden">
                                        <div id="paidTuitionList" class="space-y-2">
                                            <!-- Paid tuition items will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Summary -->
                            <div class="lg:col-span-1">
                                <div class="bg-white border border-gray-200 rounded-lg p-6 sticky top-4">
                                    <h5 class="font-semibold text-gray-900 mb-4"><span data-en="Payment Summary" data-vi="Tóm Tắt Thanh Toán">Payment Summary</span></h5>
                                    
                                    <div class="space-y-4">
                                        <div class="flex justify-between items-center py-2">
                                            <span class="text-gray-600"><span data-en="Total Outstanding" data-vi="Tổng Còn Nợ">Total Outstanding</span>:</span>
                                            <span id="totalOutstandingAmount" class="font-bold text-red-600 text-lg">0 VND</span>
                                        </div>
                                    </div>
                                    
                                    <button id="payTuitionBtn" onclick="showPaymentInstructions()" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                                        💳 <span data-en="Pay Tuition" data-vi="Thanh Toán Học Phí" class="ml-2">Pay Tuition</span>
                                    </button>
                                    
                                    <p class="text-xs text-blue-600 mt-2 text-center cursor-pointer hover:underline" onclick="showPaymentInstructions()">
                                        <span data-en="Please click here for instructions" data-vi="Vui lòng nhấp vào đây để xem hướng dẫn">Please click here for instructions</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Embed Code Modal -->
        <div id="embedModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-900">📎 Share Student Profile</h3>
                    <button id="closeEmbedModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Direct Link Section -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium text-gray-900 mb-3">🔗 Direct Profile Link</h4>
                    <p class="text-gray-600 mb-3">Share this unique link to give direct access to this student's profile:</p>
                    <div class="flex gap-2">
                        <input id="directProfileLink" class="flex-1 p-3 border border-gray-300 rounded-lg font-mono text-sm bg-gray-50" readonly>
                        <button id="copyDirectLink" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg whitespace-nowrap">
                            Copy Link
                        </button>
                    </div>
                </div>
                
                <!-- Embed Code Section -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium text-gray-900 mb-3">📋 Embed Code</h4>
                    <p class="text-gray-600 mb-3">Copy this code to embed the student profile in your website, Notion page, or any HTML document:</p>
                    <textarea id="embedCode" class="w-full h-32 p-3 border border-gray-300 rounded-lg font-mono text-sm bg-gray-50" readonly></textarea>
                    <button id="copyEmbedCode" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        Copy Embed Code
                    </button>
                </div>
                
                <!-- Preview Section -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <h4 class="text-lg font-medium text-gray-900 mb-3">👀 Preview</h4>
                    <div class="bg-white border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                        <div class="text-gray-500 mb-2">
                            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">The embedded profile will display here</p>
                        <p class="text-xs text-gray-500">Mobile-responsive • Secure • Real-time updates</p>
                    </div>
                </div>
                
                <!-- Features List -->
                <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h5 class="font-medium text-blue-900 mb-2">✨ Profile Features:</h5>
                    <ul class="text-sm text-blue-800 space-y-1">
                        <li>• 📱 Mobile-responsive design</li>
                        <li>• 🔄 Real-time data updates</li>
                        <li>• 🔒 Secure access (view-only)</li>
                        <li>• 🌐 Works on all devices and browsers</li>
                        <li>• 💳 Integrated payment instructions</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Payment Instructions Modal -->
        <div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-green-600 to-green-700 text-white p-6 rounded-t-lg">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-bold mb-1">💳 <span data-en="Payment Instructions" data-vi="Hướng Dẫn Thanh Toán">Payment Instructions</span></h3>
                            <p class="text-green-100"><span data-en="Bank Transfer Details" data-vi="Chi Tiết Chuyển Khoản">Bank Transfer Details</span></p>
                        </div>
                        <button id="closePaymentModal" class="bg-white/20 hover:bg-white/30 text-white p-2 rounded-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Modal Content -->
                <div class="p-6">
                    <p class="text-gray-700 mb-6"><span data-en="Please make bank transfers into the following account:" data-vi="Vui lòng chuyển khoản vào tài khoản sau:">Please make bank transfers into the following account:</span></p>
                    
                    <!-- Bank Details -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1"><span data-en="Bank Name" data-vi="Tên Ngân Hàng">Bank Name</span></label>
                                    <p class="text-lg font-semibold text-gray-900">Techcombank</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1"><span data-en="Account Holder" data-vi="Chủ Tài Khoản">Account Holder</span></label>
                                    <p class="text-lg font-semibold text-gray-900">HOANG THANH TUNG</p>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1"><span data-en="Account Number" data-vi="Số Tài Khoản">Account Number</span></label>
                                    <div class="flex items-center gap-2">
                                        <p class="text-lg font-semibold text-gray-900 font-mono">5141 4131 319</p>
                                        <button onclick="copyToClipboard('5141 4131 319')" class="text-blue-600 hover:text-blue-800 p-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1"><span data-en="Amount" data-vi="Số Tiền">Amount</span></label>
                                    <div class="flex items-center gap-2">
                                        <p id="paymentAmount" class="text-lg font-bold text-red-600">0 VND</p>
                                        <button onclick="copyPaymentAmount()" class="text-blue-600 hover:text-blue-800 p-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-600 mb-1"><span data-en="Transfer Content" data-vi="Nội Dung Chuyển Khoản">Transfer Content</span></label>
                            <div class="flex items-center gap-2">
                                <p id="paymentContent" class="text-lg font-semibold text-gray-900 font-mono bg-white px-3 py-2 rounded border flex-1">Loading...</p>
                                <button onclick="copyPaymentContent()" class="text-blue-600 hover:text-blue-800 p-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- QR Code Section -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">📱 <span data-en="Quick Payment QR Code" data-vi="Mã QR Thanh Toán Nhanh">Quick Payment QR Code</span></h4>
                        <div class="flex justify-center mb-4">
                            <div id="qrCodeContainer" class="bg-white p-4 rounded-lg border-2 border-gray-300">
                                <img id="qrCodeImage" src="" alt="VietQR Payment Code" class="w-48 h-48 mx-auto" style="display: none;">
                                <div id="qrCodeLoading" class="w-48 h-48 flex items-center justify-center text-gray-500">
                                    <div class="text-center">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                                        <p class="text-sm">Generating QR...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">
                            <span data-en="Scan this QR code with your banking app for quick payment" data-vi="Quét mã QR này bằng ứng dụng ngân hàng để thanh toán nhanh">Scan this QR code with your banking app for quick payment</span>
                        </p>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                            <div class="flex items-center gap-2">
                                <div class="text-yellow-600">⚠️</div>
                                <p class="text-sm text-yellow-800 font-medium">
                                    <span data-en="This is a one-time code. Please do NOT reuse it in the future." data-vi="Đây là mã một lần. Vui lòng KHÔNG sử dụng lại trong tương lai.">This is a one-time code. Please do NOT reuse it in the future.</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Status -->
                    <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div class="flex items-start gap-3">
                            <div class="text-yellow-600 mt-1">⚠️</div>
                            <div class="flex-1">
                                <h5 class="font-semibold text-yellow-800 mb-1"><span data-en="Payment Confirmation" data-vi="Xác Nhận Thanh Toán">Payment Confirmation</span></h5>
                                <p class="text-sm text-yellow-700 mb-3">
                                    <span data-en="Please confirm you have completed the transaction. Our accountants will check and update the payment status in 5-10 days maximum." data-vi="Vui lòng xác nhận bạn đã hoàn thành giao dịch. Kế toán của chúng tôi sẽ kiểm tra và cập nhật trạng thái thanh toán trong tối đa 5-10 ngày.">Please confirm you have completed the transaction. Our accountants will check and update the payment status in 5-10 days maximum.</span>
                                </p>
                                <button id="checkPaymentBtn" onclick="confirmPaymentCompleted()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span data-en="I confirm that I have completed the transaction" data-vi="Tôi xác nhận đã hoàn thành giao dịch">I confirm that I have completed the transaction</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDdx6QyXzCWz7BRZInLu16LGnYBKvFO1CM",
            authDomain: "tnl-management-app.firebaseapp.com",
            projectId: "tnl-management-app",
            storageBucket: "tnl-management-app.firebasestorage.app",
            messagingSenderId: "710843379828",
            appId: "1:710843379828:web:76978490616ebe41bf2121",
            measurementId: "G-8W29VX7WTP"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let allStudents = [];
        let filteredStudents = [];
        let currentStudent = null;
        let currentTab = 'active';
        let isProfileMode = false;

        // Firebase data retrieval
        async function loadStudentsFromFirebase() {
            try {
                updateSyncStatus('loading', 'Loading students...');
                
                const studentsRef = db.collection('students');
                const snapshot = await studentsRef.get();
                
                allStudents = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    allStudents.push({
                        id: doc.id,
                        ...data
                    });
                });
                
                console.log('Loaded students from Firebase:', allStudents);
                
                // Update filtered students and render
                filteredStudents = [...allStudents];
                renderStudents();
                updateClassFilter();
                
                updateSyncStatus('connected', 'Connected');
                
            } catch (error) {
                console.error('Error loading students:', error);
                updateSyncStatus('error', 'Connection Error');
                
                // Show empty state
                allStudents = [];
                filteredStudents = [];
                renderStudents();
            }
        }

        // Load student progress data from Firebase collections
        async function loadStudentProgressData(studentId) {
            try {
                updateSyncStatus('loading', 'Loading progress data...');
                
                // Load all courses and check if student is enrolled in each one
                const coursesSnapshot = await db.collection('courses').get();
                const studentCourses = [];
                
                coursesSnapshot.forEach(doc => {
                    const courseData = doc.data();
                    const courseId = doc.id;
                    
                    // Check if this course has a students field with our studentId
                    if (courseData.students && Array.isArray(courseData.students)) {
                        const studentInCourse = courseData.students.find(student => 
                            student.studentId === studentId
                        );
                        
                        if (studentInCourse) {
                            studentCourses.push({
                                courseId: courseId,
                                courseName: courseData.name || courseData.courseName || courseId,
                                courseCode: courseData.code || courseId,
                                teacher: courseData.teacher || courseData.instructor || 'N/A',
                                description: courseData.description || '',
                                schedule: courseData.schedule || '',
                                duration: courseData.duration || '',
                                level: courseData.level || '',
                                status: courseData.status || 'unknown',
                                enrollmentDate: studentInCourse.enrollmentDate || courseData.startDate || null,
                                completionDate: studentInCourse.completionDate || courseData.endDate || null,
                                studentStatus: studentInCourse.status || courseData.status || 'unknown'
                            });
                        }
                    }
                });
                
                console.log('Found courses for student:', studentId, studentCourses);
                
                // Load attendance data
                const attendanceSnapshot = await db.collection('attendance')
                    .where('studentId', '==', studentId)
                    .get();
                
                // Load performance data using document ID pattern: per_courseCode_occasion_date_studentId
                const performanceSnapshot = await db.collection('performance').get();
                const performanceRecords = [];
                
                performanceSnapshot.forEach(doc => {
                    const docId = doc.id;
                    const data = doc.data();
                    
                    // Check if document ID matches the pattern and contains our studentId
                    if (docId.startsWith('per_') && docId.endsWith('_' + studentId)) {
                        // Parse document ID: per_courseCode_occasion_date_studentId
                        const parts = docId.split('_');
                        if (parts.length >= 5) {
                            const courseCode = parts[1];
                            const occasion = parts[2];
                            const date = parts[3];
                            
                            performanceRecords.push({
                                id: docId,
                                courseCode: courseCode,
                                occasion: occasion,
                                date: date,
                                studentId: studentId,
                                ...data,
                                parsedDate: parseFirebaseDate(data.date || date)
                            });
                        }
                    }
                });
                
                console.log('Found performance records for student:', studentId, performanceRecords);
                
                // Process attendance data
                const attendanceRecords = [];
                attendanceSnapshot.forEach(doc => {
                    const data = doc.data();
                    attendanceRecords.push({
                        ...data,
                        date: parseFirebaseDate(data.date)
                    });
                });
                
                // Organize courses by status (using course status, not student status)
                const coursesByStatus = {
                    inprogress: studentCourses.filter(course => 
                        course.status === 'in-progress' || 
                        course.status === 'active' || 
                        course.status === 'ongoing' ||
                        course.status === 'current'
                    ),
                    upcoming: studentCourses.filter(course => 
                        course.status === 'upcoming' || 
                        course.status === 'scheduled' || 
                        course.status === 'pending'
                    ),
                    finished: studentCourses.filter(course => 
                        course.status === 'finished' || 
                        course.status === 'completed' ||
                        course.status === 'done' ||
                        course.status === 'ended'
                    )
                };
                
                console.log('Organized courses by status:', coursesByStatus);
                
                // Calculate statistics
                const totalLessons = attendanceRecords.length;
                const firstLesson = attendanceRecords.length > 0 ? 
                    attendanceRecords.sort((a, b) => new Date(a.date) - new Date(b.date))[0].date : null;
                const recentLesson = attendanceRecords.length > 0 ? 
                    attendanceRecords.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date : null;
                
                updateSyncStatus('connected', 'Connected');
                
                return {
                    courses: coursesByStatus,
                    attendance: attendanceRecords,
                    performance: performanceRecords,
                    totalLessons: totalLessons,
                    totalAssessments: performanceRecords.length,
                    firstLesson: firstLesson ? formatDate(firstLesson) : 'Not available',
                    recentLesson: recentLesson ? formatDate(recentLesson) : 'Not available',
                    totalEnrollments: studentCourses.length
                };
                
            } catch (error) {
                console.error('Error loading progress data:', error);
                updateSyncStatus('error', 'Error loading progress');
                return null;
            }
        }

        // Helper function to parse Firebase dates
        function parseFirebaseDate(dateValue) {
            if (!dateValue) return null;
            
            // Handle Firestore Timestamp
            if (dateValue.toDate && typeof dateValue.toDate === 'function') {
                return dateValue.toDate();
            }
            
            // Handle string dates
            if (typeof dateValue === 'string') {
                return new Date(dateValue);
            }
            
            // Handle Date objects
            if (dateValue instanceof Date) {
                return dateValue;
            }
            
            return null;
        }

        // Helper function to format dates
        function formatDate(date) {
            if (!date) return 'N/A';
            return new Date(date).toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Update class filter options based on loaded data
        function updateClassFilter() {
            const classFilter = document.getElementById('classFilter');
            const uniqueClasses = [...new Set(allStudents.map(s => s.classAssignment).filter(Boolean))];
            
            // Clear existing options except "All Classes"
            classFilter.innerHTML = '<option value="">All Classes</option>';
            
            // Add unique classes from data
            uniqueClasses.sort().forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classFilter.appendChild(option);
            });
        }

        // DOM Elements
        const studentTableBody = document.getElementById('studentTableBody');
        const searchInput = document.getElementById('searchInput');
        const classFilter = document.getElementById('classFilter');
        const refreshBtn = document.getElementById('refreshBtn');
        const studentCount = document.getElementById('studentCount');
        const profileModal = document.getElementById('profileModal');
        const closeProfileModal = document.getElementById('closeProfileModal');
        const embedModal = document.getElementById('embedModal');
        const closeEmbedModal = document.getElementById('closeEmbedModal');
        const copyEmbedCode = document.getElementById('copyEmbedCode');
        const syncIcon = document.getElementById('syncIcon');
        const syncText = document.getElementById('syncText');

        // Create student table row HTML
        function createStudentRow(student) {
            const statusColor = {
                'Active': 'bg-green-100 text-green-800',
                'Inactive': 'bg-red-100 text-red-800',
                'Graduated': 'bg-blue-100 text-blue-800',
                'Dropped': 'bg-gray-100 text-gray-800'
            };

            // Safe data access with fallbacks
            const studentId = student.studentId || 'N/A';
            const fullName = student.fullName || 'N/A';
            const status = student.status || 'Unknown';
            const dateOfBirth = student.dateOfBirth || 'N/A';
            const school = student.school || 'N/A';
            const classAssignment = student.classAssignment || 'N/A';
            const yearEnrolled = student.yearEnrolled || 'N/A';
            const parentName = student.parentName || 'N/A';
            const studentPhone = student.studentPhone || 'N/A';

            return `
                <tr class="hover:bg-gray-50 cursor-pointer student-row" data-student-id="${studentId}">
                    <td class="px-3 py-4">
                        <input type="checkbox" class="student-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" value="${studentId}">
                    </td>
                    <td class="px-3 py-4 text-sm font-medium text-gray-900">${studentId}</td>
                    <td class="px-3 py-4 text-sm text-gray-900">${fullName}</td>
                    <td class="px-3 py-4">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusColor[status] || 'bg-gray-100 text-gray-800'}">
                            ${status}
                        </span>
                    </td>
                    <td class="px-3 py-4 text-sm text-gray-500 hidden sm:table-cell">${dateOfBirth}</td>
                    <td class="px-3 py-4 text-sm text-gray-500 hidden md:table-cell">${school}</td>
                    <td class="px-3 py-4 text-sm text-gray-500 hidden md:table-cell">${classAssignment}</td>
                    <td class="px-3 py-4 text-sm text-gray-500 hidden lg:table-cell">${yearEnrolled}</td>
                    <td class="px-3 py-4 text-sm text-gray-500 hidden lg:table-cell">${parentName}</td>
                    <td class="px-3 py-4 text-sm text-gray-500 hidden xl:table-cell">${studentPhone}</td>
                    <td class="px-3 py-4 text-sm font-medium">
                        <button onclick="showStudentProfile(allStudents.find(s => s.studentId === '${studentId}'))" class="text-blue-600 hover:text-blue-900 mr-3">View</button>
                        <button onclick="editStudent('${studentId}')" class="text-green-600 hover:text-green-900">Edit</button>
                    </td>
                </tr>
            `;
        }

        // Switch tabs
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab styles
            document.querySelectorAll('[id$="Tab"]').forEach(tabBtn => {
                tabBtn.className = "whitespace-nowrap py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm";
            });
            
            document.getElementById(tab + 'Tab').className = "whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600";
            
            filterStudents();
        }

        // Toggle select all
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const studentCheckboxes = document.querySelectorAll('.student-checkbox');
            
            studentCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        // Edit student (placeholder function)
        function editStudent(studentId) {
            alert(`Edit functionality for student ${studentId} would be implemented here.`);
        }

        // Render students table
        function renderStudents() {
            if (filteredStudents.length === 0) {
                studentTableBody.innerHTML = `
                    <tr>
                        <td colspan="11" class="px-3 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <svg class="w-12 h-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                </svg>
                                <p class="text-lg font-medium mb-2">No students found</p>
                                <p class="text-sm">Try adjusting your search or filter criteria</p>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                studentTableBody.innerHTML = filteredStudents.map(createStudentRow).join('');
            }
            
            studentCount.textContent = `Total: ${filteredStudents.length} students`;
            
            // Update tab counts
            const activeCounts = {
                active: allStudents.filter(s => s.status === 'Active').length,
                inactive: allStudents.filter(s => s.status === 'Inactive').length,
                dropped: allStudents.filter(s => s.status === 'Graduated' || s.status === 'Dropped').length
            };
            
            document.getElementById('activeTabCount').textContent = activeCounts.active;
            document.getElementById('inactiveTabCount').textContent = activeCounts.inactive;
            document.getElementById('droppedTabCount').textContent = activeCounts.dropped;
            
            // Add click event listeners to student rows
            document.querySelectorAll('.student-row').forEach(row => {
                row.addEventListener('click', (e) => {
                    // Don't trigger if clicking on checkbox or buttons
                    if (e.target.type === 'checkbox' || e.target.tagName === 'BUTTON') return;
                    
                    const studentId = row.dataset.studentId;
                    const student = allStudents.find(s => s.studentId === studentId);
                    if (student) {
                        showStudentProfile(student);
                    }
                });
            });
        }

        // Filter students
        function filterStudents() {
            const searchTerm = searchInput.value.toLowerCase();
            const classValue = classFilter.value;

            filteredStudents = allStudents.filter(student => {
                const matchesSearch = (student.fullName || '').toLowerCase().includes(searchTerm) ||
                                    (student.studentId || '').toLowerCase().includes(searchTerm) ||
                                    (student.studentPhone || '').toLowerCase().includes(searchTerm) ||
                                    (student.parentName || '').toLowerCase().includes(searchTerm);
                
                const matchesClass = !classValue || student.classAssignment === classValue;
                
                // Filter by tab
                let matchesTab = true;
                if (currentTab === 'active') {
                    matchesTab = student.status === 'Active';
                } else if (currentTab === 'inactive') {
                    matchesTab = student.status === 'Inactive';
                } else if (currentTab === 'dropped') {
                    matchesTab = student.status === 'Graduated' || student.status === 'Dropped';
                }

                return matchesSearch && matchesClass && matchesTab;
            });

            renderStudents();
        }

        // Language switching functionality
        let currentLanguage = 'en';
        
        function switchLanguage(lang) {
            currentLanguage = lang;
            
            // Update language button styles
            document.getElementById('langEn').className = lang === 'en' 
                ? 'px-3 py-1 text-xs font-medium rounded-lg bg-blue-100 text-blue-800'
                : 'px-3 py-1 text-xs font-medium rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200';
            
            document.getElementById('langVi').className = lang === 'vi' 
                ? 'px-3 py-1 text-xs font-medium rounded-lg bg-blue-100 text-blue-800'
                : 'px-3 py-1 text-xs font-medium rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200';
            
            // Update all translatable elements
            document.querySelectorAll('[data-en]').forEach(element => {
                const text = element.getAttribute(`data-${lang}`);
                if (text) {
                    element.textContent = text;
                }
            });
            
            // Update placeholders
            document.querySelectorAll('[data-en-placeholder]').forEach(element => {
                const placeholder = element.getAttribute(`data-${lang}-placeholder`);
                if (placeholder) {
                    element.placeholder = placeholder;
                }
            });
        }

        // Show student profile modal
        async function showStudentProfile(student) {
            if (!student) return;
            
            currentStudent = student;
            
            // Safe data access with fallbacks
            const fullName = student.fullName || 'N/A';
            const studentId = student.studentId || 'N/A';
            const classAssignment = student.classAssignment || 'N/A';
            const dateOfBirth = student.dateOfBirth || 'N/A';
            const school = student.school || 'N/A';
            const yearEnrolled = student.yearEnrolled || 'N/A';
            const status = student.status || 'Unknown';
            const studentPhone = student.studentPhone || 'N/A';
            const parentName = student.parentName || 'N/A';
            const parentPhone = student.parentPhone || 'N/A';
            
            // Update modal header
            document.getElementById('modalStudentName').textContent = fullName;
            document.getElementById('modalStudentId').textContent = `Student ID: ${studentId}`;
            document.getElementById('modalStudentClass').textContent = `Class: ${classAssignment}`;
            
            // Update Basic Information tab
            document.getElementById('basicStudentId').textContent = studentId;
            document.getElementById('basicFullName').textContent = fullName;
            document.getElementById('basicDateOfBirth').textContent = dateOfBirth;
            document.getElementById('basicSchool').textContent = school;
            document.getElementById('basicClassAssignment').textContent = classAssignment;
            document.getElementById('basicYearEnrolled').textContent = yearEnrolled;
            
            const basicStatusElement = document.getElementById('basicStatus');
            const statusColors = {
                'Active': 'bg-green-100 text-green-800',
                'Inactive': 'bg-red-100 text-red-800',
                'Graduated': 'bg-blue-100 text-blue-800',
                'Dropped': 'bg-gray-100 text-gray-800'
            };
            basicStatusElement.textContent = status;
            basicStatusElement.className = `inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusColors[status] || 'bg-gray-100 text-gray-800'}`;
            
            // Update Contact tab
            document.getElementById('contactStudentPhone').textContent = studentPhone;
            document.getElementById('contactParentName').textContent = parentName;
            document.getElementById('contactParentPhone').textContent = parentPhone;
            
            // Update Learning Progress tab
            document.getElementById('progressStudentName').textContent = fullName;
            document.getElementById('progressStudentId').textContent = studentId;
            
            const progressStatusElement = document.getElementById('progressStudentStatus');
            progressStatusElement.textContent = status;
            progressStatusElement.className = `inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusColors[status] || 'bg-gray-100 text-gray-800'}`;
            
            // Load real progress data
            const progressData = await loadStudentProgressData(studentId);
            
            if (progressData) {
                document.getElementById('progressFirstLesson').textContent = progressData.firstLesson;
                document.getElementById('progressRecentLesson').textContent = progressData.recentLesson;
                document.getElementById('progressTotalLessons').textContent = progressData.totalLessons;
                document.getElementById('progressOverallScore').textContent = progressData.totalAssessments;
                
                // Store progress data globally for tab switching
                window.currentProgressData = progressData;
                
                // Update course progress
                updateCourseProgress(progressData.courses);
                
                // Update attendance records
                updateAttendanceRecords(progressData.attendance);
            } else {
                // Clear progress data if not available
                document.getElementById('progressFirstLesson').textContent = 'Not available';
                document.getElementById('progressRecentLesson').textContent = 'Not available';
                document.getElementById('progressTotalLessons').textContent = '0';
                document.getElementById('progressOverallScore').textContent = '--';
                window.currentProgressData = null;
                updateCourseProgress(null);
                updateAttendanceRecords([]);
            }
            
            // Show modal and reset to basic tab
            switchProfileTab('basic');
            profileModal.classList.remove('hidden');
            profileModal.classList.add('flex');
            
            updateSyncStatus('success', 'Profile Loaded');
            setTimeout(() => updateSyncStatus('connected', 'Connected'), 2000);
        }

        // Export functions
        function exportToPDF() {
            if (!currentStudent) return;
            
            // Create a temporary container for the complete profile
            const exportContainer = createCompleteProfileForExport();
            document.body.appendChild(exportContainer);
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            html2canvas(exportContainer, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                width: exportContainer.scrollWidth,
                height: exportContainer.scrollHeight
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                
                // A4 dimensions in mm
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 10;
                const contentWidth = pageWidth - (margin * 2);
                const contentHeight = pageHeight - (margin * 2);
                
                // Calculate image dimensions to fit A4
                const imgWidth = contentWidth;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                let yPosition = margin;
                let remainingHeight = imgHeight;
                let sourceY = 0;
                
                // Add pages as needed
                while (remainingHeight > 0) {
                    const pageContentHeight = Math.min(remainingHeight, contentHeight);
                    const sourceHeight = (pageContentHeight * canvas.height) / imgHeight;
                    
                    // Create a temporary canvas for this page
                    const pageCanvas = document.createElement('canvas');
                    const pageCtx = pageCanvas.getContext('2d');
                    pageCanvas.width = canvas.width;
                    pageCanvas.height = sourceHeight;
                    
                    // Draw the portion of the image for this page
                    pageCtx.drawImage(canvas, 0, sourceY, canvas.width, sourceHeight, 0, 0, canvas.width, sourceHeight);
                    
                    const pageImgData = pageCanvas.toDataURL('image/png');
                    pdf.addImage(pageImgData, 'PNG', margin, yPosition, imgWidth, pageContentHeight);
                    
                    remainingHeight -= pageContentHeight;
                    sourceY += sourceHeight;
                    
                    if (remainingHeight > 0) {
                        pdf.addPage();
                        yPosition = margin;
                    }
                }
                
                // Clean up
                document.body.removeChild(exportContainer);
                
                pdf.save(`${currentStudent.fullName || 'Student'}-Complete-Profile.pdf`);
            }).catch(error => {
                console.error('Error generating PDF:', error);
                document.body.removeChild(exportContainer);
                alert('Error generating PDF. Please try again.');
            });
        }

        function exportToImage() {
            if (!currentStudent) return;
            
            // Create a temporary container for the complete profile
            const exportContainer = createCompleteProfileForExport();
            document.body.appendChild(exportContainer);
            
            html2canvas(exportContainer, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                width: exportContainer.scrollWidth,
                height: exportContainer.scrollHeight
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `${currentStudent.fullName || 'Student'}-Complete-Profile.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                // Clean up
                document.body.removeChild(exportContainer);
            }).catch(error => {
                console.error('Error generating image:', error);
                document.body.removeChild(exportContainer);
                alert('Error generating image. Please try again.');
            });
        }

        // Create complete profile layout for export
        function createCompleteProfileForExport() {
            if (!currentStudent) return null;
            
            const container = document.createElement('div');
            container.style.cssText = `
                position: absolute;
                top: -10000px;
                left: -10000px;
                width: 794px;
                background: white;
                font-family: system-ui, -apple-system, sans-serif;
                color: #1f2937;
                line-height: 1.5;
                padding: 40px;
                box-sizing: border-box;
            `;
            
            // Safe data access
            const fullName = currentStudent.fullName || 'N/A';
            const studentId = currentStudent.studentId || 'N/A';
            const classAssignment = currentStudent.classAssignment || 'N/A';
            const dateOfBirth = currentStudent.dateOfBirth || 'N/A';
            const school = currentStudent.school || 'N/A';
            const yearEnrolled = currentStudent.yearEnrolled || 'N/A';
            const status = currentStudent.status || 'Unknown';
            const studentPhone = currentStudent.studentPhone || 'N/A';
            const parentName = currentStudent.parentName || 'N/A';
            const parentPhone = currentStudent.parentPhone || 'N/A';
            
            container.innerHTML = `
                <!-- Header -->
                <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #3b82f6;">
                    <h1 style="font-size: 28px; font-weight: bold; color: #1e40af; margin: 0 0 10px 0;">📚 Student Profile Report</h1>
                    <p style="font-size: 14px; color: #6b7280; margin: 0;">Generated on ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>

                <!-- Student Header Info -->
                <div style="background: linear-gradient(135deg, #3b82f6, #1e40af); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div style="width: 80px; height: 80px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px;">👤</div>
                        <div style="flex: 1;">
                            <h2 style="font-size: 24px; font-weight: bold; margin: 0 0 8px 0;">${fullName}</h2>
                            <p style="font-size: 16px; margin: 0; opacity: 0.9;">Student ID: ${studentId}</p>
                            <p style="font-size: 16px; margin: 0; opacity: 0.9;">Class: ${classAssignment}</p>
                        </div>
                        <div style="text-align: right;">
                            <span style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;">${status}</span>
                        </div>
                    </div>
                </div>

                <!-- Basic Information Section -->
                <div style="margin-bottom: 25px;">
                    <h3 style="font-size: 20px; font-weight: bold; color: #1e40af; margin: 0 0 15px 0; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb;">📋 Basic Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <p style="font-size: 12px; color: #6b7280; margin: 0 0 5px 0; font-weight: 600;">STUDENT ID</p>
                            <p style="font-size: 16px; color: #1f2937; margin: 0; font-weight: 500;">${studentId}</p>
                        </div>
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <p style="font-size: 12px; color: #6b7280; margin: 0 0 5px 0; font-weight: 600;">FULL NAME</p>
                            <p style="font-size: 16px; color: #1f2937; margin: 0; font-weight: 500;">${fullName}</p>
                        </div>
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <p style="font-size: 12px; color: #6b7280; margin: 0 0 5px 0; font-weight: 600;">DATE OF BIRTH</p>
                            <p style="font-size: 16px; color: #1f2937; margin: 0; font-weight: 500;">${dateOfBirth}</p>
                        </div>
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <p style="font-size: 12px; color: #6b7280; margin: 0 0 5px 0; font-weight: 600;">STATUS</p>
                            <p style="font-size: 16px; color: #1f2937; margin: 0; font-weight: 500;">${status}</p>
                        </div>
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <p style="font-size: 12px; color: #6b7280; margin: 0 0 5px 0; font-weight: 600;">SCHOOL</p>
                            <p style="font-size: 16px; color: #1f2937; margin: 0; font-weight: 500;">${school}</p>
                        </div>
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <p style="font-size: 12px; color: #6b7280; margin: 0 0 5px 0; font-weight: 600;">CLASS ASSIGNMENT</p>
                            <p style="font-size: 16px; color: #1f2937; margin: 0; font-weight: 500;">${classAssignment}</p>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <p style="font-size: 12px; color: #6b7280; margin: 0 0 5px 0; font-weight: 600;">YEAR ENROLLED</p>
                            <p style="font-size: 16px; color: #1f2937; margin: 0; font-weight: 500;">${yearEnrolled}</p>
                        </div>
                    </div>
                </div>

                <!-- Contact Information Section -->
                <div style="margin-bottom: 25px;">
                    <h3 style="font-size: 20px; font-weight: bold; color: #059669; margin: 0 0 15px 0; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb;">📞 Contact Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #059669;">
                            <p style="font-size: 12px; color: #065f46; margin: 0 0 5px 0; font-weight: 600;">STUDENT PHONE</p>
                            <p style="font-size: 16px; color: #1f2937; margin: 0; font-weight: 500;">${studentPhone}</p>
                        </div>
                        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #059669;">
                            <p style="font-size: 12px; color: #065f46; margin: 0 0 5px 0; font-weight: 600;">PARENT NAME</p>
                            <p style="font-size: 16px; color: #1f2937; margin: 0; font-weight: 500;">${parentName}</p>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #059669;">
                            <p style="font-size: 12px; color: #065f46; margin: 0 0 5px 0; font-weight: 600;">PARENT PHONE</p>
                            <p style="font-size: 16px; color: #1f2937; margin: 0; font-weight: 500;">${parentPhone}</p>
                        </div>
                    </div>
                </div>

                <!-- Course Progress Section -->
                <div style="margin-bottom: 25px;">
                    <h3 style="font-size: 20px; font-weight: bold; color: #7c3aed; margin: 0 0 15px 0; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb;">📚 Course Progress</h3>
                    <div id="exportCourseProgress" style="background: #faf5ff; padding: 20px; border-radius: 8px; border-left: 4px solid #7c3aed;">
                        <p style="color: #6b7280; text-align: center; margin: 0;">Loading course information...</p>
                    </div>
                </div>

                <!-- Performance Summary Section -->
                <div style="margin-bottom: 25px;">
                    <h3 style="font-size: 20px; font-weight: bold; color: #dc2626; margin: 0 0 15px 0; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb;">📊 Performance Summary</h3>
                    <div id="exportPerformanceSummary" style="background: #fef2f2; padding: 20px; border-radius: 8px; border-left: 4px solid #dc2626;">
                        <p style="color: #6b7280; text-align: center; margin: 0;">Loading performance data...</p>
                    </div>
                </div>

                <!-- Footer -->
                <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: center;">
                    <p style="font-size: 12px; color: #6b7280; margin: 0;">This report was generated automatically from the Student Management System</p>
                    <p style="font-size: 12px; color: #6b7280; margin: 5px 0 0 0;">Report Date: ${new Date().toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}</p>
                </div>
            `;
            
            // Load and populate course progress data
            if (window.currentProgressData) {
                populateExportCourseProgress(container, window.currentProgressData);
            } else {
                // Load progress data if not already available
                loadStudentProgressData(studentId).then(progressData => {
                    if (progressData) {
                        populateExportCourseProgress(container, progressData);
                    }
                });
            }
            
            return container;
        }

        // Populate course progress in export
        function populateExportCourseProgress(container, progressData) {
            const courseProgressDiv = container.querySelector('#exportCourseProgress');
            const performanceSummaryDiv = container.querySelector('#exportPerformanceSummary');
            
            if (!progressData) {
                courseProgressDiv.innerHTML = '<p style="color: #6b7280; text-align: center; margin: 0;">No course data available</p>';
                performanceSummaryDiv.innerHTML = '<p style="color: #6b7280; text-align: center; margin: 0;">No performance data available</p>';
                return;
            }
            
            // Course Progress Content
            let courseContent = `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 8px;">
                        <p style="font-size: 12px; color: #6b7280; margin: 0; font-weight: 600;">FIRST LESSON</p>
                        <p style="font-size: 16px; color: #1f2937; margin: 5px 0 0 0; font-weight: 500;">${progressData.firstLesson}</p>
                    </div>
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 8px;">
                        <p style="font-size: 12px; color: #6b7280; margin: 0; font-weight: 600;">RECENT LESSON</p>
                        <p style="font-size: 16px; color: #1f2937; margin: 5px 0 0 0; font-weight: 500;">${progressData.recentLesson}</p>
                    </div>
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 8px;">
                        <p style="font-size: 12px; color: #6b7280; margin: 0; font-weight: 600;">TOTAL LESSONS</p>
                        <p style="font-size: 24px; color: #1f2937; margin: 5px 0 0 0; font-weight: bold;">${progressData.totalLessons}</p>
                    </div>
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 8px;">
                        <p style="font-size: 12px; color: #6b7280; margin: 0; font-weight: 600;">ASSESSMENTS</p>
                        <p style="font-size: 24px; color: #1f2937; margin: 5px 0 0 0; font-weight: bold;">${progressData.totalAssessments}</p>
                    </div>
                </div>
            `;
            
            // Add course sections
            const sections = [
                { title: '🔄 In Progress Courses', courses: progressData.courses.inprogress, color: '#3b82f6' },
                { title: '⏳ Upcoming Courses', courses: progressData.courses.upcoming, color: '#f59e0b' },
                { title: '✅ Finished Courses', courses: progressData.courses.finished, color: '#10b981' }
            ];
            
            sections.forEach(section => {
                courseContent += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="font-size: 16px; font-weight: bold; color: ${section.color}; margin: 0 0 10px 0;">${section.title} (${section.courses?.length || 0})</h4>
                `;
                
                if (section.courses && section.courses.length > 0) {
                    section.courses.forEach(course => {
                        courseContent += `
                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div>
                                        <h5 style="font-size: 16px; font-weight: bold; color: #1f2937; margin: 0 0 5px 0;">${course.courseName}</h5>
                                        <p style="font-size: 12px; color: #6b7280; margin: 0;">📚 ${course.courseCode} ${course.level ? '• 📊 ' + course.level : ''}</p>
                                    </div>
                                    <span style="background: ${section.color}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">${course.status}</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px; color: #4b5563;">
                                    <p style="margin: 0;"><strong>👨‍🏫 Teacher:</strong> ${course.teacher}</p>
                                    <p style="margin: 0;"><strong>📅 Enrolled:</strong> ${formatDate(course.enrollmentDate)}</p>
                                    ${course.schedule ? `<p style="margin: 0;"><strong>🕒 Schedule:</strong> ${course.schedule}</p>` : ''}
                                    ${course.duration ? `<p style="margin: 0;"><strong>⏱️ Duration:</strong> ${course.duration}</p>` : ''}
                                    ${course.completionDate ? `<p style="margin: 0;"><strong>✅ Completed:</strong> ${formatDate(course.completionDate)}</p>` : ''}
                                </div>
                                ${course.description ? `<div style="margin-top: 10px; padding: 10px; background: #f9fafb; border-radius: 6px; font-size: 12px; color: #4b5563;"><strong>Description:</strong> ${course.description}</div>` : ''}
                            </div>
                        `;
                    });
                } else {
                    courseContent += `<p style="color: #6b7280; font-style: italic; margin: 0 0 10px 0;">No courses in this category</p>`;
                }
                
                courseContent += '</div>';
            });
            
            courseProgressDiv.innerHTML = courseContent;
            
            // Performance Summary Content
            let performanceContent = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div style="text-align: center; background: white; padding: 20px; border-radius: 8px;">
                        <p style="font-size: 14px; color: #6b7280; margin: 0; font-weight: 600;">TOTAL ENROLLMENTS</p>
                        <p style="font-size: 32px; color: #dc2626; margin: 10px 0 0 0; font-weight: bold;">${progressData.totalEnrollments || 0}</p>
                    </div>
                    <div style="text-align: center; background: white; padding: 20px; border-radius: 8px;">
                        <p style="font-size: 14px; color: #6b7280; margin: 0; font-weight: 600;">ATTENDANCE RATE</p>
                        <p style="font-size: 32px; color: #dc2626; margin: 10px 0 0 0; font-weight: bold;">${calculateAttendanceRate(progressData.attendance)}%</p>
                    </div>
                    <div style="text-align: center; background: white; padding: 20px; border-radius: 8px;">
                        <p style="font-size: 14px; color: #6b7280; margin: 0; font-weight: 600;">ACTIVE COURSES</p>
                        <p style="font-size: 32px; color: #dc2626; margin: 10px 0 0 0; font-weight: bold;">${progressData.courses.inprogress?.length || 0}</p>
                    </div>
                </div>
            `;
            
            performanceSummaryDiv.innerHTML = performanceContent;
        }

        // Calculate attendance rate
        function calculateAttendanceRate(attendanceData) {
            if (!attendanceData || attendanceData.length === 0) return 0;
            const presentCount = attendanceData.filter(record => record.status === 'present').length;
            return Math.round((presentCount / attendanceData.length) * 100);
        }

        // Sync status updates
        function updateSyncStatus(status, text) {
            const colors = {
                connected: 'bg-green-500',
                loading: 'bg-yellow-500',
                error: 'bg-red-500',
                success: 'bg-blue-500'
            };
            
            syncIcon.className = `w-2 h-2 rounded-full mr-2 ${colors[status]}`;
            syncText.textContent = text;
        }

        // Profile tab switching
        function switchProfileTab(tab) {
            // Hide all tab contents
            document.getElementById('basicProfileContent').classList.add('hidden');
            document.getElementById('attendanceProfileContent').classList.add('hidden');
            document.getElementById('studyprogressProfileContent').classList.add('hidden');
            document.getElementById('accountsProfileContent').classList.add('hidden');
            document.getElementById('tuitionProfileContent').classList.add('hidden');
            
            // Reset all tab buttons
            document.querySelectorAll('[id$="ProfileTab"]').forEach(tabBtn => {
                tabBtn.className = "py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm whitespace-nowrap";
            });
            
            // Show selected tab content and activate button
            document.getElementById(tab + 'ProfileContent').classList.remove('hidden');
            document.getElementById(tab + 'ProfileTab').className = "py-2 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600 whitespace-nowrap";
            
            // Load data for specific tabs when they're opened
            if (tab === 'studyprogress' && window.currentProgressData) {
                updateCourseProgress(window.currentProgressData.courses);
                updateAssessmentResults(window.currentProgressData.performance);
            } else if (tab === 'attendance' && window.currentProgressData) {
                updateAttendanceRecords(window.currentProgressData.attendance);
            } else if (tab === 'tuition' && currentStudent) {
                loadTuitionData(currentStudent.studentId);
            }
        }

        // Learning progress tab switching
        function switchLearningTab(tab) {
            // Hide all learning tab contents
            document.getElementById('coursesLearningContent').classList.add('hidden');
            document.getElementById('attendanceLearningContent').classList.add('hidden');
            document.getElementById('performanceLearningContent').classList.add('hidden');
            document.getElementById('accountsLearningContent').classList.add('hidden');
            document.getElementById('tuitionLearningContent').classList.add('hidden');
            
            // Reset all learning tab buttons
            document.querySelectorAll('[id$="LearningTab"]').forEach(tabBtn => {
                tabBtn.className = "py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm whitespace-nowrap";
            });
            
            // Show selected tab content and activate button
            document.getElementById(tab + 'LearningContent').classList.remove('hidden');
            document.getElementById(tab + 'LearningTab').className = "py-2 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600 whitespace-nowrap";
        }

        // Update course progress data
        function updateCourseProgress(courses) {
            if (!courses) {
                // Clear all course lists if no data
                document.getElementById('inprogressCount').textContent = '0';
                document.getElementById('upcomingCount').textContent = '0';
                document.getElementById('finishedCount').textContent = '0';
                document.getElementById('inprogressCoursesList').innerHTML = '<p class="text-gray-500 text-center py-4">No courses in progress</p>';
                document.getElementById('upcomingCoursesList').innerHTML = '<p class="text-gray-500 text-center py-4">No upcoming courses</p>';
                document.getElementById('finishedCoursesList').innerHTML = '<p class="text-gray-500 text-center py-4">No completed courses</p>';
                return;
            }
            
            // Update counts
            document.getElementById('inprogressCount').textContent = courses.inprogress?.length || 0;
            document.getElementById('upcomingCount').textContent = courses.upcoming?.length || 0;
            document.getElementById('finishedCount').textContent = courses.finished?.length || 0;
            
            // Update in-progress courses
            const inprogressList = document.getElementById('inprogressCoursesList');
            inprogressList.innerHTML = courses.inprogress?.map(course => `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h5 class="font-semibold text-gray-900 text-lg">${course.courseName}</h5>
                            <div class="flex flex-wrap gap-2 mt-1">
                                <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">
                                    📚 ${course.courseCode}
                                </span>
                                ${course.level ? `<span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-700">📊 ${course.level}</span>` : ''}
                            </div>
                        </div>
                        <span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full bg-blue-500 text-white">${course.status}</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-600">
                        <div>
                            <p class="flex items-center"><span class="mr-2">👨‍🏫</span><span data-en="Teacher" data-vi="Giáo Viên">Teacher</span>: <strong class="ml-1">${course.teacher}</strong></p>
                            <p class="flex items-center mt-1"><span class="mr-2">📅</span><span data-en="Enrolled" data-vi="Đăng Ký">Enrolled</span>: <strong class="ml-1">${formatDate(course.enrollmentDate)}</strong></p>
                        </div>
                        <div>
                            ${course.schedule ? `<p class="flex items-center"><span class="mr-2">🕒</span><span data-en="Schedule" data-vi="Lịch Học">Schedule</span>: <strong class="ml-1">${course.schedule}</strong></p>` : ''}
                            ${course.duration ? `<p class="flex items-center mt-1"><span class="mr-2">⏱️</span><span data-en="Duration" data-vi="Thời Lượng">Duration</span>: <strong class="ml-1">${course.duration}</strong></p>` : ''}
                        </div>
                    </div>
                    ${course.description ? `<div class="mt-3 p-2 bg-blue-100 rounded text-xs text-gray-700"><strong>Description:</strong> ${course.description}</div>` : ''}
                </div>
            `).join('') || `<p class="text-gray-500 text-center py-4"><span data-en="No courses in progress" data-vi="Không có khóa học đang diễn ra">No courses in progress</span></p>`;
            
            // Update upcoming courses
            const upcomingList = document.getElementById('upcomingCoursesList');
            upcomingList.innerHTML = courses.upcoming?.map(course => `
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h5 class="font-semibold text-gray-900 text-lg">${course.courseName}</h5>
                            <div class="flex flex-wrap gap-2 mt-1">
                                <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">
                                    📚 ${course.courseCode}
                                </span>
                                ${course.level ? `<span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-700">📊 ${course.level}</span>` : ''}
                            </div>
                        </div>
                        <span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full bg-yellow-500 text-white">${course.status}</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-600">
                        <div>
                            <p class="flex items-center"><span class="mr-2">👨‍🏫</span><span data-en="Teacher" data-vi="Giáo Viên">Teacher</span>: <strong class="ml-1">${course.teacher}</strong></p>
                            <p class="flex items-center mt-1"><span class="mr-2">📅</span><span data-en="Enrolled" data-vi="Đăng Ký">Enrolled</span>: <strong class="ml-1">${formatDate(course.enrollmentDate)}</strong></p>
                        </div>
                        <div>
                            ${course.schedule ? `<p class="flex items-center"><span class="mr-2">🕒</span><span data-en="Schedule" data-vi="Lịch Học">Schedule</span>: <strong class="ml-1">${course.schedule}</strong></p>` : ''}
                            ${course.duration ? `<p class="flex items-center mt-1"><span class="mr-2">⏱️</span><span data-en="Duration" data-vi="Thời Lượng">Duration</span>: <strong class="ml-1">${course.duration}</strong></p>` : ''}
                        </div>
                    </div>
                    ${course.description ? `<div class="mt-3 p-2 bg-yellow-100 rounded text-xs text-gray-700"><strong>Description:</strong> ${course.description}</div>` : ''}
                </div>
            `).join('') || `<p class="text-gray-500 text-center py-4"><span data-en="No upcoming courses" data-vi="Không có khóa học sắp tới">No upcoming courses</span></p>`;
            
            // Update finished courses
            const finishedList = document.getElementById('finishedCoursesList');
            finishedList.innerHTML = courses.finished?.map(course => `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h5 class="font-semibold text-gray-900 text-lg">${course.courseName}</h5>
                            <div class="flex flex-wrap gap-2 mt-1">
                                <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
                                    📚 ${course.courseCode}
                                </span>
                                ${course.level ? `<span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-700">📊 ${course.level}</span>` : ''}
                            </div>
                        </div>
                        <span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full bg-green-500 text-white">${course.status}</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-600">
                        <div>
                            <p class="flex items-center"><span class="mr-2">👨‍🏫</span><span data-en="Teacher" data-vi="Giáo Viên">Teacher</span>: <strong class="ml-1">${course.teacher}</strong></p>
                            <p class="flex items-center mt-1"><span class="mr-2">📅</span><span data-en="Enrolled" data-vi="Đăng Ký">Enrolled</span>: <strong class="ml-1">${formatDate(course.enrollmentDate)}</strong></p>
                        </div>
                        <div>
                            <p class="flex items-center"><span class="mr-2">✅</span><span data-en="Completed" data-vi="Hoàn Thành">Completed</span>: <strong class="ml-1">${formatDate(course.completionDate)}</strong></p>
                            ${course.duration ? `<p class="flex items-center mt-1"><span class="mr-2">⏱️</span><span data-en="Duration" data-vi="Thời Lượng">Duration</span>: <strong class="ml-1">${course.duration}</strong></p>` : ''}
                        </div>
                    </div>
                    ${course.description ? `<div class="mt-3 p-2 bg-green-100 rounded text-xs text-gray-700"><strong>Description:</strong> ${course.description}</div>` : ''}
                </div>
            `).join('') || `<p class="text-gray-500 text-center py-4"><span data-en="No completed courses" data-vi="Không có khóa học đã hoàn thành">No completed courses</span></p>`;
        }

        // Update assessment results display
        function updateAssessmentResults(performanceData) {
            const assessmentContainer = document.getElementById('assessmentResultsList');
            const assessmentCount = document.getElementById('assessmentCount');
            
            if (!performanceData || performanceData.length === 0) {
                assessmentContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No assessment results found</p>';
                assessmentCount.textContent = '0';
                return;
            }
            
            assessmentCount.textContent = performanceData.length;
            
            // Sort assessments by date (most recent first)
            const sortedAssessments = performanceData.sort((a, b) => {
                const dateA = new Date(a.parsedDate || a.date);
                const dateB = new Date(b.parsedDate || b.date);
                return dateB - dateA;
            });
            
            assessmentContainer.innerHTML = sortedAssessments.map(assessment => {
                // Calculate overall score if multiple criteria exist
                let overallScore = 'N/A';
                let scoreColor = 'text-gray-600';
                
                if (assessment.score !== undefined) {
                    overallScore = assessment.score;
                } else if (assessment.totalScore !== undefined) {
                    overallScore = assessment.totalScore;
                } else {
                    // Try to calculate from individual scores
                    const scores = [];
                    Object.keys(assessment).forEach(key => {
                        if (key.includes('score') || key.includes('Score')) {
                            const value = parseFloat(assessment[key]);
                            if (!isNaN(value)) scores.push(value);
                        }
                    });
                    if (scores.length > 0) {
                        overallScore = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
                    }
                }
                
                // Determine score color
                if (overallScore !== 'N/A') {
                    const numScore = parseFloat(overallScore);
                    if (numScore >= 8) scoreColor = 'text-green-600';
                    else if (numScore >= 6) scoreColor = 'text-yellow-600';
                    else scoreColor = 'text-red-600';
                }
                
                // Find course name from progress data
                const courseName = window.currentProgressData ? 
                    [...(window.currentProgressData.courses.inprogress || []),
                     ...(window.currentProgressData.courses.upcoming || []),
                     ...(window.currentProgressData.courses.finished || [])]
                    .find(course => course.courseCode === assessment.courseCode)?.courseName || assessment.courseCode
                    : assessment.courseCode;
                
                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <h5 class="font-semibold text-gray-900 text-lg">${courseName}</h5>
                                <div class="flex flex-wrap gap-2 mt-1">
                                    <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">
                                        📚 ${assessment.courseCode}
                                    </span>
                                    <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-800">
                                        📝 ${assessment.occasion || 'Assessment'}
                                    </span>
                                    <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-700">
                                        📅 ${formatDate(assessment.parsedDate || assessment.date)}
                                    </span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold ${scoreColor}">${overallScore}</div>
                                <div class="text-xs text-gray-500">Overall Score</div>
                            </div>
                        </div>
                        
                        ${assessment.criteria ? `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                ${Object.entries(assessment.criteria).map(([criterion, score]) => `
                                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                        <span class="text-gray-700">${criterion}</span>
                                        <span class="font-medium ${parseFloat(score) >= 8 ? 'text-green-600' : parseFloat(score) >= 6 ? 'text-yellow-600' : 'text-red-600'}">${score}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${assessment.notes || assessment.comments ? `
                            <div class="mt-3 p-3 bg-blue-50 rounded-lg">
                                <p class="text-sm text-gray-700"><strong>Notes:</strong> ${assessment.notes || assessment.comments}</p>
                            </div>
                        ` : ''}
                        
                        ${assessment.teacher || assessment.assessor ? `
                            <div class="mt-2 text-xs text-gray-500">
                                <span>👨‍🏫 Assessed by: ${assessment.teacher || assessment.assessor}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Update attendance records with real data
        function updateAttendanceRecords(attendanceData) {
            const attendanceContainer = document.getElementById('attendanceRecords');
            
            if (!attendanceData || attendanceData.length === 0) {
                attendanceContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No attendance records found</p>';
                return;
            }
            
            // Group attendance by month
            const attendanceByMonth = {};
            attendanceData.forEach(record => {
                const date = new Date(record.date);
                const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                const monthName = date.toLocaleString('en-US', { month: 'long', year: 'numeric' });
                
                if (!attendanceByMonth[monthKey]) {
                    attendanceByMonth[monthKey] = {
                        name: monthName,
                        records: [],
                        year: date.getFullYear(),
                        month: date.getMonth()
                    };
                }
                
                attendanceByMonth[monthKey].records.push({
                    day: date.getDate(),
                    date: date,
                    present: record.status === 'present',
                    courseCode: record.courseCode,
                    notes: record.notes
                });
            });
            
            // Sort months by date (most recent first)
            const sortedMonths = Object.values(attendanceByMonth)
                .sort((a, b) => {
                    if (a.year !== b.year) return b.year - a.year;
                    return b.month - a.month;
                })
                .slice(0, 6); // Show last 6 months
            
            attendanceContainer.innerHTML = sortedMonths.map(month => {
                // Sort records by date (ascending - left to right)
                const sortedRecords = month.records.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                const presentCount = sortedRecords.filter(r => r.present).length;
                const absentCount = sortedRecords.filter(r => !r.present).length;
                const attendanceRate = Math.round((presentCount / sortedRecords.length) * 100);
                
                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-900 mb-3">${month.name}</h5>
                        <div class="grid grid-cols-7 gap-2 mb-3">
                            ${sortedRecords.map(record => `
                                <div class="flex flex-col items-center">
                                    <div class="text-xs text-gray-500 mb-1">${record.day}</div>
                                    <div class="flex items-center justify-center w-8 h-8 rounded-full text-xs font-medium ${
                                        record.present 
                                            ? 'bg-green-100 text-green-800' 
                                            : 'bg-red-100 text-red-800'
                                    }" title="${formatDate(record.date)} - ${record.courseCode}${record.notes ? ' - ' + record.notes : ''}">
                                        ${record.present ? '✓' : '✗'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span><span data-en="Present" data-vi="Có Mặt">Present</span>: ${presentCount} <span data-en="days" data-vi="ngày">days</span></span>
                            <span><span data-en="Absent" data-vi="Vắng Mặt">Absent</span>: ${absentCount} <span data-en="days" data-vi="ngày">days</span></span>
                            <span><span data-en="Rate" data-vi="Tỷ Lệ">Rate</span>: ${attendanceRate}%</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Event Listeners
        searchInput.addEventListener('input', filterStudents);
        classFilter.addEventListener('change', filterStudents);
        refreshBtn.addEventListener('click', () => {
            loadStudentsFromFirebase();
        });

        closeProfileModal.addEventListener('click', () => {
            profileModal.classList.add('hidden');
            profileModal.classList.remove('flex');
        });

        document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);
        document.getElementById('exportImageBtn').addEventListener('click', exportToImage);

        document.getElementById('embedCodeBtn').addEventListener('click', () => {
            if (!currentStudent) return;
            
            // Create unique profile URL
            const baseUrl = window.location.origin + window.location.pathname;
            const profileUrl = `${baseUrl}?profile=${currentStudent.studentId}`;
            
            const embedCode = `<iframe src="${profileUrl}" width="100%" height="800" frameborder="0" style="min-height: 600px; max-width: 100%; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);"></iframe>`;
            document.getElementById('embedCode').value = embedCode;
            
            // Also show the direct link
            document.getElementById('directProfileLink').value = profileUrl;
            
            embedModal.classList.remove('hidden');
            embedModal.classList.add('flex');
        });

        closeEmbedModal.addEventListener('click', () => {
            embedModal.classList.add('hidden');
            embedModal.classList.remove('flex');
        });

        copyEmbedCode.addEventListener('click', () => {
            document.getElementById('embedCode').select();
            document.execCommand('copy');
            copyEmbedCode.textContent = 'Copied!';
            setTimeout(() => {
                copyEmbedCode.textContent = 'Copy to Clipboard';
            }, 2000);
        });

        // Close modals when clicking outside
        profileModal.addEventListener('click', (e) => {
            if (e.target === profileModal) {
                profileModal.classList.add('hidden');
                profileModal.classList.remove('flex');
            }
        });

        embedModal.addEventListener('click', (e) => {
            if (e.target === embedModal) {
                embedModal.classList.add('hidden');
                embedModal.classList.remove('flex');
            }
        });

        // Initialize
        updateSyncStatus('loading', 'Initializing...');
        
        // Check for profile mode
        const urlParams = new URLSearchParams(window.location.search);
        const profileParam = urlParams.get('profile');
        const studentParam = urlParams.get('student'); // Legacy support
        
        if (profileParam || studentParam) {
            isProfileMode = true;
            const targetStudentId = profileParam || studentParam;
            
            // Hide main interface and show loading
            document.querySelector('.max-w-7xl').style.display = 'none';
            document.body.innerHTML = `
                <div class="min-h-screen bg-gray-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <h2 class="text-xl font-semibold text-gray-900 mb-2">Loading Student Profile</h2>
                        <p class="text-gray-600">Please wait while we fetch the student information...</p>
                    </div>
                </div>
            `;
            
            // Load student data and show profile
            loadStudentForProfile(targetStudentId);
        } else {
            // Normal directory mode
            loadStudentsFromFirebase();
        }

        // Toggle tuition sections
        function toggleTuitionSection(section) {
            const content = document.getElementById(section + 'TuitionContent');
            const chevron = document.getElementById(section + 'Chevron');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.classList.remove('rotate-180');
            } else {
                content.classList.add('hidden');
                chevron.classList.add('rotate-180');
            }
        }

        // Load tuition data from Firebase
        async function loadTuitionData(studentId) {
            try {
                updateSyncStatus('loading', 'Loading tuition data...');
                
                const tuitionData = [];
                
                // Load regular tuition records
                const tuitionSnapshot = await db.collection('tuition')
                    .where('studentId', '==', studentId)
                    .get();
                
                tuitionSnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Determine payment status based on paid and processed fields
                    let status = 'unpaid';
                    if (data.paid === true || data.paid === 'true') {
                        if (data.processed === true || data.processed === 'true') {
                            status = 'paid';
                        } else {
                            status = 'processing';
                        }
                    }
                    
                    tuitionData.push({
                        id: doc.id,
                        type: 'tuition',
                        month: data.month,
                        year: data.year,
                        amount: data.finalFee || 0,
                        status: status,
                        paidDate: (status === 'paid' || status === 'processing') && data.paymentDate ? parseFirebaseDate(data.paymentDate) : null,
                        dueDate: data.dueDate ? parseFirebaseDate(data.dueDate) : null,
                        description: data.description || `${data.month} ${data.year} Tuition`,
                        studentId: data.studentId
                    });
                });
                
                // Load extra fees
                const extraFeesSnapshot = await db.collection('extraFees')
                    .where('studentId', '==', studentId)
                    .get();
                
                extraFeesSnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Determine payment status based on paid and processed fields
                    let status = 'unpaid';
                    if (data.paid === true || data.paid === 'true') {
                        if (data.processed === true || data.processed === 'true') {
                            status = 'paid';
                        } else {
                            status = 'processing';
                        }
                    }
                    
                    tuitionData.push({
                        id: doc.id,
                        type: 'extraFee',
                        month: data.month || 'N/A',
                        year: data.year || new Date().getFullYear(),
                        amount: data.amount || 0,
                        status: status,
                        paidDate: (status === 'paid' || status === 'processing') && data.paymentDate ? parseFirebaseDate(data.paymentDate) : null,
                        dueDate: data.dueDate ? parseFirebaseDate(data.dueDate) : null,
                        description: data.description || data.feeTypeName || 'Extra Fee',
                        studentId: data.studentId,
                        feeType: data.feeTypeName || data.feeType
                    });
                });
                
                console.log('Loaded tuition data for student:', studentId, tuitionData);
                
                updateTuitionDisplay(tuitionData);
                updateSyncStatus('connected', 'Connected');
                
            } catch (error) {
                console.error('Error loading tuition data:', error);
                updateSyncStatus('error', 'Error loading tuition');
                updateTuitionDisplay([]);
            }
        }

        // Helper function to convert month name to number
        function getMonthNumber(monthName) {
            const months = {
                'January': '1', 'February': '2', 'March': '3', 'April': '4',
                'May': '5', 'June': '6', 'July': '7', 'August': '8',
                'September': '9', 'October': '10', 'November': '11', 'December': '12'
            };
            return months[monthName] || monthName;
        }

        // Update tuition display
        function updateTuitionDisplay(tuitionData) {
            const unpaidList = document.getElementById('unpaidTuitionList');
            const processingList = document.getElementById('processingTuitionList');
            const paidList = document.getElementById('paidTuitionList');
            
            const unpaidTuition = tuitionData.filter(item => item.status === 'unpaid');
            const processingTuition = tuitionData.filter(item => item.status === 'processing');
            const paidTuition = tuitionData.filter(item => item.status === 'paid');
            
            // Update counts
            document.getElementById('unpaidCount').textContent = `(${unpaidTuition.length})`;
            document.getElementById('processingCount').textContent = `(${processingTuition.length})`;
            document.getElementById('paidCount').textContent = `(${paidTuition.length})`;
            
            // Format currency
            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('vi-VN').format(amount) + ' VND';
            };
            
            // Sort tuition data by year and month (most recent first)
            const sortTuitionData = (data) => {
                return data.sort((a, b) => {
                    if (a.year !== b.year) return b.year - a.year;
                    // For months, convert to numbers for proper sorting
                    const monthOrder = ['January', 'February', 'March', 'April', 'May', 'June', 
                                       'July', 'August', 'September', 'October', 'November', 'December'];
                    const aMonthIndex = monthOrder.indexOf(a.month);
                    const bMonthIndex = monthOrder.indexOf(b.month);
                    return bMonthIndex - aMonthIndex;
                });
            };
            
            // Update unpaid tuition list
            unpaidList.innerHTML = sortTuitionData([...unpaidTuition]).map(item => {
                // Format month/year as MM/YYYY
                const monthYear = item.month !== 'N/A' ? 
                    `${getMonthNumber(item.month)}/${item.year}` : 
                    `${item.year}`;
                
                return `
                    <div class="bg-white border border-red-200 rounded-lg p-3">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">${item.type === 'extraFee' ? (item.feeType || 'Extra Fee') : 'Monthly Tuition'}</div>
                                <div class="text-sm text-gray-600">${monthYear}</div>
                                ${item.dueDate ? `<div class="text-xs text-gray-500 mt-1">Due: ${formatDate(item.dueDate)}</div>` : ''}
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-red-600">${formatCurrency(item.amount)}</div>
                                <div class="text-xs text-red-500">Unpaid</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('') || '<p class="text-gray-500 text-center py-4">No unpaid tuition</p>';
            
            // Update processing tuition list
            processingList.innerHTML = sortTuitionData([...processingTuition]).map(item => {
                // Format month/year as MM/YYYY
                const monthYear = item.month !== 'N/A' ? 
                    `${getMonthNumber(item.month)}/${item.year}` : 
                    `${item.year}`;
                
                return `
                    <div class="bg-white border border-yellow-200 rounded-lg p-3">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">${item.type === 'extraFee' ? (item.feeType || 'Extra Fee') : 'Monthly Tuition'}</div>
                                <div class="text-sm text-gray-600">${monthYear}</div>
                                ${item.dueDate ? `<div class="text-xs text-gray-500 mt-1">Due: ${formatDate(item.dueDate)}</div>` : ''}
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-yellow-600">${formatCurrency(item.amount)}</div>
                                <div class="text-xs text-yellow-600">Paid - Processing</div>
                                ${item.paidDate ? `<div class="text-xs text-gray-500 mt-1">Confirmed: ${formatDate(item.paidDate)}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('') || '<p class="text-gray-500 text-center py-4">No processing tuition</p>';
            
            // Update paid tuition list
            paidList.innerHTML = sortTuitionData([...paidTuition]).map(item => {
                // Format month/year as MM/YYYY
                const monthYear = item.month !== 'N/A' ? 
                    `${getMonthNumber(item.month)}/${item.year}` : 
                    `${item.year}`;
                
                return `
                    <div class="bg-white border border-green-200 rounded-lg p-3">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">${item.type === 'extraFee' ? (item.feeType || 'Extra Fee') : 'Monthly Tuition'}</div>
                                <div class="text-sm text-gray-600">${monthYear}</div>
                                ${item.dueDate ? `<div class="text-xs text-gray-500 mt-1">Due: ${formatDate(item.dueDate)}</div>` : ''}
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-green-600">${formatCurrency(item.amount)}</div>
                                <div class="text-xs text-green-500">${item.paidDate ? `Paid on ${formatDate(item.paidDate)}` : 'Paid'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('') || '<p class="text-gray-500 text-center py-4">No paid tuition</p>';
            
            // Update summary
            const totalOutstanding = unpaidTuition.reduce((sum, item) => sum + item.amount, 0);
            
            document.getElementById('totalOutstandingAmount').textContent = formatCurrency(totalOutstanding);
        }

        // Payment Instructions Functions
        function showPaymentInstructions() {
            if (!currentStudent) return;
            
            const paymentModal = document.getElementById('paymentModal');
            
            // Get outstanding amount from the tuition summary
            const outstandingText = document.getElementById('totalOutstandingAmount').textContent;
            const outstandingAmount = outstandingText.replace(/[^\d]/g, ''); // Extract numbers only
            
            // Update payment amount
            document.getElementById('paymentAmount').textContent = outstandingText;
            
            // Generate payment content: Student Name - DOB - Month/Year
            const studentName = currentStudent.fullName || 'Student Name';
            
            // Format DOB as dd-mm-yyyy
            let formattedDOB = 'DOB';
            if (currentStudent.dateOfBirth && currentStudent.dateOfBirth !== 'N/A') {
                const dobString = currentStudent.dateOfBirth;
                // Handle different date formats that might be in the database
                let dobDate;
                if (dobString.includes('/')) {
                    // Assume dd/mm/yyyy or mm/dd/yyyy format
                    const parts = dobString.split('/');
                    if (parts.length === 3) {
                        // Try dd/mm/yyyy first (more common internationally)
                        dobDate = new Date(parts[2], parts[1] - 1, parts[0]);
                        // If invalid, try mm/dd/yyyy
                        if (isNaN(dobDate.getTime())) {
                            dobDate = new Date(parts[2], parts[0] - 1, parts[1]);
                        }
                    }
                } else if (dobString.includes('-')) {
                    // Handle yyyy-mm-dd or dd-mm-yyyy format
                    const parts = dobString.split('-');
                    if (parts.length === 3) {
                        if (parts[0].length === 4) {
                            // yyyy-mm-dd format
                            dobDate = new Date(parts[0], parts[1] - 1, parts[2]);
                        } else {
                            // dd-mm-yyyy format
                            dobDate = new Date(parts[2], parts[1] - 1, parts[0]);
                        }
                    }
                } else {
                    // Try to parse as is
                    dobDate = new Date(dobString);
                }
                
                // Format as dd-mm-yyyy if we have a valid date
                if (dobDate && !isNaN(dobDate.getTime())) {
                    const day = String(dobDate.getDate()).padStart(2, '0');
                    const month = String(dobDate.getMonth() + 1).padStart(2, '0');
                    const year = dobDate.getFullYear();
                    formattedDOB = `${day}-${month}-${year}`;
                } else {
                    // If parsing fails, use the original string
                    formattedDOB = dobString;
                }
            }
            
            const currentDate = new Date();
            const monthYear = `${String(currentDate.getMonth() + 1).padStart(2, '0')}-${currentDate.getFullYear()}`;
            
            const paymentContent = `${studentName} - ${formattedDOB} - ${monthYear}`;
            document.getElementById('paymentContent').textContent = paymentContent;
            
            // Generate VietQR code
            generateVietQR(outstandingAmount, paymentContent);
            
            // Show modal
            paymentModal.classList.remove('hidden');
            paymentModal.classList.add('flex');
        }

        function generateVietQR(amount, content) {
            const qrImage = document.getElementById('qrCodeImage');
            const qrLoading = document.getElementById('qrCodeLoading');
            
            // VietQR API parameters
            const bankId = '970407'; // Techcombank bank ID
            const accountNo = '51414131319'; // Remove spaces for API
            const template = 'compact'; // or 'compact2', 'print'
            
            // Build VietQR URL
            const vietQRUrl = `https://img.vietqr.io/image/${bankId}-${accountNo}-${template}.png?amount=${amount}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent('HOANG THANH TUNG')}`;
            
            // Load QR code
            qrImage.onload = function() {
                qrLoading.style.display = 'none';
                qrImage.style.display = 'block';
            };
            
            qrImage.onerror = function() {
                qrLoading.innerHTML = `
                    <div class="text-center text-red-500">
                        <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <p class="text-sm">QR generation failed</p>
                        <p class="text-xs">Please use manual transfer</p>
                    </div>
                `;
            };
            
            qrImage.src = vietQRUrl;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showCopyFeedback('Account number copied!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showCopyFeedback('Account number copied!');
            });
        }

        function copyPaymentAmount() {
            const amountText = document.getElementById('paymentAmount').textContent;
            const numericAmount = amountText.replace(/[^\d]/g, ''); // Extract only numbers
            copyToClipboard(numericAmount);
            showCopyFeedback('Amount copied!');
        }

        function copyPaymentContent() {
            const content = document.getElementById('paymentContent').textContent;
            copyToClipboard(content);
            showCopyFeedback('Transfer content copied!');
        }

        function showCopyFeedback(message) {
            // Create temporary feedback element
            const feedback = document.createElement('div');
            feedback.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity';
            feedback.textContent = message;
            document.body.appendChild(feedback);
            
            // Remove after 2 seconds
            setTimeout(() => {
                feedback.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(feedback);
                }, 300);
            }, 2000);
        }

        function downloadQRCode() {
            const qrImage = document.getElementById('qrCodeImage');
            if (qrImage.src && qrImage.style.display !== 'none') {
                const link = document.createElement('a');
                link.download = `${currentStudent?.fullName || 'Student'}-Payment-QR.png`;
                link.href = qrImage.src;
                link.click();
            } else {
                alert('QR code is not available for download');
            }
        }



        // Confirm payment completed function
        async function confirmPaymentCompleted() {
            if (!currentStudent) return;
            
            const checkButton = document.getElementById('checkPaymentBtn');
            if (checkButton) {
                checkButton.innerHTML = `
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                    Processing...
                `;
                checkButton.disabled = true;
            }
            
            try {
                // Update all unpaid tuition records to paid (but not processed)
                const tuitionSnapshot = await db.collection('tuition')
                    .where('studentId', '==', currentStudent.studentId)
                    .where('paid', '==', false)
                    .get();
                
                const extraFeesSnapshot = await db.collection('extraFees')
                    .where('studentId', '==', currentStudent.studentId)
                    .where('paid', '==', false)
                    .get();
                
                const batch = db.batch();
                const currentDate = new Date();
                
                // Update tuition records
                tuitionSnapshot.forEach(doc => {
                    batch.update(doc.ref, {
                        paid: true,
                        processed: false, // Will be set to true by accountants later
                        paymentDate: currentDate
                    });
                });
                
                // Update extra fees records
                extraFeesSnapshot.forEach(doc => {
                    batch.update(doc.ref, {
                        paid: true,
                        processed: false, // Will be set to true by accountants later
                        paymentDate: currentDate
                    });
                });
                
                await batch.commit();
                
                // Show success message
                showPaymentConfirmationSuccess();
                
                // Close payment modal after delay
                setTimeout(() => {
                    const paymentModal = document.getElementById('paymentModal');
                    paymentModal.classList.add('hidden');
                    paymentModal.classList.remove('flex');
                }, 3000);
                
                // Reload tuition data
                setTimeout(() => {
                    loadTuitionData(currentStudent.studentId);
                }, 1000);
                
            } catch (error) {
                console.error('Error confirming payment:', error);
                alert('Error confirming payment. Please try again.');
                
                if (checkButton) {
                    checkButton.innerHTML = `
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        I confirm that I have completed the transaction
                    `;
                    checkButton.disabled = false;
                }
            }
        }
        
        // Show payment confirmation success
        function showPaymentConfirmationSuccess() {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white p-6 rounded-lg shadow-lg z-50 max-w-md';
            
            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="text-green-200 mt-1">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h4 class="font-bold text-lg mb-2">✅ Payment Confirmed!</h4>
                        <p class="text-green-100 mb-3">
                            <span data-en="Thank you for confirming your payment. Your tuition status has been updated to 'Paid - Processing'. Our accountants will verify and finalize the payment within 5-10 days." data-vi="Cảm ơn bạn đã xác nhận thanh toán. Trạng thái học phí đã được cập nhật thành 'Đã Thanh Toán - Đang Xử Lý'. Kế toán sẽ xác minh và hoàn tất thanh toán trong 5-10 ngày.">Thank you for confirming your payment. Your tuition status has been updated to 'Paid - Processing'. Our accountants will verify and finalize the payment within 5-10 days.</span>
                        </p>
                        <p class="text-xs text-green-200">This window will close automatically...</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-green-200 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove notification after 8 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 8000);
        }

        // Enhanced payment instructions with monitoring
        function showPaymentInstructions() {
            if (!currentStudent) return;
            
            const paymentModal = document.getElementById('paymentModal');
            
            // Get outstanding amount from the tuition summary
            const outstandingText = document.getElementById('totalOutstandingAmount').textContent;
            const outstandingAmount = outstandingText.replace(/[^\d]/g, ''); // Extract numbers only
            
            // Update payment amount
            document.getElementById('paymentAmount').textContent = outstandingText;
            
            // Generate payment content: Student Name - DOB - Month/Year
            const studentName = currentStudent.fullName || 'Student Name';
            
            // Format DOB as dd-mm-yyyy
            let formattedDOB = 'DOB';
            if (currentStudent.dateOfBirth && currentStudent.dateOfBirth !== 'N/A') {
                const dobString = currentStudent.dateOfBirth;
                // Handle different date formats that might be in the database
                let dobDate;
                if (dobString.includes('/')) {
                    // Assume dd/mm/yyyy or mm/dd/yyyy format
                    const parts = dobString.split('/');
                    if (parts.length === 3) {
                        // Try dd/mm/yyyy first (more common internationally)
                        dobDate = new Date(parts[2], parts[1] - 1, parts[0]);
                        // If invalid, try mm/dd/yyyy
                        if (isNaN(dobDate.getTime())) {
                            dobDate = new Date(parts[2], parts[0] - 1, parts[1]);
                        }
                    }
                } else if (dobString.includes('-')) {
                    // Handle yyyy-mm-dd or dd-mm-yyyy format
                    const parts = dobString.split('-');
                    if (parts.length === 3) {
                        if (parts[0].length === 4) {
                            // yyyy-mm-dd format
                            dobDate = new Date(parts[0], parts[1] - 1, parts[2]);
                        } else {
                            // dd-mm-yyyy format
                            dobDate = new Date(parts[2], parts[1] - 1, parts[0]);
                        }
                    }
                } else {
                    // Try to parse as is
                    dobDate = new Date(dobString);
                }
                
                // Format as dd-mm-yyyy if we have a valid date
                if (dobDate && !isNaN(dobDate.getTime())) {
                    const day = String(dobDate.getDate()).padStart(2, '0');
                    const month = String(dobDate.getMonth() + 1).padStart(2, '0');
                    const year = dobDate.getFullYear();
                    formattedDOB = `${day}-${month}-${year}`;
                } else {
                    // If parsing fails, use the original string
                    formattedDOB = dobString;
                }
            }
            
            const currentDate = new Date();
            const monthYear = `${String(currentDate.getMonth() + 1).padStart(2, '0')}-${currentDate.getFullYear()}`;
            
            const paymentContent = `${studentName} - ${formattedDOB} - ${monthYear}`;
            document.getElementById('paymentContent').textContent = paymentContent;
            
            // Generate VietQR code
            generateVietQR(outstandingAmount, paymentContent);
            
            // Show modal
            paymentModal.classList.remove('hidden');
            paymentModal.classList.add('flex');
        }

        // Payment modal event listeners
        document.getElementById('closePaymentModal').addEventListener('click', () => {
            const paymentModal = document.getElementById('paymentModal');
            paymentModal.classList.add('hidden');
            paymentModal.classList.remove('flex');
        });

        // Close payment modal when clicking outside
        document.getElementById('paymentModal').addEventListener('click', (e) => {
            if (e.target.id === 'paymentModal') {
                const paymentModal = document.getElementById('paymentModal');
                paymentModal.classList.add('hidden');
                paymentModal.classList.remove('flex');
            }
        });

        // Load student for profile mode
        async function loadStudentForProfile(studentId) {
            try {
                const studentDoc = await db.collection('students').doc(studentId).get();
                
                if (!studentDoc.exists) {
                    showProfileError('Student not found', 'The requested student profile could not be found.');
                    return;
                }
                
                const studentData = { id: studentDoc.id, ...studentDoc.data() };
                currentStudent = studentData;
                
                // Create profile-only interface
                createProfileOnlyInterface(studentData);
                
            } catch (error) {
                console.error('Error loading student for profile:', error);
                showProfileError('Loading Error', 'There was an error loading the student profile. Please try again later.');
            }
        }

        // Show profile error
        function showProfileError(title, message) {
            document.body.innerHTML = `
                <div class="min-h-screen bg-gray-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full text-center">
                        <div class="text-red-500 mb-4">
                            <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-900 mb-2">${title}</h2>
                        <p class="text-gray-600 mb-4">${message}</p>
                        <button onclick="window.location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            Try Again
                        </button>
                    </div>
                </div>
            `;
        }

        // Create profile-only interface
        function createProfileOnlyInterface(student) {
            document.body.innerHTML = `
                <div class="min-h-screen bg-gray-50">
                    <!-- Mobile-optimized header -->
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 sm:p-6">
                        <div class="max-w-4xl mx-auto">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 sm:w-16 sm:h-16 bg-white/20 rounded-full flex items-center justify-center">
                                        <svg class="w-6 h-6 sm:w-8 sm:h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h1 class="text-xl sm:text-2xl font-bold">${student.fullName || 'Student Profile'}</h1>
                                        <p class="text-blue-100 text-sm sm:text-base">ID: ${student.studentId || 'N/A'}</p>
                                        <p class="text-blue-100 text-sm">Class: ${student.classAssignment || 'N/A'}</p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button id="langEn" onclick="switchLanguage('en')" class="px-3 py-1 text-xs font-medium rounded-lg bg-white/20 text-white">EN</button>
                                    <button id="langVi" onclick="switchLanguage('vi')" class="px-3 py-1 text-xs font-medium rounded-lg bg-white/10 text-white/70 hover:bg-white/20">VI</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile content -->
                    <div class="max-w-4xl mx-auto p-4 sm:p-6">
                        <!-- Profile Tabs -->
                        <div class="bg-white rounded-lg shadow-sm border mb-6">
                            <div class="border-b border-gray-200">
                                <nav class="flex overflow-x-auto">
                                    <button type="button" onclick="switchProfileTab('basic')" id="basicProfileTab" class="py-3 px-4 border-b-2 font-medium text-sm border-blue-500 text-blue-600 whitespace-nowrap">
                                        📋 <span data-en="Basic Info" data-vi="Thông Tin">Basic Info</span>
                                    </button>
                                    <button type="button" onclick="switchProfileTab('attendance')" id="attendanceProfileTab" class="py-3 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm whitespace-nowrap">
                                        📅 <span data-en="Attendance" data-vi="Điểm Danh">Attendance</span>
                                    </button>
                                    <button type="button" onclick="switchProfileTab('studyprogress')" id="studyprogressProfileTab" class="py-3 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm whitespace-nowrap">
                                        📚 <span data-en="Progress" data-vi="Tiến Độ">Progress</span>
                                    </button>
                                    <button type="button" onclick="switchProfileTab('tuition')" id="tuitionProfileTab" class="py-3 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm whitespace-nowrap">
                                        💰 <span data-en="Tuition" data-vi="Học Phí">Tuition</span>
                                    </button>
                                </nav>
                            </div>

                            <!-- Tab Contents -->
                            <div class="p-4 sm:p-6">
                                ${createProfileTabContents(student)}
                            </div>
                        </div>
                    </div>

                    <!-- Payment Modal (reuse existing) -->
                    ${document.getElementById('paymentModal').outerHTML}
                </div>
            `;

            // Initialize profile data
            initializeProfileData(student);
        }

        // Create profile tab contents
        function createProfileTabContents(student) {
            const statusColors = {
                'Active': 'bg-green-100 text-green-800',
                'Inactive': 'bg-red-100 text-red-800',
                'Graduated': 'bg-blue-100 text-blue-800',
                'Dropped': 'bg-gray-100 text-gray-800'
            };

            return `
                <!-- Basic Information Tab -->
                <div id="basicProfileContent" class="space-y-6">
                    <!-- Basic Information Section -->
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            📋 <span data-en="Basic Information" data-vi="Thông Tin Cơ Bản">Basic Information</span>
                        </h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <label class="text-sm font-medium text-gray-600">Student ID</label>
                                <p class="text-gray-900 font-medium">${student.studentId || 'N/A'}</p>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <label class="text-sm font-medium text-gray-600">Full Name</label>
                                <p class="text-gray-900 font-medium">${student.fullName || 'N/A'}</p>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <label class="text-sm font-medium text-gray-600">Date of Birth</label>
                                <p class="text-gray-900 font-medium">${student.dateOfBirth || 'N/A'}</p>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <label class="text-sm font-medium text-gray-600">Status</label>
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusColors[student.status] || 'bg-gray-100 text-gray-800'}">${student.status || 'Unknown'}</span>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <label class="text-sm font-medium text-gray-600">School</label>
                                <p class="text-gray-900 font-medium">${student.school || 'N/A'}</p>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <label class="text-sm font-medium text-gray-600">Class Assignment</label>
                                <p class="text-gray-900 font-medium">${student.classAssignment || 'N/A'}</p>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg sm:col-span-2">
                                <label class="text-sm font-medium text-gray-600">Year Enrolled</label>
                                <p class="text-gray-900 font-medium">${student.yearEnrolled || 'N/A'}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information Section -->
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            📞 <span data-en="Contact Information" data-vi="Thông Tin Liên Hệ">Contact Information</span>
                        </h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="bg-green-50 p-4 rounded-lg">
                                <label class="text-sm font-medium text-gray-600">Student Phone</label>
                                <p class="text-gray-900 font-medium">${student.studentPhone || 'N/A'}</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <label class="text-sm font-medium text-gray-600">Parent Name</label>
                                <p class="text-gray-900 font-medium">${student.parentName || 'N/A'}</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg sm:col-span-2">
                                <label class="text-sm font-medium text-gray-600">Parent Phone</label>
                                <p class="text-gray-900 font-medium">${student.parentPhone || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Study Progress Tab -->
                <div id="studyprogressProfileContent" class="space-y-4 hidden">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <h4 class="font-semibold text-gray-900">${student.fullName || 'Student'}</h4>
                                <p class="text-sm text-gray-600">${student.studentId || 'N/A'}</p>
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full mt-1 ${statusColors[student.status] || 'bg-gray-100 text-gray-800'}">${student.status || 'Unknown'}</span>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600"><span data-en="First Lesson" data-vi="Buổi Học Đầu">First Lesson</span></p>
                                <p class="font-medium" id="progressFirstLesson">Loading...</p>
                                <p class="text-sm text-gray-600 mt-2"><span data-en="Recent Lesson" data-vi="Buổi Học Gần Nhất">Recent Lesson</span></p>
                                <p class="font-medium" id="progressRecentLesson">Loading...</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600"><span data-en="Total Lessons" data-vi="Tổng Số Buổi Học">Total Lessons</span></p>
                                <p class="font-medium text-lg" id="progressTotalLessons">0</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600"><span data-en="Assessments" data-vi="Đánh Giá">Assessments</span></p>
                                <div class="flex items-center mt-1">
                                    <span class="text-2xl font-bold" id="progressOverallScore">--</span>
                                    <span class="text-sm text-gray-500 ml-1">total</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Course Progress Sections -->
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                            🔄 <span data-en="In Progress Courses" data-vi="Khóa Học Đang Học">In Progress Courses</span> (<span id="inprogressCount">0</span>)
                        </h4>
                        <div id="inprogressCoursesList" class="space-y-2">
                            <p class="text-gray-500 text-center py-4">Loading courses...</p>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                            ⏳ <span data-en="Upcoming Courses" data-vi="Khóa Học Sắp Tới">Upcoming Courses</span> (<span id="upcomingCount">0</span>)
                        </h4>
                        <div id="upcomingCoursesList" class="space-y-2">
                            <p class="text-gray-500 text-center py-4">Loading courses...</p>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                            ✅ <span data-en="Finished Courses" data-vi="Khóa Học Đã Hoàn Thành">Finished Courses</span> (<span id="finishedCount">0</span>)
                        </h4>
                        <div id="finishedCoursesList" class="space-y-2">
                            <p class="text-gray-500 text-center py-4">Loading courses...</p>
                        </div>
                    </div>
                </div>

                <!-- Attendance Tab -->
                <div id="attendanceProfileContent" class="space-y-4 hidden">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-4">
                        <h4 class="text-lg font-semibold text-gray-900"><span data-en="Monthly Attendance Records" data-vi="Bản Ghi Điểm Danh Hàng Tháng">Monthly Attendance Records</span></h4>
                        <div class="flex items-center gap-4 text-sm">
                            <div class="flex items-center gap-1">
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                <span data-en="Present" data-vi="Có Mặt">Present</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <span data-en="Absent" data-vi="Vắng Mặt">Absent</span>
                            </div>
                        </div>
                    </div>
                    <div id="attendanceRecords" class="space-y-4">
                        <p class="text-gray-500 text-center py-4">Loading attendance records...</p>
                    </div>
                </div>

                <!-- Tuition Tab -->
                <div id="tuitionProfileContent" class="space-y-4 hidden">
                    <h4 class="text-lg font-semibold text-gray-900 mb-3"><span data-en="Tuition Information" data-vi="Thông Tin Học Phí">Tuition Information</span></h4>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Tuition Records -->
                        <div class="lg:col-span-2 space-y-4">
                            <!-- Unpaid Tuition Section -->
                            <div class="bg-red-50 border border-red-200 rounded-lg">
                                <button onclick="toggleTuitionSection('unpaid')" class="w-full flex justify-between items-center p-4 text-left hover:bg-red-100 transition-colors">
                                    <h5 class="font-semibold text-red-800 flex items-center">
                                        🔴 <span data-en="Unpaid Tuition" data-vi="Học Phí Chưa Thanh Toán" class="ml-2">Unpaid Tuition</span>
                                        <span id="unpaidCount" class="ml-2 bg-red-200 text-red-800 px-2 py-1 rounded-full text-xs">(0)</span>
                                    </h5>
                                    <svg id="unpaidChevron" class="w-5 h-5 text-red-600 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div id="unpaidTuitionContent" class="px-4 pb-4">
                                    <div id="unpaidTuitionList" class="space-y-2">
                                        <p class="text-gray-500 text-center py-4">Loading tuition data...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Processing Tuition Section -->
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg">
                                <button onclick="toggleTuitionSection('processing')" class="w-full flex justify-between items-center p-4 text-left hover:bg-yellow-100 transition-colors">
                                    <h5 class="font-semibold text-yellow-800 flex items-center">
                                        🔄 <span data-en="Paid - Processing" data-vi="Đã Thanh Toán - Đang Xử Lý" class="ml-2">Paid - Processing</span>
                                        <span id="processingCount" class="ml-2 bg-yellow-200 text-yellow-800 px-2 py-1 rounded-full text-xs">(0)</span>
                                    </h5>
                                    <svg id="processingChevron" class="w-5 h-5 text-yellow-600 transform transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div id="processingTuitionContent" class="px-4 pb-4 hidden">
                                    <div id="processingTuitionList" class="space-y-2">
                                        <p class="text-gray-500 text-center py-4">Loading tuition data...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Paid Tuition Section -->
                            <div class="bg-green-50 border border-green-200 rounded-lg">
                                <button onclick="toggleTuitionSection('paid')" class="w-full flex justify-between items-center p-4 text-left hover:bg-green-100 transition-colors">
                                    <h5 class="font-semibold text-green-800 flex items-center">
                                        ✅ <span data-en="Paid Tuition" data-vi="Học Phí Đã Thanh Toán" class="ml-2">Paid Tuition</span>
                                        <span id="paidCount" class="ml-2 bg-green-200 text-green-800 px-2 py-1 rounded-full text-xs">(0)</span>
                                    </h5>
                                    <svg id="paidChevron" class="w-5 h-5 text-green-600 transform transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div id="paidTuitionContent" class="px-4 pb-4 hidden">
                                    <div id="paidTuitionList" class="space-y-2">
                                        <p class="text-gray-500 text-center py-4">Loading tuition data...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Summary -->
                        <div class="lg:col-span-1">
                            <div class="bg-white border border-gray-200 rounded-lg p-6 sticky top-4">
                                <h5 class="font-semibold text-gray-900 mb-4"><span data-en="Payment Summary" data-vi="Tóm Tắt Thanh Toán">Payment Summary</span></h5>
                                
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center py-2">
                                        <span class="text-gray-600"><span data-en="Total Outstanding" data-vi="Tổng Còn Nợ">Total Outstanding</span>:</span>
                                        <span id="totalOutstandingAmount" class="font-bold text-red-600 text-lg">0 VND</span>
                                    </div>
                                </div>
                                
                                <button id="payTuitionBtn" onclick="showPaymentInstructions()" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                                    💳 <span data-en="Pay Tuition" data-vi="Thanh Toán Học Phí" class="ml-2">Pay Tuition</span>
                                </button>
                                
                                <p class="text-xs text-blue-600 mt-2 text-center cursor-pointer hover:underline" onclick="showPaymentInstructions()">
                                    <span data-en="Click for payment instructions" data-vi="Nhấp để xem hướng dẫn thanh toán">Click for payment instructions</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize profile data
        async function initializeProfileData(student) {
            // Load progress data
            const progressData = await loadStudentProgressData(student.studentId || student.id);
            
            if (progressData) {
                document.getElementById('progressFirstLesson').textContent = progressData.firstLesson;
                document.getElementById('progressRecentLesson').textContent = progressData.recentLesson;
                document.getElementById('progressTotalLessons').textContent = progressData.totalLessons;
                document.getElementById('progressOverallScore').textContent = progressData.totalAssessments;
                
                // Store progress data globally for tab switching
                window.currentProgressData = progressData;
                
                // Update course progress
                updateCourseProgress(progressData.courses);
                
                // Update attendance records
                updateAttendanceRecords(progressData.attendance);
            }
            
            // Load tuition data
            loadTuitionData(student.studentId || student.id);
        }

        // Copy direct link function
        function copyDirectLink() {
            const linkInput = document.getElementById('directProfileLink');
            linkInput.select();
            document.execCommand('copy');
            
            const button = document.getElementById('copyDirectLink');
            const originalText = button.textContent;
            button.textContent = 'Copied!';
            button.classList.remove('bg-green-600', 'hover:bg-green-700');
            button.classList.add('bg-green-700');
            
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('bg-green-700');
                button.classList.add('bg-green-600', 'hover:bg-green-700');
            }, 2000);
        }

        // Make functions globally available
        window.switchTab = switchTab;
        window.toggleSelectAll = toggleSelectAll;
        window.editStudent = editStudent;
        window.showStudentProfile = showStudentProfile;
        window.switchProfileTab = switchProfileTab;
        window.switchLearningTab = switchLearningTab;
        window.switchLanguage = switchLanguage;
        window.toggleTuitionSection = toggleTuitionSection;
        window.showPaymentInstructions = showPaymentInstructions;
        window.copyToClipboard = copyToClipboard;
        window.copyPaymentAmount = copyPaymentAmount;
        window.copyPaymentContent = copyPaymentContent;
        window.confirmPaymentCompleted = confirmPaymentCompleted;
        window.copyDirectLink = copyDirectLink;
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'977ced20c5bb8623',t:'MTc1NjY0NzQ4Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
