<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Directory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="bg-blue-100 p-3 rounded-lg mr-4">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Student Directory</h1>
                        <p class="text-gray-600 mt-1">Manage and view all student information</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p class="text-sm text-gray-500">Total Students</p>
                        <p id="totalCount" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <!-- Status Tabs -->
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8 px-6" aria-label="Tabs">
                    <button onclick="switchTab('active')" id="activeTab" class="border-transparent text-blue-600 border-b-2 border-blue-500 py-4 px-1 text-sm font-medium">
                        Active Students
                        <span id="activeCount" class="ml-2 bg-blue-100 text-blue-600 py-0.5 px-2.5 rounded-full text-xs font-medium">0</span>
                    </button>
                    <button onclick="switchTab('finished')" id="finishedTab" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 border-b-2 py-4 px-1 text-sm font-medium">
                        Finished Students
                        <span id="finishedCount" class="ml-2 bg-gray-100 text-gray-600 py-0.5 px-2.5 rounded-full text-xs font-medium">0</span>
                    </button>
                    <button onclick="switchTab('inactive')" id="inactiveTab" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 border-b-2 py-4 px-1 text-sm font-medium">
                        Inactive Students
                        <span id="inactiveCount" class="ml-2 bg-gray-100 text-gray-600 py-0.5 px-2.5 rounded-full text-xs font-medium">0</span>
                    </button>
                    <button onclick="switchTab('dropped')" id="droppedTab" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 border-b-2 py-4 px-1 text-sm font-medium">
                        Dropped Students
                        <span id="droppedCount" class="ml-2 bg-gray-100 text-gray-600 py-0.5 px-2.5 rounded-full text-xs font-medium">0</span>
                    </button>
                </nav>
            </div>

            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 id="tabTitle" class="text-xl font-semibold text-gray-900">Active Students</h2>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-500">View:</span>
                        <div class="flex bg-gray-100 rounded-lg p-1">
                            <button onclick="switchView('grid')" id="gridViewBtn" class="px-3 py-1 text-sm font-medium rounded-md bg-white text-gray-900 shadow-sm">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                                </svg>
                                Grid
                            </button>
                            <button onclick="switchView('table')" id="tableViewBtn" class="px-3 py-1 text-sm font-medium rounded-md text-gray-600 hover:text-gray-900">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0V4a1 1 0 011-1h3M3 20h18a1 1 0 001-1V5a1 1 0 00-1-1H3a1 1 0 00-1 1v14a1 1 0 001 1z"></path>
                                </svg>
                                Table
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Search and Filters -->
                <div class="flex flex-col sm:flex-row gap-4 mb-6">
                    <div class="flex-1">
                        <div class="relative">
                            <input type="text" id="searchInput" placeholder="Search students (supports Vietnamese)..." 
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <svg class="absolute left-3 top-2.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <select id="classFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">All Classes</option>
                            <!-- Classes will be loaded dynamically -->
                        </select>
                        <select id="sortBy" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="name">Sort by Name</option>
                            <option value="id">Sort by Student ID</option>
                            <option value="dob">Sort by Date of Birth</option>
                            <option value="yearEnrolled">Sort by Year Enrolled</option>
                        </select>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p class="text-gray-500">Loading students...</p>
                </div>

                <!-- Error State -->
                <div id="errorState" class="hidden text-center py-12">
                    <div class="text-red-500 text-6xl mb-4">‚ö†Ô∏è</div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Error Loading Students</h3>
                    <p id="errorMessage" class="text-gray-500 mb-4">Something went wrong while loading the student data.</p>
                    <button onclick="loadStudents()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        Try Again
                    </button>
                </div>

                <!-- Students Grid -->
                <div id="studentsGrid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Student cards will be populated here -->
                </div>

                <!-- Students Table -->
                <div id="studentsTable" class="hidden overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date of Birth</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year Enrolled</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Table rows will be populated here -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="hidden text-center py-12">
                    <div class="text-gray-400 text-6xl mb-4">üë•</div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No Students Found</h3>
                    <p class="text-gray-500">Try adjusting your search or filter criteria.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDdx6QyXzCWz7BRZInLu16LGnYBKvFO1CM",
            authDomain: "tnl-management-app.firebaseapp.com",
            projectId: "tnl-management-app",
            storageBucket: "tnl-management-app.firebasestorage.app",
            messagingSenderId: "710843379828",
            appId: "1:710843379828:web:76978490616ebe41bf2121",
            measurementId: "G-8W29VX7WTP"
        };

        // Initialize Firebase
        let db;
        let allStudents = [];
        let currentTab = 'active';
        let currentView = 'grid';

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        } catch (error) {
            console.error('Firebase initialization error:', error);
            showError('Failed to initialize Firebase connection.');
        }

        // Vietnamese text normalization for search
        function normalizeVietnamese(text) {
            if (!text) return '';
            return text.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
                .replace(/ƒë/g, 'd')
                .replace(/ƒê/g, 'd');
        }

        // Load unique classes from students
        function loadClasses() {
            const classes = new Set();
            allStudents.forEach(student => {
                const studentClass = student.classAssignment || student.class;
                if (studentClass) {
                    classes.add(studentClass);
                }
            });

            const classFilter = document.getElementById('classFilter');
            // Clear existing options except "All Classes"
            classFilter.innerHTML = '<option value="">All Classes</option>';
            
            // Sort classes and add to dropdown
            Array.from(classes).sort().forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classFilter.appendChild(option);
            });
        }

        // Tab switching functionality
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            const tabs = ['active', 'finished', 'inactive', 'dropped'];
            tabs.forEach(t => {
                const tabBtn = document.getElementById(`${t}Tab`);
                if (t === tab) {
                    tabBtn.className = 'border-transparent text-blue-600 border-b-2 border-blue-500 py-4 px-1 text-sm font-medium';
                } else {
                    tabBtn.className = 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 border-b-2 py-4 px-1 text-sm font-medium';
                }
            });
            
            // Update title
            const titles = {
                'active': 'Active Students',
                'finished': 'Finished Students',
                'inactive': 'Inactive Students',
                'dropped': 'Dropped Students'
            };
            document.getElementById('tabTitle').textContent = titles[tab];
            
            // Filter and display students
            filterStudents();
        }

        // View switching functionality
        function switchView(view) {
            currentView = view;
            
            // Update view buttons
            const gridBtn = document.getElementById('gridViewBtn');
            const tableBtn = document.getElementById('tableViewBtn');
            
            if (view === 'grid') {
                gridBtn.className = 'px-3 py-1 text-sm font-medium rounded-md bg-white text-gray-900 shadow-sm';
                tableBtn.className = 'px-3 py-1 text-sm font-medium rounded-md text-gray-600 hover:text-gray-900';
            } else {
                gridBtn.className = 'px-3 py-1 text-sm font-medium rounded-md text-gray-600 hover:text-gray-900';
                tableBtn.className = 'px-3 py-1 text-sm font-medium rounded-md bg-white text-gray-900 shadow-sm';
            }
            
            // Show/hide views
            const gridView = document.getElementById('studentsGrid');
            const tableView = document.getElementById('studentsTable');
            
            if (view === 'grid') {
                gridView.classList.remove('hidden');
                tableView.classList.add('hidden');
            } else {
                gridView.classList.add('hidden');
                tableView.classList.remove('hidden');
            }
            
            // Re-display current data
            filterStudents();
        }

        // Update status counts
        function updateStatusCounts() {
            const counts = {
                active: allStudents.filter(s => (s.status || 'active') === 'active').length,
                finished: allStudents.filter(s => (s.status || 'active') === 'finished').length,
                inactive: allStudents.filter(s => (s.status || 'active') === 'inactive').length,
                dropped: allStudents.filter(s => (s.status || 'active') === 'dropped').length
            };
            
            document.getElementById('activeCount').textContent = counts.active;
            document.getElementById('finishedCount').textContent = counts.finished;
            document.getElementById('inactiveCount').textContent = counts.inactive;
            document.getElementById('droppedCount').textContent = counts.dropped;
        }

        // Load students from Firestore with robust field mapping
        async function loadStudents() {
            try {
                showLoading();
                
                // Try multiple possible collection names
                const possibleCollections = ['students', 'student', 'Users', 'users'];
                let studentsData = [];
                let collectionFound = false;
                
                for (const collectionName of possibleCollections) {
                    try {
                        console.log(`Trying to load from collection: ${collectionName}`);
                        const snapshot = await db.collection(collectionName).get();
                        
                        if (snapshot.size > 0) {
                            console.log(`Found ${snapshot.size} documents in ${collectionName}`);
                            snapshot.forEach(doc => {
                                const data = doc.data();
                                const processedStudent = processStudentData(doc.id, data);
                                if (processedStudent) {
                                    studentsData.push(processedStudent);
                                }
                            });
                            collectionFound = true;
                            break;
                        }
                    } catch (error) {
                        console.log(`Collection ${collectionName} not accessible:`, error.message);
                        continue;
                    }
                }
                
                if (!collectionFound) {
                    throw new Error('No accessible student collections found');
                }
                
                allStudents = studentsData;
                console.log('Successfully loaded students:', allStudents.length);
                console.log('Sample student data:', allStudents[0]);
                
                loadClasses(); // Load classes after students are loaded
                updateStatusCounts(); // Update tab counts
                filterStudents(); // Display filtered students based on current tab
                hideLoading();
                
            } catch (error) {
                console.error('Error loading students:', error);
                showError(`Failed to load students: ${error.message}. Please check your database connection.`);
                hideLoading();
            }
        }

        // Process and normalize student data from different possible field structures
        function processStudentData(docId, rawData) {
            if (!rawData) return null;
            
            // Map various possible field names to standardized fields
            const student = {
                id: docId,
                // Name fields - try multiple possibilities
                fullName: rawData.fullName || rawData.name || rawData.studentName || rawData.displayName || 
                         `${rawData.firstName || ''} ${rawData.lastName || ''}`.trim() || 'Unknown Name',
                
                // Student ID fields
                studentId: rawData.studentId || rawData.id || rawData.student_id || rawData.userId || 
                          rawData.user_id || rawData.studentNumber || docId,
                
                // Class fields
                classAssignment: rawData.classAssignment || rawData.class || rawData.className || 
                               rawData.grade || rawData.currentClass || rawData.assignedClass,
                
                // Date of birth fields
                dateOfBirth: rawData.dateOfBirth || rawData.dob || rawData.birthDate || 
                           rawData.date_of_birth || rawData.birthday,
                
                // Year enrolled fields
                yearEnrolled: rawData.yearEnrolled || rawData.enrollmentYear || rawData.admissionYear || 
                            rawData.startYear || rawData.year_enrolled || rawData.joinedYear,
                
                // Contact fields
                phoneNumber: rawData.phoneNumber || rawData.phone || rawData.contactNumber || 
                           rawData.mobile || rawData.parentPhone || rawData.guardianPhone,
                
                email: rawData.email || rawData.emailAddress || rawData.studentEmail,
                
                // Status field
                status: rawData.status || rawData.studentStatus || rawData.enrollmentStatus || 'active',
                
                // Additional fields that might be useful
                address: rawData.address || rawData.homeAddress || rawData.residentialAddress,
                parentName: rawData.parentName || rawData.guardianName || rawData.parent || rawData.guardian,
                notes: rawData.notes || rawData.remarks || rawData.comments,
                
                // Keep original data for debugging
                _originalData: rawData
            };
            
            // Validate that we have minimum required data
            if (!student.fullName || student.fullName === 'Unknown Name') {
                console.warn('Student with insufficient name data:', docId, rawData);
            }
            
            // Normalize status to lowercase
            if (student.status) {
                student.status = student.status.toLowerCase();
            }
            
            // Ensure status is one of our expected values
            const validStatuses = ['active', 'inactive', 'finished', 'dropped'];
            if (!validStatuses.includes(student.status)) {
                student.status = 'active'; // Default to active if status is unknown
            }
            
            return student;
        }

        // Search and filter functionality
        function filterStudents() {
            const searchTerm = normalizeVietnamese(document.getElementById('searchInput').value);
            const classFilter = document.getElementById('classFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            let filtered = allStudents.filter(student => {
                const normalizedName = normalizeVietnamese(student.fullName || '');
                const normalizedId = normalizeVietnamese(student.studentId || '');
                const studentStatus = student.status || 'active';
                
                const matchesSearch = !searchTerm || 
                                    normalizedName.includes(searchTerm) ||
                                    normalizedId.includes(searchTerm);
                const matchesClass = !classFilter || (student.classAssignment || student.class) === classFilter;
                const matchesTab = studentStatus === currentTab;
                
                return matchesSearch && matchesClass && matchesTab;
            });

            // Sort students
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'name':
                        return (a.fullName || '').localeCompare(b.fullName || '');
                    case 'id':
                        return (a.studentId || '').localeCompare(b.studentId || '');
                    case 'dob':
                        const dateA = new Date(a.dateOfBirth || '1900-01-01');
                        const dateB = new Date(b.dateOfBirth || '1900-01-01');
                        return dateA - dateB;
                    case 'yearEnrolled':
                        const yearA = parseInt(a.yearEnrolled || a.enrollmentYear || '0');
                        const yearB = parseInt(b.yearEnrolled || b.enrollmentYear || '0');
                        return yearA - yearB;
                    default:
                        return 0;
                }
            });

            displayStudents(filtered);
        }

        // Display students
        function displayStudents(students) {
            const grid = document.getElementById('studentsGrid');
            const table = document.getElementById('studentsTable');
            const tableBody = document.getElementById('studentsTableBody');
            const emptyState = document.getElementById('emptyState');
            const totalCount = document.getElementById('totalCount');

            totalCount.textContent = students.length;

            if (students.length === 0) {
                grid.classList.add('hidden');
                table.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            if (currentView === 'grid') {
                grid.classList.remove('hidden');
                table.classList.add('hidden');
                grid.innerHTML = students.map(student => createStudentCard(student)).join('');
            } else {
                grid.classList.add('hidden');
                table.classList.remove('hidden');
                tableBody.innerHTML = students.map(student => createStudentRow(student)).join('');
            }
        }

        // Create student card HTML
        function createStudentCard(student) {
            const statusColor = getStatusColor(student.status || 'active');
            const statusText = getStatusText(student.status || 'active');
            
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow cursor-pointer" 
                     onclick="viewStudentDetails('${student.id}')">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center">
                            <div class="bg-blue-100 p-2 rounded-lg mr-3">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900 text-lg">${student.fullName || 'Unknown Name'}</h3>
                                <p class="text-sm text-gray-500">ID: ${student.studentId || 'N/A'}</p>
                            </div>
                        </div>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                            ${statusText}
                        </span>
                    </div>
                    
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Class:</span>
                            <span class="font-medium">${student.classAssignment || student.class || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Date of Birth:</span>
                            <span class="font-medium">${formatDate(student.dateOfBirth) || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Year Enrolled:</span>
                            <span class="font-medium">${student.yearEnrolled || student.enrollmentYear || 'N/A'}</span>
                        </div>
                        ${student.phoneNumber ? `
                        <div class="flex justify-between">
                            <span class="text-gray-500">Phone:</span>
                            <span class="font-medium">${student.phoneNumber}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <button class="w-full bg-blue-50 hover:bg-blue-100 text-blue-700 font-medium py-2 px-4 rounded-lg transition-colors text-sm">
                            View Details
                        </button>
                    </div>
                </div>
            `;
        }

        // Create student table row HTML
        function createStudentRow(student) {
            const statusColor = getStatusColor(student.status || 'active');
            const statusText = getStatusText(student.status || 'active');
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="bg-blue-100 p-2 rounded-lg">
                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${student.fullName || 'Unknown Name'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.studentId || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.classAssignment || student.class || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(student.dateOfBirth) || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.yearEnrolled || student.enrollmentYear || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.phoneNumber || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewStudentDetails('${student.id}')" class="text-blue-600 hover:text-blue-900">
                            View Details
                        </button>
                    </td>
                </tr>
            `;
        }

        // View student details
        function viewStudentDetails(studentId) {
            // Open student tuition page in new tab
            window.open(`studenttuitioninfo.html?id=${studentId}`, '_blank');
        }

        // Helper functions
        function getStatusColor(status) {
            switch(status) {
                case 'active': return 'bg-green-100 text-green-800';
                case 'inactive': return 'bg-yellow-100 text-yellow-800';
                case 'finished': return 'bg-purple-100 text-purple-800';
                case 'dropped': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'active': return 'Active';
                case 'inactive': return 'Inactive';
                case 'finished': return 'Finished';
                case 'dropped': return 'Dropped';
                default: return 'Unknown';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return null;
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (error) {
                return dateString;
            }
        }

        // UI State Management
        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('studentsGrid').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('studentsGrid').classList.add('hidden');
            document.getElementById('studentsTable').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
        }

        // Event Listeners
        document.getElementById('searchInput').addEventListener('input', filterStudents);
        document.getElementById('classFilter').addEventListener('change', filterStudents);
        document.getElementById('sortBy').addEventListener('change', filterStudents);

        // Test Firebase connection
        async function testFirebaseConnection() {
            try {
                console.log('Testing Firebase connection...');
                
                // Test basic connectivity
                const testDoc = await db.collection('test').limit(1).get();
                console.log('Firebase connection successful');
                
                // List all collections to help with debugging
                console.log('Attempting to list available collections...');
                
                // Try to access some common collections to see what's available
                const commonCollections = ['students', 'student', 'Users', 'users', 'tuition', 'classes'];
                for (const collectionName of commonCollections) {
                    try {
                        const snapshot = await db.collection(collectionName).limit(1).get();
                        console.log(`Collection '${collectionName}': ${snapshot.size} documents (showing first 1)`);
                        if (snapshot.size > 0) {
                            snapshot.forEach(doc => {
                                console.log(`Sample document from ${collectionName}:`, doc.id, Object.keys(doc.data()));
                            });
                        }
                    } catch (error) {
                        console.log(`Collection '${collectionName}': Not accessible or doesn't exist`);
                    }
                }
                
                return true;
            } catch (error) {
                console.error('Firebase connection test failed:', error);
                return false;
            }
        }


        // Initialize with connection testing
        document.addEventListener('DOMContentLoaded', async function() {
            if (!db) {
                showError('Failed to initialize Firebase. Please check your configuration.');
                return;
            }
            
            console.log('Starting application initialization...');
            
            // Test connection first
            const connectionOk = await testFirebaseConnection();
            
            if (connectionOk) {
                console.log('Firebase connection verified, loading students...');
                loadStudents();
            } else {
                showError('Cannot connect to Firebase. Please check your internet connection and try again.');
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97a4f74b56b1045d',t:'MTc1NzA2NzMzMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
