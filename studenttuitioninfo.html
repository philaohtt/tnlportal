<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.5, maximum-scale=3.0">
    <title>Student Tuition Information</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-6">
            <div class="flex justify-between items-start mb-4">
                <div class="flex items-center">
                    <div class="bg-green-100 p-3 rounded-xl mr-4">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 mb-1 flex items-center">
                            üí∞ <span data-en="Tuition Information" data-vi="Th√¥ng Tin H·ªçc Ph√≠" class="ml-2">Tuition Information</span>
                        </h1>
                        <p class="text-gray-600" id="studentNameSubtitle" data-en="Loading student information..." data-vi="ƒêang t·∫£i th√¥ng tin h·ªçc sinh...">Loading student information...</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <!-- Language Switcher -->
                    <div class="flex items-center gap-2 bg-gray-100 rounded-lg p-1">
                        <button id="langEn" onclick="switchLanguage('en')" class="px-3 py-1 text-sm font-medium rounded-md text-gray-600 hover:bg-white transition-all">EN</button>
                        <button id="langVi" onclick="switchLanguage('vi')" class="px-3 py-1 text-sm font-medium rounded-md bg-blue-600 text-white transition-all">VI</button>
                    </div>
                    

                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="bg-white rounded-xl shadow-lg border border-gray-200 p-12 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-500 text-lg" data-en="Loading tuition information..." data-vi="ƒêang t·∫£i th√¥ng tin h·ªçc ph√≠...">Loading tuition information...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden bg-white rounded-xl shadow-lg border border-red-200 p-12 text-center">
            <div class="text-6xl mb-4">‚ùå</div>
            <h3 class="text-lg font-medium text-gray-900 mb-2" data-en="Student Not Found" data-vi="Kh√¥ng T√¨m Th·∫•y H·ªçc Sinh">Student Not Found</h3>
            <p class="text-gray-500 mb-6" data-en="The student ID provided could not be found in our system." data-vi="Kh√¥ng t√¨m th·∫•y m√£ h·ªçc sinh trong h·ªá th·ªëng.">The student ID provided could not be found in our system.</p>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="hidden">
            <!-- Student Info Card -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-500 mb-1" data-en="Student ID" data-vi="M√£ H·ªçc Sinh">Student ID</label>
                        <p id="studentId" class="text-lg font-semibold text-gray-900">-</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-500 mb-1" data-en="Full Name" data-vi="H·ªç T√™n">Full Name</label>
                        <p id="studentName" class="text-lg font-semibold text-gray-900">-</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-500 mb-1" data-en="Class" data-vi="L·ªõp">Class</label>
                        <p id="studentClass" class="text-lg font-semibold text-gray-900">-</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-500 mb-1" data-en="Status" data-vi="Tr·∫°ng Th√°i">Status</label>
                        <span id="studentStatus" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-green-100 text-green-800">Active</span>
                    </div>
                </div>
            </div>

            <!-- Split Layout: Tuition Details (Left) and Payment Summary (Right) -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column: Tuition Details -->
                <div class="lg:col-span-2 space-y-6">


                    <!-- Unpaid Tuition -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200 bg-red-50">
                            <button onclick="toggleSection('unpaid')" class="w-full flex items-center justify-between text-left">
                                <h3 class="text-lg font-semibold text-red-800 flex items-center">
                                    ‚ö†Ô∏è <span data-en="Unpaid Tuition" data-vi="H·ªçc Ph√≠ C·∫ßn ƒê√≥ng" class="ml-2">Unpaid Tuition</span>
                                    <span id="unpaidCount" class="ml-2 px-2 py-1 bg-red-200 text-red-800 text-sm rounded-full">0</span>
                                </h3>
                                <svg id="unpaidChevron" class="w-5 h-5 text-red-600 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="unpaidSection" class="p-6">
                            <div id="unpaidList" class="space-y-4">
                                <!-- Unpaid items will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Processing Tuition -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200 bg-yellow-50">
                            <button onclick="toggleSection('processing')" class="w-full flex items-center justify-between text-left">
                                <h3 class="text-lg font-semibold text-yellow-800 flex items-center">
                                    ‚è≥ <span data-en="Processing Payments" data-vi="Thanh To√°n ƒêang X·ª≠ L√Ω" class="ml-2">Processing Payments</span>
                                    <span id="processingCount" class="ml-2 px-2 py-1 bg-yellow-200 text-yellow-800 text-sm rounded-full">0</span>
                                </h3>
                                <svg id="processingChevron" class="w-5 h-5 text-yellow-600 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="processingSection" class="p-6">
                            <div id="processingList" class="space-y-4">
                                <!-- Processing items will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Paid Tuition -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200 bg-green-50">
                            <button onclick="toggleSection('paid')" class="w-full flex items-center justify-between text-left">
                                <h3 class="text-lg font-semibold text-green-800 flex items-center">
                                    ‚úÖ <span data-en="Paid Tuition" data-vi="H·ªçc Ph√≠ ƒê√£ ƒê√≥ng" class="ml-2">Paid Tuition</span>
                                    <span id="paidCount" class="ml-2 px-2 py-1 bg-green-200 text-green-800 text-sm rounded-full">0</span>
                                </h3>
                                <svg id="paidChevron" class="w-5 h-5 text-green-600 transform transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="paidSection" class="p-6 hidden">
                            <div id="paidList" class="space-y-4">
                                <!-- Paid items will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Payment Summary -->
                <div class="lg:col-span-1">
                    <div class="bg-white border border-gray-200 rounded-lg p-6 sticky top-4">
                        <h5 class="font-semibold text-gray-900 mb-4"><span data-en="Payment Summary" data-vi="T√≥m T·∫Øt H·ªçc Ph√≠ C·∫ßn ƒê√≥ng">Payment Summary</span></h5>
                        
                        <div class="space-y-4">
                            <div class="flex justify-between items-center py-2">
                                <span class="text-gray-600"><span data-en="Total Outstanding" data-vi="T·ªïng C·∫ßn ƒê√≥ng">Total Outstanding</span>:</span>
                                <span id="totalOutstandingAmount" class="font-bold text-red-600 text-lg">0 VND</span>
                            </div>
                        </div>
                        
                        <button id="payTuitionBtn" onclick="showPaymentInstructions()" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                            üí≥ <span data-en="Pay Tuition" data-vi="ƒê√≥ng H·ªçc Ph√≠" class="ml-2">Pay Tuition</span>
                        </button>
                        
                        <p class="text-xs text-blue-600 mt-2 text-center cursor-pointer hover:underline" onclick="showPaymentInstructions()">
                            <span data-en="Please click here for instructions" data-vi="Vui l√≤ng nh·∫•p v√†o ƒë√¢y ƒë·ªÉ xem h∆∞·ªõng d·∫´n">Please click here for instructions</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Instructions Modal -->
        <div id="paymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[95vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            üí≥ <span data-en="Payment Instructions" data-vi="H∆∞·ªõng D·∫´n ƒê√≥ng H·ªçc Ph√≠" class="ml-2">Payment Instructions</span>
                        </h3>
                        <button onclick="closePaymentModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <!-- Payment Amount - Full Width -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h4 class="font-semibold text-blue-900 mb-2" data-en="Total Amount to Pay" data-vi="T·ªïng H·ªçc Ph√≠ C·∫ßn ƒê√≥ng">Total Amount to Pay</h4>
                        <p id="modalPaymentAmount" class="text-2xl font-bold text-blue-700">0 VND</p>
                    </div>

                    <!-- Two Column Layout -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Left Column: Bank Details & Reference -->
                        <div class="space-y-6">
                            <!-- Bank Transfer Details -->
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                                    üè¶ <span data-en="Bank Transfer Details" data-vi="Th√¥ng Tin Chuy·ªÉn Kho·∫£n" class="ml-2">Bank Transfer Details</span>
                                </h4>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600" data-en="Bank Name:" data-vi="T√™n Ng√¢n H√†ng:">Bank Name:</span>
                                        <span class="font-medium">Techcombank</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600" data-en="Account Number:" data-vi="S·ªë T√†i Kho·∫£n:">Account Number:</span>
                                        <span class="font-medium font-mono">5141 4131 319</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600" data-en="Account Name:" data-vi="T√™n T√†i Kho·∫£n:">Account Name:</span>
                                        <span class="font-medium">HOANG THANH TUNG</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Reference -->
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <h4 class="font-semibold text-yellow-900 mb-2 flex items-center">
                                    üìù <span data-en="Payment Reference" data-vi="N·ªôi Dung Chuy·ªÉn Kho·∫£n" class="ml-2">Payment Reference</span>
                                </h4>
                                <p class="text-sm text-yellow-800 mb-2" data-en="Please include this exact reference in your transfer:" data-vi="Vui l√≤ng ghi ch√≠nh x√°c n·ªôi dung n√†y khi chuy·ªÉn kho·∫£n:">Please include this exact reference in your transfer:</p>
                                <div class="bg-white border border-yellow-300 rounded p-3">
                                    <code id="paymentReference" class="text-sm font-mono text-gray-900 break-all">TUITION-[STUDENT_ID]-[DATE]</code>
                                </div>
                            </div>

                            <!-- Payment Confirmation -->
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                <h4 class="font-semibold text-orange-900 mb-3 flex items-center">
                                    ‚úÖ <span data-en="Payment Confirmation" data-vi="X√°c Nh·∫≠n Thanh To√°n" class="ml-2">Payment Confirmation</span>
                                </h4>
                                <p class="text-sm text-orange-800 mb-4" data-en="Please confirm you have completed the transaction. Our accountants will check and update the payment status in 5-10 days maximum." data-vi="Vui l√≤ng x√°c nh·∫≠n b·∫°n ƒë√£ ho√†n th√†nh giao d·ªãch. K·∫ø to√°n s·∫Ω ki·ªÉm tra v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n trong t·ªëi ƒëa 5-10 ng√†y.">Please confirm you have completed the transaction. Our accountants will check and update the payment status in 5-10 days maximum.</p>
                                <button onclick="confirmPayment()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                    <span data-en="I confirm that I have completed the transaction" data-vi="T√¥i x√°c nh·∫≠n ƒë√£ ho√†n th√†nh giao d·ªãch">I confirm that I have completed the transaction</span>
                                </button>
                            </div>
                        </div>

                        <!-- Right Column: QR Code -->
                        <div class="flex flex-col">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center flex-1 flex flex-col">
                                <h4 class="font-semibold text-green-900 mb-3 flex items-center justify-center">
                                    üì± <span data-en="QR Code Payment" data-vi="Thanh To√°n QR Code" class="ml-2">QR Code Payment</span>
                                </h4>
                                <div class="bg-white border-2 border-green-300 rounded-lg p-4 mb-3 relative flex-1 flex items-center justify-center min-h-[300px]">
                                    <!-- Loading State -->
                                    <div id="qrCodeLoading" class="flex flex-col items-center justify-center">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mb-2"></div>
                                        <p class="text-sm text-gray-600" data-en="Generating QR Code..." data-vi="ƒêang t·∫°o m√£ QR...">Generating QR Code...</p>
                                    </div>
                                    <!-- QR Code Image -->
                                    <img id="qrCodeImage" class="max-w-full h-auto max-h-[280px]" style="display: none;" alt="VietQR Payment Code" />
                                </div>
                                <p class="text-xs text-green-700" data-en="This is a one-time code. Please do NOT reuse it in the future." data-vi="ƒê√¢y l√† m√£ m·ªôt l·∫ßn. Vui l√≤ng KH√îNG s·ª≠ d·ª•ng l·∫°i trong t∆∞∆°ng lai.">This is a one-time code. Please do NOT reuse it in the future.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="p-6 border-t border-gray-200 bg-gray-50">
                    <button onclick="closePaymentModal()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                        <span data-en="Close" data-vi="ƒê√≥ng">Close</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDdx6QyXzCWz7BRZInLu16LGnYBKvFO1CM",
            authDomain: "tnl-management-app.firebaseapp.com",
            projectId: "tnl-management-app",
            storageBucket: "tnl-management-app.firebasestorage.app",
            messagingSenderId: "710843379828",
            appId: "1:710843379828:web:76978490616ebe41bf2121",
            measurementId: "G-8W29VX7WTP"
        };

        // Language Management
        let currentLanguage = 'vi';
        let studentData = null;
        let tuitionData = [];

        // Initialize Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        } catch (error) {
            console.error('Firebase initialization error:', error);
            showError();
        }

        function switchLanguage(lang) {
            currentLanguage = lang;
            
            // Update button states
            document.getElementById('langEn').className = lang === 'en' 
                ? 'px-3 py-1 text-sm font-medium rounded-md bg-blue-600 text-white transition-all'
                : 'px-3 py-1 text-sm font-medium rounded-md text-gray-600 hover:bg-white transition-all';
            
            document.getElementById('langVi').className = lang === 'vi' 
                ? 'px-3 py-1 text-sm font-medium rounded-md bg-blue-600 text-white transition-all'
                : 'px-3 py-1 text-sm font-medium rounded-md text-gray-600 hover:bg-white transition-all';
            
            // Update all text elements
            document.querySelectorAll('[data-en]').forEach(element => {
                element.textContent = element.getAttribute(`data-${lang}`);
            });

            // Update student subtitle if data is loaded
            if (studentData) {
                updateStudentSubtitle();
            }

            // Re-render tuition data with new language
            if (tuitionData.length > 0) {
                displayTuitionData();
            }
        }

        // Get student ID from URL
        function getStudentIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Load student data
        async function loadStudentData(studentDocId) {
            try {
                console.log('Loading student document with ID:', studentDocId);
                
                // Update loading message
                const loadingText = document.querySelector('#loadingState p');
                if (loadingText) {
                    loadingText.textContent = currentLanguage === 'en' 
                        ? 'Loading student information...' 
                        : 'ƒêang t·∫£i th√¥ng tin h·ªçc sinh...';
                }
                
                const studentDoc = await db.collection('students').doc(studentDocId).get();
                
                if (!studentDoc.exists) {
                    console.log('Student document not found:', studentDocId);
                    showError();
                    return;
                }

                studentData = { id: studentDoc.id, ...studentDoc.data() };
                console.log('Student data loaded:', studentData);
                
                // Get the real student ID from the student document
                const realStudentId = studentData.studentId;
                console.log('Real student ID extracted:', realStudentId);
                
                if (!realStudentId) {
                    console.error('No studentId field found in student document');
                    showError();
                    return;
                }
                
                displayStudentInfo();
                
                // Update loading message for tuition data
                if (loadingText) {
                    loadingText.textContent = currentLanguage === 'en' 
                        ? 'Loading tuition data...' 
                        : 'ƒêang t·∫£i d·ªØ li·ªáu h·ªçc ph√≠...';
                }
                
                // Load tuition data using the real student ID
                await loadTuitionData(realStudentId);
                
            } catch (error) {
                console.error('Error loading student data:', error);
                showError();
            }
        }

        // Load tuition data - Optimized version
        async function loadTuitionData(realStudentId) {
            try {
                tuitionData = [];
                
                // Optimized: Try most common collections first and use Promise.all for parallel loading
                const primaryCollections = [
                    { name: 'tuition', type: 'tuition', field: 'studentId' },
                    { name: 'extraFees', type: 'extraFee', field: 'studentId' }
                ];
                
                // Load primary collections in parallel
                const primaryPromises = primaryCollections.map(async (collection) => {
                    try {
                        const snapshot = await db.collection(collection.name)
                            .where(collection.field, '==', realStudentId)
                            .limit(50) // Add limit to prevent excessive data loading
                            .get();
                        
                        return { collection, snapshot };
                    } catch (error) {
                        console.log(`Failed to load from ${collection.name}:`, error);
                        return { collection, snapshot: null };
                    }
                });
                
                const primaryResults = await Promise.all(primaryPromises);
                let foundData = false;
                
                // Process primary results
                for (const { collection, snapshot } of primaryResults) {
                    if (snapshot && snapshot.size > 0) {
                        foundData = true;
                        snapshot.forEach(doc => {
                            const tuitionRecord = processTuitionDocument(doc, collection);
                            if (tuitionRecord) {
                                tuitionData.push(tuitionRecord);
                            }
                        });
                    }
                }
                
                // If no data found in primary collections, try fallback collections
                if (!foundData) {
                    const fallbackCollections = [
                        { name: 'tuitions', type: 'tuition' },
                        { name: 'fees', type: 'tuition' },
                        { name: 'payments', type: 'tuition' },
                        { name: 'extra_fees', type: 'extraFee' },
                        { name: 'additionalFees', type: 'extraFee' }
                    ];
                    
                    const fallbackFields = ['studentId', 'student_id', 'id', 'userId', 'user_id'];
                    
                    for (const collection of fallbackCollections) {
                        for (const field of fallbackFields) {
                            try {
                                const snapshot = await db.collection(collection.name)
                                    .where(field, '==', realStudentId)
                                    .limit(20)
                                    .get();
                                
                                if (snapshot.size > 0) {
                                    snapshot.forEach(doc => {
                                        const tuitionRecord = processTuitionDocument(doc, { ...collection, field });
                                        if (tuitionRecord) {
                                            tuitionData.push(tuitionRecord);
                                        }
                                    });
                                    foundData = true;
                                    break;
                                }
                            } catch (error) {
                                continue;
                            }
                        }
                        if (foundData) break;
                    }
                }

                displayTuitionData();
                showMainContent();
                
            } catch (error) {
                console.error('Error loading tuition data:', error);
                displayTuitionData();
                showMainContent();
            }
        }
        
        // Helper function to process tuition documents
        function processTuitionDocument(doc, collection) {
            const data = doc.data();
            
            // Try to extract amount from various possible fields
            const amountFields = ['finalFee', 'amount', 'fee', 'tuitionFee', 'cost', 'price'];
            let amount = 0;
            
            for (const field of amountFields) {
                if (data[field] && data[field] > 0) {
                    amount = data[field];
                    break;
                }
            }
            
            // Skip records with no amount
            if (amount === 0) return null;
            
            // Try to extract description from various fields
            let description = '';
            if (collection.type === 'tuition') {
                if (data.month && data.year) {
                    description = currentLanguage === 'vi' 
                        ? `H·ªçc ph√≠ th√°ng ${data.month}-${data.year}`
                        : `${data.month} ${data.year} Tuition`;
                } else {
                    description = data.description || data.title || data.name || 
                        (currentLanguage === 'vi' ? 'H·ªçc ph√≠ h√†ng th√°ng' : 'Monthly Tuition');
                }
            } else {
                description = data.feeTypeName || data.description || data.title || data.name || data.type || 
                    (currentLanguage === 'vi' ? 'Ph√≠ ph·ª•' : 'Extra Fee');
            }
            
            // Determine payment status
            let status = 'unpaid';
            const isPaid = data.paid === true || data.paid === 'true' || data.paid === 1 || data.status === 'paid';
            const isProcessed = data.processed === true || data.processed === 'true' || data.processed === 1 || data.status === 'processed' || data.status === 'processing';
            
            if (isPaid && isProcessed) {
                status = 'paid';
            } else if (isPaid || isProcessed) {
                status = 'processing';
            }
            
            return {
                id: doc.id,
                type: collection.type,
                month: data.month || 'N/A',
                year: data.year || new Date().getFullYear(),
                amount: parseFloat(amount) || 0,
                status: status,
                paymentDate: (status === 'paid' || status === 'processing') && data.paymentDate ? parseFirebaseDate(data.paymentDate) : null,
                description: description,
                studentId: data[collection.field || 'studentId'],
                collectionName: collection.name
            };
        }



        // Display student information
        function displayStudentInfo() {
            document.getElementById('studentId').textContent = studentData.studentId || 'N/A';
            document.getElementById('studentName').textContent = studentData.fullName || studentData.name || 'Unknown Student';
            document.getElementById('studentClass').textContent = studentData.classAssignment || studentData.class || 'N/A';
            
            // Update status
            const statusElement = document.getElementById('studentStatus');
            const status = studentData.status || 'active';
            statusElement.textContent = getStatusText(status);
            statusElement.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium ${getStatusColor(status)}`;
            
            updateStudentSubtitle();
        }

        function updateStudentSubtitle() {
            const subtitle = document.getElementById('studentNameSubtitle');
            const studentName = studentData.fullName || studentData.name || 'Unknown Student';
            subtitle.textContent = currentLanguage === 'en' 
                ? `Tuition information for ${studentName}`
                : `Th√¥ng tin h·ªçc ph√≠ c·ªßa ${studentName}`;
        }

        // Display tuition data
        function displayTuitionData() {
            // Update descriptions based on current language
            tuitionData.forEach(item => {
                if (item.type === 'tuition' && item.month && item.year && item.month !== 'N/A') {
                    item.description = currentLanguage === 'vi' 
                        ? `H·ªçc ph√≠ th√°ng ${item.month}-${item.year}`
                        : `${item.month} ${item.year} Tuition`;
                }
            });

            const unpaidItems = tuitionData.filter(item => item.status === 'unpaid');
            const processingItems = tuitionData.filter(item => item.status === 'processing');
            const paidItems = tuitionData.filter(item => item.status === 'paid');

            // Update counts
            document.getElementById('unpaidCount').textContent = unpaidItems.length;
            document.getElementById('processingCount').textContent = processingItems.length;
            document.getElementById('paidCount').textContent = paidItems.length;

            // Update payment summary
            const totalUnpaid = unpaidItems.reduce((sum, item) => sum + (item.amount || 0), 0);
            const totalProcessing = processingItems.reduce((sum, item) => sum + (item.amount || 0), 0);
            const totalOutstanding = totalUnpaid + totalProcessing;
            document.getElementById('totalOutstandingAmount').textContent = formatCurrency(totalOutstanding);

            // Render lists
            renderTuitionList('unpaidList', unpaidItems, 'unpaid');
            renderTuitionList('processingList', processingItems, 'processing');
            renderTuitionList('paidList', paidItems, 'paid');
        }

        // VietQR Generation Function
        function generateVietQR(amount, content) {
            const img = document.getElementById('qrCodeImage');
            const loading = document.getElementById('qrCodeLoading');
            if (!img || !loading) return;
            
            loading.style.display = 'flex';
            img.style.display = 'none';
            
            const bankId = '970407'; // Techcombank
            const accountNo = '51414131319';
            const template = 'compact';
            const url = `https://img.vietqr.io/image/${bankId}-${accountNo}-${template}.png?amount=${amount}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent('HOANG THANH TUNG')}`;
            
            img.onload = () => {
                loading.style.display = 'none';
                img.style.display = 'block';
            };
            
            img.onerror = () => {
                loading.innerHTML = `
                    <div class="text-center text-red-500">
                        <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0
                                    2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732
                                    0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                        <p class="text-sm" data-en="QR generation failed" data-vi="T·∫°o m√£ QR th·∫•t b·∫°i">QR generation failed</p>
                        <p class="text-xs" data-en="Use manual transfer" data-vi="S·ª≠ d·ª•ng chuy·ªÉn kho·∫£n th·ªß c√¥ng">Use manual transfer</p>
                    </div>
                `;
            };
            
            img.src = url;
        }

        // Payment Modal Functions
        function showPaymentInstructions() {
            const modal = document.getElementById('paymentModal');
            const totalUnpaid = tuitionData.filter(item => item.status === 'unpaid').reduce((sum, item) => sum + (item.amount || 0), 0);
            const totalProcessing = tuitionData.filter(item => item.status === 'processing').reduce((sum, item) => sum + (item.amount || 0), 0);
            const totalOutstanding = totalUnpaid + totalProcessing;
            
            // Update modal content
            document.getElementById('modalPaymentAmount').textContent = formatCurrency(totalOutstanding);
            
            // Generate payment reference
            const today = new Date();
            const currentMonth = String(today.getMonth() + 1).padStart(2, '0');
            const currentYear = today.getFullYear();
            const studentName = studentData ? (studentData.fullName || studentData.name || 'UNKNOWN') : 'UNKNOWN';
            const studentDob = studentData ? (studentData.dateOfBirth || studentData.dob || '01-01-2000') : '01-01-2000';
            
            // Format DOB to dd-mm-yyyy if it's in different format
            let formattedDob = studentDob;
            if (studentDob.includes('/')) {
                const parts = studentDob.split('/');
                if (parts.length === 3) {
                    // Handle both dd/mm/yyyy and mm/dd/yyyy formats
                    if (parts[2].length === 4) {
                        // Assume dd/mm/yyyy format
                        formattedDob = `${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}-${parts[2]}`;
                    } else {
                        // Assume mm/dd/yyyy format, convert to dd-mm-yyyy
                        formattedDob = `${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}-${parts[2]}`;
                    }
                }
            } else if (studentDob.includes('-')) {
                const parts = studentDob.split('-');
                if (parts.length === 3) {
                    // Check if it's yyyy-mm-dd format
                    if (parts[0].length === 4) {
                        formattedDob = `${parts[2].padStart(2, '0')}-${parts[1].padStart(2, '0')}-${parts[0]}`;
                    } else {
                        // Already in dd-mm-yyyy format
                        formattedDob = `${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}-${parts[2]}`;
                    }
                }
            }
            
            const paymentRef = `${studentName} - ${formattedDob} - ${currentMonth}-${currentYear}`;
            document.getElementById('paymentReference').textContent = paymentRef;
            
            // Generate VietQR code
            generateVietQR(totalOutstanding, paymentRef);
            
            // Show modal
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        async function confirmPayment() {
            try {
                // Show loading state
                const confirmBtn = document.querySelector('[onclick="confirmPayment()"]');
                const originalText = confirmBtn.innerHTML;
                confirmBtn.innerHTML = currentLanguage === 'en' 
                    ? '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white inline-block mr-2"></div>Processing...'
                    : '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white inline-block mr-2"></div>ƒêang x·ª≠ l√Ω...';
                confirmBtn.disabled = true;
                
                // Get all unpaid tuition items
                const unpaidItems = tuitionData.filter(item => item.status === 'unpaid');
                
                if (unpaidItems.length === 0) {
                    alert(currentLanguage === 'en' 
                        ? 'No unpaid tuition found to confirm.'
                        : 'Kh√¥ng c√≥ h·ªçc ph√≠ ch∆∞a thanh to√°n ƒë·ªÉ x√°c nh·∫≠n.');
                    return;
                }
                
                // Update each unpaid item to processing status
                const updatePromises = unpaidItems.map(async (item) => {
                    try {
                        const updateData = {
                            paid: true,
                            processed: false,
                            status: 'processing',
                            paymentDate: new Date(),
                            paymentConfirmedAt: new Date(),
                            paymentConfirmedBy: 'student'
                        };
                        
                        await db.collection(item.collectionName || 'tuition')
                            .doc(item.id)
                            .update(updateData);
                        
                        // Update local data
                        const localItem = tuitionData.find(t => t.id === item.id);
                        if (localItem) {
                            localItem.status = 'processing';
                            localItem.paymentDate = new Date().toISOString().split('T')[0];
                        }
                        
                        return { success: true, id: item.id };
                    } catch (error) {
                        console.error(`Failed to update tuition ${item.id}:`, error);
                        return { success: false, id: item.id, error };
                    }
                });
                
                const results = await Promise.all(updatePromises);
                const successful = results.filter(r => r.success).length;
                const failed = results.filter(r => !r.success).length;
                
                if (successful > 0) {
                    // Refresh the display
                    displayTuitionData();
                    
                    // Show success message
                    const message = currentLanguage === 'en' 
                        ? `Payment confirmed successfully! ${successful} tuition(s) moved to processing. ${failed > 0 ? `${failed} failed to update.` : 'We will verify and update the status within 5-10 days.'}`
                        : `X√°c nh·∫≠n thanh to√°n th√†nh c√¥ng! ${successful} h·ªçc ph√≠ ƒë√£ chuy·ªÉn sang ƒëang x·ª≠ l√Ω. ${failed > 0 ? `${failed} kh√¥ng c·∫≠p nh·∫≠t ƒë∆∞·ª£c.` : 'Ch√∫ng t√¥i s·∫Ω ki·ªÉm tra v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i trong v√≤ng 5-10 ng√†y.'}`;
                    
                    alert(message);
                    closePaymentModal();
                } else {
                    alert(currentLanguage === 'en' 
                        ? 'Failed to confirm payment. Please try again or contact support.'
                        : 'Kh√¥ng th·ªÉ x√°c nh·∫≠n thanh to√°n. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá h·ªó tr·ª£.');
                }
                
            } catch (error) {
                console.error('Error confirming payment:', error);
                alert(currentLanguage === 'en' 
                    ? 'An error occurred while confirming payment. Please try again.'
                    : 'C√≥ l·ªói x·∫£y ra khi x√°c nh·∫≠n thanh to√°n. Vui l√≤ng th·ª≠ l·∫°i.');
            } finally {
                // Restore button state
                const confirmBtn = document.querySelector('[onclick="confirmPayment()"]');
                if (confirmBtn) {
                    confirmBtn.innerHTML = currentLanguage === 'en' 
                        ? 'I confirm that I have completed the transaction'
                        : 'T√¥i x√°c nh·∫≠n ƒë√£ ho√†n th√†nh giao d·ªãch';
                    confirmBtn.disabled = false;
                }
            }
        }

        // Close modal when clicking outside
        document.getElementById('paymentModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePaymentModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePaymentModal();
            }
        });

        // Render tuition list
        function renderTuitionList(containerId, items, status) {
            const container = document.getElementById(containerId);
            
            if (items.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üìã</div>
                        <p data-en="No ${status} tuition found" data-vi="Kh√¥ng c√≥ h·ªçc ph√≠ ${status}">No ${status} tuition found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = items.map(item => `
                <div class="border border-gray-200 rounded-lg p-4 ${getItemBorderColor(status)}">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-semibold text-gray-900">${item.description || 'Tuition Payment'}</h4>
                        <span class="text-lg font-bold ${getAmountColor(status)}">${formatCurrency(item.amount || 0)}</span>
                    </div>
                    ${item.paymentDate ? `
                    <div class="text-sm text-gray-600 mt-2">
                        <span class="font-medium" data-en="Payment Date:" data-vi="Ng√†y thanh to√°n:">Payment Date:</span>
                        <span class="ml-1">${formatDate(item.paymentDate)}</span>
                    </div>
                    ` : ''}
                    ${item.notes ? `
                    <div class="mt-2 text-sm text-gray-600">
                        <span class="font-medium" data-en="Notes:" data-vi="Ghi ch√∫:">Notes:</span>
                        <span class="ml-1">${item.notes}</span>
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Helper functions
        function getStatusColor(status) {
            switch(status) {
                case 'active': return 'bg-green-100 text-green-800';
                case 'inactive': return 'bg-yellow-100 text-yellow-800';
                case 'finished': return 'bg-purple-100 text-purple-800';
                case 'dropped': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'active': currentLanguage === 'en' ? 'Active' : 'ƒêang theo h·ªçc',
                'inactive': currentLanguage === 'en' ? 'Inactive' : 'Kh√¥ng ho·∫°t ƒë·ªông',
                'finished': currentLanguage === 'en' ? 'Finished' : 'Ho√†n th√†nh',
                'dropped': currentLanguage === 'en' ? 'Dropped' : 'ƒê√£ b·ªè h·ªçc'
            };
            return statusMap[status] || status;
        }

        function getItemBorderColor(status) {
            switch(status) {
                case 'unpaid': return 'border-l-4 border-l-red-500';
                case 'processing': return 'border-l-4 border-l-yellow-500';
                case 'paid': return 'border-l-4 border-l-green-500';
                default: return '';
            }
        }

        function getAmountColor(status) {
            switch(status) {
                case 'unpaid': return 'text-red-600';
                case 'processing': return 'text-yellow-600';
                case 'paid': return 'text-green-600';
                default: return 'text-gray-600';
            }
        }

        function getTypeText(type) {
            const typeMap = {
                'tuition': currentLanguage === 'en' ? 'Monthly Tuition' : 'H·ªçc ph√≠ h√†ng th√°ng',
                'extraFee': currentLanguage === 'en' ? 'Extra Fee' : 'Ph√≠ ph·ª•',
                'monthly': currentLanguage === 'en' ? 'Monthly Tuition' : 'H·ªçc ph√≠ h√†ng th√°ng',
                'fee': currentLanguage === 'en' ? 'Fee' : 'Ph√≠',
                'registration': currentLanguage === 'en' ? 'Registration' : 'ƒêƒÉng k√Ω',
                'textbook': currentLanguage === 'en' ? 'Textbook' : 'S√°ch gi√°o khoa'
            };
            return typeMap[type] || type;
        }

        // Parse Firebase date (handles both Timestamp and string formats)
        function parseFirebaseDate(dateValue) {
            if (!dateValue) return null;
            
            // If it's a Firebase Timestamp
            if (dateValue && typeof dateValue.toDate === 'function') {
                return dateValue.toDate().toISOString().split('T')[0];
            }
            
            // If it's already a string
            if (typeof dateValue === 'string') {
                return dateValue;
            }
            
            // If it's a Date object
            if (dateValue instanceof Date) {
                return dateValue.toISOString().split('T')[0];
            }
            
            return null;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'vi-VN');
        }

        // Toggle section visibility
        function toggleSection(sectionName) {
            const section = document.getElementById(`${sectionName}Section`);
            const chevron = document.getElementById(`${sectionName}Chevron`);
            
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                chevron.classList.add('rotate-180');
            } else {
                section.classList.add('hidden');
                chevron.classList.remove('rotate-180');
            }
        }

        // Show/hide states
        function showMainContent() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
        }

        function showError() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
        }

	function getStudentIdFromUrl() {
	    const urlParams = new URLSearchParams(window.location.search);
 	   return urlParams.get('id');
	}
        
	// Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set Vietnamese as default language on page load
            switchLanguage('vi');
            
            const studentId = getStudentIdFromUrl();
            
            if (!studentId) {
                showError();
                return;
            }

            if (db) {
                loadStudentData(studentId);
            } else {
                showError();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97a4e17e47963e83',t:'MTc1NzA2NjQ0MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
