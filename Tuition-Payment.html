<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.5, maximum-scale=3.0">
    <title>Student Tuition Information</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        .tab-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .tab-content.expanded {
            max-height: 400px;
            overflow-y: auto;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-lg">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800 leading-tight">
                        <span id="header-title-line1">Th√¥ng tin</span><br class="md:hidden">
                        <span id="header-title-line2"> h·ªçc ph√≠</span>
                    </h1>
                </div>
                <button id="language-toggle" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors duration-200 ml-4">
                    <span id="english-text" class="cursor-pointer hover:underline">English</span>
                    <span class="mx-1">|</span>
                    <span id="vietnamese-text" class="cursor-pointer hover:underline font-bold">Ti·∫øng Vi·ªát</span>
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 py-6 space-y-6">
        <!-- Student Info Banner -->
        <div class="bg-white rounded-xl shadow-md p-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                <div>
                    <span class="text-gray-600 font-medium" id="student-id-label">M√£ h·ªçc sinh:</span>
                    <div class="text-gray-800 font-semibold" id="student-id">Loading...</div>
                </div>
                <div>
                    <span class="text-gray-600 font-medium" id="full-name-label">H·ªç v√† t√™n:</span>
                    <div class="text-gray-800 font-semibold" id="student-name">Loading...</div>
                </div>
                <div>
                    <span class="text-gray-600 font-medium" id="class-label">L·ªõp:</span>
                    <div class="text-gray-800 font-semibold" id="student-class">Loading...</div>
                </div>
                <div>
                    <span class="text-gray-600 font-medium" id="status-label">Tr·∫°ng th√°i:</span>
                    <div class="text-green-600 font-semibold" id="student-status">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Mobile Layout: Payment Summary First -->
        <div class="block md:hidden space-y-6">
            <!-- Payment Summary (Mobile) -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4" id="payment-summary-title">T√≥m t·∫Øt h·ªçc ph√≠ c·∫ßn ƒë√≥ng</h2>
                <div class="space-y-4">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="text-sm text-red-600 font-medium" id="total-outstanding-label">T·ªïng c·∫ßn ƒë√≥ng</div>
                        <div class="text-2xl font-bold text-red-700" id="total-amount">Loading...</div>
                    </div>
                    <button id="pay-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2">
                        <span>üí≥</span>
                        <span id="pay-button-text">ƒê√≥ng h·ªçc ph√≠</span>
                    </button>
                    <p class="text-sm text-gray-600 text-center" id="instructions-note">Vui l√≤ng nh·∫•p v√†o ƒë√¢y ƒë·ªÉ xem h∆∞·ªõng d·∫´n</p>
                </div>
            </div>

            <!-- Tuition Tabs (Mobile) -->
            <div class="space-y-4">
                <!-- Unpaid Tuition Tab -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <button class="w-full p-4 text-left flex justify-between items-center bg-red-50 hover:bg-red-100 transition-colors duration-200" onclick="toggleTab('unpaid')">
                        <div class="flex items-center space-x-3">
                            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                            <span class="font-semibold text-red-700" id="unpaid-tab-title">H·ªçc ph√≠ c·∫ßn ƒë√≥ng</span>
                        </div>
                        <svg id="unpaid-arrow" class="w-5 h-5 text-red-500 transition-transform duration-200 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="unpaid-content" class="tab-content expanded">
                        <div class="p-4 space-y-3" id="unpaid-tuition-list">
                            <div class="text-center text-gray-500 py-4">
                                <div class="text-sm">Loading tuition data...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Processing Payments Tab -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <button class="w-full p-4 text-left flex justify-between items-center bg-yellow-50 hover:bg-yellow-100 transition-colors duration-200" onclick="toggleTab('processing')">
                        <div class="flex items-center space-x-3">
                            <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                            <span class="font-semibold text-yellow-700" id="processing-tab-title">Thanh to√°n ƒëang x·ª≠ l√Ω</span>
                        </div>
                        <svg id="processing-arrow" class="w-5 h-5 text-yellow-500 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="processing-content" class="tab-content">
                        <div class="p-4 space-y-3" id="processing-tuition-list">
                            <div class="text-center text-gray-500 py-4">
                                <div class="text-sm">Loading processing payments...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Paid Tuition Tab -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <button class="w-full p-4 text-left flex justify-between items-center bg-green-50 hover:bg-green-100 transition-colors duration-200" onclick="toggleTab('paid')">
                        <div class="flex items-center space-x-3">
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            <span class="font-semibold text-green-700" id="paid-tab-title">H·ªçc ph√≠ ƒë√£ ho√†n th√†nh</span>
                        </div>
                        <svg id="paid-arrow" class="w-5 h-5 text-green-500 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="paid-content" class="tab-content">
                        <div class="p-4 space-y-3" id="paid-tuition-list">
                            <div class="text-center text-gray-500 py-4">
                                <div class="text-sm">Loading paid tuition history...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Desktop Layout: Side by Side -->
        <div class="hidden md:grid md:grid-cols-2 gap-6">
            <!-- Payment Summary (Desktop) -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4" id="payment-summary-title-desktop">T√≥m t·∫Øt h·ªçc ph√≠ c·∫ßn ƒë√≥ng</h2>
                <div class="space-y-4">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="text-sm text-red-600 font-medium" id="total-outstanding-label-desktop">T·ªïng c·∫ßn ƒë√≥ng</div>
                        <div class="text-2xl font-bold text-red-700" id="total-amount-desktop">Loading...</div>
                    </div>
                    <button id="pay-button-desktop" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2">
                        <span>üí≥</span>
                        <span id="pay-button-text-desktop">ƒê√≥ng h·ªçc ph√≠</span>
                    </button>
                    <p class="text-sm text-gray-600 text-center" id="instructions-note-desktop">Vui l√≤ng nh·∫•p v√†o ƒë√¢y ƒë·ªÉ xem h∆∞·ªõng d·∫´n</p>
                </div>
            </div>

            <!-- Tuition Information (Desktop) -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold text-gray-800" id="tuition-info-title">Th√¥ng tin h·ªçc ph√≠</h2>
                
                <!-- Desktop Tabs -->
                <div class="space-y-4">
                    <!-- Unpaid Tuition Tab (Desktop) -->
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <button class="w-full p-4 text-left flex justify-between items-center bg-red-50 hover:bg-red-100 transition-colors duration-200" onclick="toggleTab('unpaid-desktop')">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <span class="font-semibold text-red-700" id="unpaid-tab-title-desktop">H·ªçc ph√≠ c·∫ßn ƒë√≥ng</span>
                            </div>
                            <svg id="unpaid-desktop-arrow" class="w-5 h-5 text-red-500 transition-transform duration-200 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="unpaid-desktop-content" class="tab-content expanded">
                            <div class="p-4 space-y-3" id="unpaid-tuition-list-desktop">
                                <div class="text-center text-gray-500 py-4">
                                    <div class="text-sm">Loading tuition data...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Processing Payments Tab (Desktop) -->
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <button class="w-full p-4 text-left flex justify-between items-center bg-yellow-50 hover:bg-yellow-100 transition-colors duration-200" onclick="toggleTab('processing-desktop')">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                <span class="font-semibold text-yellow-700" id="processing-tab-title-desktop">Thanh to√°n ƒëang x·ª≠ l√Ω</span>
                            </div>
                            <svg id="processing-desktop-arrow" class="w-5 h-5 text-yellow-500 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="processing-desktop-content" class="tab-content">
                            <div class="p-4 space-y-3" id="processing-tuition-list-desktop">
                                <div class="text-center text-gray-500 py-4">
                                    <div class="text-sm">Loading processing payments...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Paid Tuition Tab (Desktop) -->
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <button class="w-full p-4 text-left flex justify-between items-center bg-green-50 hover:bg-green-100 transition-colors duration-200" onclick="toggleTab('paid-desktop')">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                <span class="font-semibold text-green-700" id="paid-tab-title-desktop">H·ªçc ph√≠ ƒë√£ ho√†n th√†nh</span>
                            </div>
                            <svg id="paid-desktop-arrow" class="w-5 h-5 text-green-500 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="paid-desktop-content" class="tab-content">
                            <div class="p-4 space-y-3" id="paid-tuition-list-desktop">
                                <div class="text-center text-gray-500 py-4">
                                    <div class="text-sm">Loading paid tuition history...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Instructions Modal -->
    <div id="paymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[95vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900 flex items-center">
                        üí≥ <span id="payment-instructions-title" class="ml-2">H∆∞·ªõng D·∫´n ƒê√≥ng H·ªçc Ph√≠</span>
                    </h3>
                    <button onclick="closePaymentModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <!-- Payment Amount - Full Width -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h4 class="font-semibold text-blue-900 mb-2" id="total-amount-to-pay">T·ªïng H·ªçc Ph√≠ C·∫ßn ƒê√≥ng</h4>
                    <p id="modalPaymentAmount" class="text-2xl font-bold text-blue-700">Loading...</p>
                </div>

                <!-- Mobile Layout: Stacked Sections -->
                <div class="block lg:hidden space-y-6">
                    <!-- 1. Notes Section (Mobile) -->
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 class="font-semibold text-red-800 mb-2 flex items-center">
                            ‚ö†Ô∏è <span id="payment-notes-title-mobile" class="ml-2">L∆∞u √Ω khi ƒë√≥ng h·ªçc ph√≠</span>
                        </h4>
                        <p class="text-sm text-red-700" id="payment-notes-text-mobile">Vui l√≤ng b·∫•m n√∫t "T√¥i x√°c nh·∫≠n ƒë√£ ƒë√≥ng ph√≠" ph√≠a d∆∞·ªõi sau khi ho√†n t·∫•t thanh to√°n. Ch√∫ng t√¥i s·∫Ω ch·ªâ x·ª≠ l√Ω v√† c·∫≠p nh·∫≠t ph√≠ sau khi nh·∫≠n ƒë∆∞·ª£c x√°c nh·∫≠n.</p>
                    </div>

                    <!-- 2. Bank Transfer Details (Mobile) -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-semibold text-blue-800 mb-3" id="bank-transfer-title-mobile">Th√¥ng tin chuy·ªÉn kho·∫£n</h4>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-blue-700" id="bank-name-label-mobile">T√™n ng√¢n h√†ng:</span>
                                <span class="text-blue-900 font-semibold">Techcombank</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-blue-700" id="account-number-label-mobile">S·ªë t√†i kho·∫£n:</span>
                                <div class="flex items-center space-x-2">
                                    <span class="text-blue-900 font-semibold font-mono">5141 4131 319</span>
                                    <button onclick="copyToClipboard('5141 4131 319')" class="text-blue-600 hover:text-blue-800 text-xs bg-blue-100 px-2 py-1 rounded">
                                        üìã
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-blue-700" id="account-holder-label-mobile">Ch·ªß t√†i kho·∫£n:</span>
                                <div class="flex items-center space-x-2">
                                    <span class="text-blue-900 font-semibold font-mono">HOANG THANH TUNG</span>
                                    <button onclick="copyToClipboard('HOANG THANH TUNG')" class="text-blue-600 hover:text-blue-800 text-xs bg-blue-100 px-2 py-1 rounded">
                                        üìã
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Payment Reference (Mobile) -->
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                        <h4 class="font-semibold text-purple-800 mb-2" id="payment-reference-title-mobile">N·ªôi dung chuy·ªÉn kho·∫£n</h4>
                        <p class="text-sm text-purple-700 mb-3" id="payment-reference-instruction-mobile">Vui l√≤ng ghi ch√≠nh x√°c n·ªôi dung n√†y khi chuy·ªÉn kho·∫£n:</p>
                        <div class="bg-white border border-purple-300 rounded p-3 flex items-center justify-between">
                            <div class="text-sm font-mono text-purple-900" id="payment-reference-format-mobile">Loading...</div>
                            <button onclick="copyToClipboard('')" class="text-purple-600 hover:text-purple-800 text-xs bg-purple-100 px-2 py-1 rounded ml-2">
                                üìã
                            </button>
                        </div>
                    </div>

                    <!-- 4. Payment Confirmation (Mobile) -->
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                        <h4 class="font-semibold text-orange-800 mb-2" id="payment-confirmation-title-mobile">X√°c nh·∫≠n thanh to√°n</h4>
                        <p class="text-sm text-orange-700 mb-4" id="payment-confirmation-text-mobile">Vui l√≤ng x√°c nh·∫≠n b·∫°n ƒë√£ ho√†n th√†nh giao d·ªãch. K·∫ø to√°n s·∫Ω ki·ªÉm tra v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n sau t·ªëi ƒëa 5-10 ng√†y l√†m vi·ªác.</p>
                        <button onclick="confirmPayment()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-200" id="confirm-payment-mobile">
                            ‚úÖ T√¥i x√°c nh·∫≠n ƒë√£ ho√†n th√†nh giao d·ªãch
                        </button>
                    </div>

                    <!-- 5. QR Code (Mobile) -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                        <h4 class="font-semibold text-green-900 mb-3 flex items-center justify-center">
                            üì± <span id="qr-code-payment-mobile" class="ml-2">Thanh To√°n QR Code</span>
                        </h4>
                        <div class="bg-white border-2 border-green-300 rounded-lg p-4 mb-3 relative flex items-center justify-center min-h-[300px]">
                            <!-- Loading State -->
                            <div id="qrCodeLoadingMobile" class="flex flex-col items-center justify-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mb-2"></div>
                                <p class="text-sm text-gray-600" id="generating-qr-mobile">ƒêang t·∫°o m√£ QR...</p>
                            </div>
                            <!-- QR Code Image -->
                            <img id="qrCodeImageMobile" class="max-w-full h-auto max-h-[280px]" style="display: none;" alt="VietQR Payment Code" />
                        </div>
                        <p class="text-xs text-green-700" id="qr-warning-mobile">ƒê√¢y l√† m√£ m·ªôt l·∫ßn. Vui l√≤ng KH√îNG s·ª≠ d·ª•ng l·∫°i trong t∆∞∆°ng lai.</p>
                    </div>
                </div>

                <!-- Desktop Layout: Two Column Layout -->
                <div class="hidden lg:grid lg:grid-cols-2 gap-6">
                    <!-- Left Side - Payment Information -->
                    <div class="space-y-4">
                        <!-- Notes Section -->
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h4 class="font-semibold text-red-800 mb-2 flex items-center">
                                ‚ö†Ô∏è <span id="payment-notes-title" class="ml-2">L∆∞u √Ω khi ƒë√≥ng h·ªçc ph√≠</span>
                            </h4>
                            <p class="text-sm text-red-700" id="payment-notes-text">Vui l√≤ng b·∫•m n√∫t "T√¥i x√°c nh·∫≠n ƒë√£ ƒë√≥ng ph√≠" ph√≠a d∆∞·ªõi sau khi ho√†n t·∫•t thanh to√°n. Ch√∫ng t√¥i s·∫Ω ch·ªâ x·ª≠ l√Ω v√† c·∫≠p nh·∫≠t ph√≠ sau khi nh·∫≠n ƒë∆∞·ª£c x√°c nh·∫≠n.</p>
                        </div>

                        <!-- Bank Transfer Details -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-semibold text-blue-800 mb-3" id="bank-transfer-title">Th√¥ng tin chuy·ªÉn kho·∫£n</h4>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-blue-700" id="bank-name-label">T√™n ng√¢n h√†ng:</span>
                                    <span class="text-blue-900 font-semibold">Techcombank</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-blue-700" id="account-number-label">S·ªë t√†i kho·∫£n:</span>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-blue-900 font-semibold font-mono">5141 4131 319</span>
                                        <button onclick="copyToClipboard('5141 4131 319')" class="text-blue-600 hover:text-blue-800 text-xs bg-blue-100 px-2 py-1 rounded">
                                            üìã
                                        </button>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-blue-700" id="account-holder-label">Ch·ªß t√†i kho·∫£n:</span>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-blue-900 font-semibold font-mono">HOANG THANH TUNG</span>
                                        <button onclick="copyToClipboard('HOANG THANH TUNG')" class="text-blue-600 hover:text-blue-800 text-xs bg-blue-100 px-2 py-1 rounded">
                                            üìã
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Reference -->
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <h4 class="font-semibold text-purple-800 mb-2" id="payment-reference-title">N·ªôi dung chuy·ªÉn kho·∫£n</h4>
                            <p class="text-sm text-purple-700 mb-3" id="payment-reference-instruction">Vui l√≤ng ghi ch√≠nh x√°c n·ªôi dung n√†y khi chuy·ªÉn kho·∫£n:</p>
                            <div class="bg-white border border-purple-300 rounded p-3 flex items-center justify-between">
                                <div class="text-sm font-mono text-purple-900" id="payment-reference-format">Loading...</div>
                                <button onclick="copyToClipboard('')" class="text-purple-600 hover:text-purple-800 text-xs bg-purple-100 px-2 py-1 rounded ml-2">
                                    üìã
                                </button>
                            </div>
                        </div>

                        <!-- Payment Confirmation -->
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                            <h4 class="font-semibold text-orange-800 mb-2" id="payment-confirmation-title">X√°c nh·∫≠n thanh to√°n</h4>
                            <p class="text-sm text-orange-700 mb-4" id="payment-confirmation-text">Vui l√≤ng x√°c nh·∫≠n b·∫°n ƒë√£ ho√†n th√†nh giao d·ªãch. K·∫ø to√°n s·∫Ω ki·ªÉm tra v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n sau t·ªëi ƒëa 5-10 ng√†y l√†m vi·ªác.</p>
                            <button onclick="confirmPayment()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-200" id="confirm-payment">
                                ‚úÖ T√¥i x√°c nh·∫≠n ƒë√£ ho√†n th√†nh giao d·ªãch
                            </button>
                        </div>
                    </div>

                    <!-- Right Side - QR Code -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center flex flex-col">
                        <h4 class="font-semibold text-green-900 mb-3 flex items-center justify-center">
                            üì± <span id="qr-code-payment" class="ml-2">Thanh To√°n QR Code</span>
                        </h4>
                        <div class="bg-white border-2 border-green-300 rounded-lg p-4 mb-3 relative flex-1 flex items-center justify-center min-h-[300px]">
                            <!-- Loading State -->
                            <div id="qrCodeLoading" class="flex flex-col items-center justify-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mb-2"></div>
                                <p class="text-sm text-gray-600" id="generating-qr">ƒêang t·∫°o m√£ QR...</p>
                            </div>
                            <!-- QR Code Image -->
                            <img id="qrCodeImage" class="max-w-full h-auto max-h-[280px]" style="display: none;" alt="VietQR Payment Code" />
                        </div>
                        <p class="text-xs text-green-700" id="qr-warning">ƒê√¢y l√† m√£ m·ªôt l·∫ßn. Vui l√≤ng KH√îNG s·ª≠ d·ª•ng l·∫°i trong t∆∞∆°ng lai.</p>
                    </div>
                </div>

                <!-- Close Button -->
                <div class="mt-6 flex justify-center">
                    <button onclick="closePaymentModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-lg transition-colors duration-200" id="understood-button">
                        ƒê√£ hi·ªÉu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBikDynsjPuXbFCUqfQowEwosO4tl66WOI",
            authDomain: "tnl-app-ver3.firebaseapp.com",
            projectId: "tnl-app-ver3",
            storageBucket: "tnl-app-ver3.firebasestorage.app",
            messagingSenderId: "87206246036",
            appId: "1:87206246036:web:5f96bf7e59a2a0d9a82681",
            measurementId: "G-XGP4JNMZNQ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentLanguage = 'vi'; // Default to Vietnamese
        let studentData = null;

        // Get student document ID from URL parameters
        function getStudentIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id'); // This should be the Firebase document ID
        }

        // Load student data from Firebase
        async function loadStudentData(studentDocumentId) {
            try {
                // Show loading state
                showLoadingState();

                // Get student document using the document ID
                const studentDoc = await db.collection('students').doc(studentDocumentId).get();
                
                if (!studentDoc.exists) {
                    throw new Error('Student not found');
                }

                const student = studentDoc.data();
                
                // Get class information if classRef exists
                let className = 'N/A';
                if (student.classRef) {
                    // Extract class document ID from classRef (format: "classes/documentId")
                    const classId = student.classRef.split('/')[1];
                    const classDoc = await db.collection('classes').doc(classId).get();
                    if (classDoc.exists) {
                        className = classDoc.data().name;
                    }
                }

                // Format date of birth from yyyy-mm-dd to dd-mm-yyyy
                let formattedDOB = student.dateOfBirth;
                if (student.dateOfBirth) {
                    const dateParts = student.dateOfBirth.split('-');
                    if (dateParts.length === 3) {
                        formattedDOB = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
                    }
                }

                // Store student data
                studentData = {
                    documentId: studentDocumentId, // Store the document ID for Firebase operations
                    humanId: student.humanId || 'N/A', // Use humanId for display
                    fullName: student.fullName || 'N/A',
                    className: className,
                    status: student.status || 'N/A',
                    dateOfBirth: formattedDOB,
                    enrollmentYear: student.enrollmentYear || 'N/A'
                };

                // Update UI with student data
                updateStudentInfo();
                hideLoadingState();

            } catch (error) {
                console.error('Error loading student data:', error);
                showErrorState(error.message);
            }
        }

        // Show loading state
        function showLoadingState() {
            document.getElementById('student-id').textContent = 'Loading...';
            document.getElementById('student-name').textContent = 'Loading...';
            document.getElementById('student-class').textContent = 'Loading...';
            document.getElementById('student-status').textContent = 'Loading...';
        }

        // Hide loading state
        function hideLoadingState() {
            // Loading state is automatically hidden when data is populated
        }

        // Show error state
        function showErrorState(message) {
            document.getElementById('student-id').textContent = 'Error';
            document.getElementById('student-name').textContent = message;
            document.getElementById('student-class').textContent = 'Error';
            document.getElementById('student-status').textContent = 'Error';
        }

        // Update student information in the UI
        function updateStudentInfo() {
            if (!studentData) return;

            document.getElementById('student-id').textContent = studentData.humanId;
            document.getElementById('student-name').textContent = studentData.fullName;
            document.getElementById('student-class').textContent = studentData.className;
            
            // Capitalize first letter of status
            const status = studentData.status;
            const capitalizedStatus = status ? status.charAt(0).toUpperCase() + status.slice(1).toLowerCase() : 'N/A';
            document.getElementById('student-status').textContent = capitalizedStatus;

            // Update payment reference with real student data
            const paymentReference = `${studentData.fullName} - ${studentData.dateOfBirth} - ${getCurrentMonthYear()}`;
            
            // Update all payment reference elements
            const referenceElements = [
                'payment-reference-format',
                'payment-reference-format-mobile'
            ];
            
            referenceElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = paymentReference;
                    // Update copy button functionality
                    const copyButton = element.parentElement.querySelector('button');
                    if (copyButton) {
                        copyButton.setAttribute('onclick', `copyToClipboard('${paymentReference}')`);
                    }
                }
            });

            // Load tuition data after student info is loaded
            loadTuitionData();
            
            // Set up real-time listeners for automatic updates
            setupRealtimeListeners();
        }

        // Load tuition and extra fees data
        async function loadTuitionData() {
            if (!studentData) return;

            try {
                // Load informed tuitions
                const tuitionsQuery = await db.collection('informedTuitions')
                    .where('studentId', '==', studentData.humanId)
                    .where('studentName', '==', studentData.fullName)
                    .get();

                // Load informed extra fees
                const extraFeesQuery = await db.collection('informedExtraFees')
                    .where('studentId', '==', studentData.humanId)
                    .where('studentName', '==', studentData.fullName)
                    .get();

                // Process tuition data
                const tuitions = [];
                tuitionsQuery.forEach(doc => {
                    const data = doc.data();
                    tuitions.push({
                        id: doc.id,
                        type: 'tuition',
                        amount: data.adjustedFinalFee || 0,
                        month: data.month,
                        year: data.year,
                        status: data.status,
                        name: `H·ªçc ph√≠ th√°ng ${data.month}/${data.year}`
                    });
                });

                // Process extra fees data
                const extraFees = [];
                extraFeesQuery.forEach(doc => {
                    const data = doc.data();
                    if (data.extraFees && Array.isArray(data.extraFees)) {
                        data.extraFees.forEach(fee => {
                            extraFees.push({
                                id: doc.id + '_' + fee.name,
                                type: 'extra',
                                amount: fee.amount || 0,
                                month: data.month,
                                year: data.year,
                                status: data.status,
                                name: fee.name || 'Ph√≠ b·ªï sung'
                            });
                        });
                    }
                });

                // Combine all fees
                const allFees = [...tuitions, ...extraFees];

                // Separate by status
                const unpaidFees = allFees.filter(fee => fee.status === 'informed');
                const processingFees = allFees.filter(fee => fee.status === 'processing');
                const paidFees = allFees.filter(fee => fee.status === 'paid' || fee.status === 'completed');

                // Update UI
                updateTuitionLists(unpaidFees, processingFees, paidFees);
                updateTotalAmount(unpaidFees);

            } catch (error) {
                console.error('Error loading tuition data:', error);
                showTuitionError();
            }
        }

        // Update tuition lists in UI
        function updateTuitionLists(unpaidFees, processingFees, paidFees) {
            // Update unpaid tuition lists
            updateFeeList('unpaid-tuition-list', unpaidFees, 'red');
            updateFeeList('unpaid-tuition-list-desktop', unpaidFees, 'red');

            // Update processing payment lists
            updateFeeList('processing-tuition-list', processingFees, 'yellow');
            updateFeeList('processing-tuition-list-desktop', processingFees, 'yellow');

            // Update paid tuition lists
            updateFeeList('paid-tuition-list', paidFees, 'green');
            updateFeeList('paid-tuition-list-desktop', paidFees, 'green');
        }

        // Update individual fee list
        function updateFeeList(elementId, fees, colorTheme) {
            const listElement = document.getElementById(elementId);
            if (!listElement) return;

            if (fees.length === 0) {
                listElement.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <div class="text-sm">${currentLanguage === 'vi' ? 'Kh√¥ng c√≥ d·ªØ li·ªáu' : 'No data available'}</div>
                    </div>
                `;
                return;
            }

            const colorClasses = {
                red: 'bg-red-50 border-red-200 text-red-800',
                yellow: 'bg-yellow-50 border-yellow-200 text-yellow-800',
                green: 'bg-green-50 border-green-200 text-green-800'
            };

            listElement.innerHTML = fees.map(fee => `
                <div class="border rounded-lg p-3 ${colorClasses[colorTheme]}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-medium text-sm">${fee.name}</div>
                            <div class="text-xs opacity-75 mt-1">${fee.month}/${fee.year}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold">${formatCurrency(fee.amount)}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update total amount
        function updateTotalAmount(unpaidFees) {
            const total = unpaidFees.reduce((sum, fee) => sum + fee.amount, 0);
            const formattedTotal = formatCurrency(total);

            // Update all total amount elements
            const totalElements = ['total-amount', 'total-amount-desktop', 'modalPaymentAmount'];
            totalElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = formattedTotal;
                }
            });
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Show tuition error
        function showTuitionError() {
            const errorMessage = currentLanguage === 'vi' ? 'L·ªói t·∫£i d·ªØ li·ªáu h·ªçc ph√≠' : 'Error loading tuition data';
            
            const listIds = [
                'unpaid-tuition-list', 'unpaid-tuition-list-desktop',
                'processing-tuition-list', 'processing-tuition-list-desktop',
                'paid-tuition-list', 'paid-tuition-list-desktop'
            ];

            listIds.forEach(listId => {
                const element = document.getElementById(listId);
                if (element) {
                    element.innerHTML = `
                        <div class="text-center text-red-500 py-4">
                            <div class="text-sm">${errorMessage}</div>
                        </div>
                    `;
                }
            });

            // Update total amount
            const totalElements = ['total-amount', 'total-amount-desktop', 'modalPaymentAmount'];
            totalElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = 'Error';
                }
            });
        }

        // Update tuition status from informed to processing
        async function updateTuitionStatus(fromStatus, toStatus) {
            if (!studentData) {
                throw new Error('Student data not loaded');
            }

            const batch = db.batch();

            try {
                // Update informed tuitions
                const tuitionsQuery = await db.collection('informedTuitions')
                    .where('studentId', '==', studentData.humanId)
                    .where('studentName', '==', studentData.fullName)
                    .where('status', '==', fromStatus)
                    .get();

                tuitionsQuery.forEach(doc => {
                    batch.update(doc.ref, { status: toStatus });
                });

                // Update informed extra fees
                const extraFeesQuery = await db.collection('informedExtraFees')
                    .where('studentId', '==', studentData.humanId)
                    .where('studentName', '==', studentData.fullName)
                    .where('status', '==', fromStatus)
                    .get();

                extraFeesQuery.forEach(doc => {
                    batch.update(doc.ref, { status: toStatus });
                });

                // Commit all updates
                await batch.commit();

                // Reload tuition data to reflect changes
                await loadTuitionData();

                console.log(`Successfully updated ${tuitionsQuery.size + extraFeesQuery.size} records from ${fromStatus} to ${toStatus}`);

            } catch (error) {
                console.error('Error updating tuition status:', error);
                throw error;
            }
        }

        // Set up real-time listeners for status changes
        function setupRealtimeListeners() {
            if (!studentData) return;

            // Listen to tuitions collection
            db.collection('informedTuitions')
                .where('studentId', '==', studentData.humanId)
                .where('studentName', '==', studentData.fullName)
                .onSnapshot((snapshot) => {
                    console.log('Tuitions collection updated, reloading data...');
                    loadTuitionData();
                }, (error) => {
                    console.error('Error listening to tuitions:', error);
                });

            // Listen to extra fees collection
            db.collection('informedExtraFees')
                .where('studentId', '==', studentData.humanId)
                .where('studentName', '==', studentData.fullName)
                .onSnapshot((snapshot) => {
                    console.log('Extra fees collection updated, reloading data...');
                    loadTuitionData();
                }, (error) => {
                    console.error('Error listening to extra fees:', error);
                });
        }

        // Get current month and year in mm-yyyy format
        function getCurrentMonthYear() {
            const now = new Date();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            return `${month}-${year}`;
        }
        
        const translations = {
            en: {
                'header-title-line1': 'Tuition',
                'header-title-line2': ' Information',
                'student-id-label': 'Student ID:',
                'full-name-label': 'Full Name:',
                'class-label': 'Class:',
                'status-label': 'Status:',
                'student-status': 'Active',
                'payment-summary-title': 'Payment Summary',
                'payment-summary-title-desktop': 'Payment Summary',
                'total-outstanding-label': 'Total Outstanding',
                'total-outstanding-label-desktop': 'Total Outstanding',
                'pay-button-text': 'Pay Tuition',
                'pay-button-text-desktop': 'Pay Tuition',
                'instructions-note': 'Please click here for instructions',
                'instructions-note-desktop': 'Please click here for instructions',
                'tuition-info-title': 'Tuition Information',
                'unpaid-tab-title': 'Unpaid Tuition',
                'unpaid-tab-title-desktop': 'Unpaid Tuition',
                'processing-tab-title': 'Processing Payments',
                'processing-tab-title-desktop': 'Processing Payments',
                'paid-tab-title': 'Paid Tuition',
                'paid-tab-title-desktop': 'Paid Tuition',
                'payment-instructions-title': 'Payment Instructions',
                'total-amount-to-pay': 'Total Amount to Pay',
                'payment-notes-title': 'Payment Notes',
                'payment-notes-title-mobile': 'Payment Notes',
                'payment-notes-text': 'Scroll down to make confirmation once you finish the transaction. We can only process the payment if you do this.',
                'payment-notes-text-mobile': 'Scroll down to make confirmation once you finish the transaction. We can only process the payment if you do this.',
                'bank-transfer-title': 'Bank Transfer Details',
                'bank-transfer-title-mobile': 'Bank Transfer Details',
                'bank-name-label': 'Bank name:',
                'bank-name-label-mobile': 'Bank name:',
                'account-number-label': 'Account number:',
                'account-number-label-mobile': 'Account number:',
                'account-holder-label': 'Account holder:',
                'account-holder-label-mobile': 'Account holder:',
                'payment-reference-title': 'Payment Reference',
                'payment-reference-title-mobile': 'Payment Reference',
                'payment-reference-instruction': 'Please include this exact reference in your transfer:',
                'payment-reference-instruction-mobile': 'Please include this exact reference in your transfer:',
                'payment-confirmation-title': 'Payment Confirmation',
                'payment-confirmation-title-mobile': 'Payment Confirmation',
                'payment-confirmation-text': 'Please confirm you have completed the transaction. Our accountants will check and update the payment status in 5-10 business days.',
                'payment-confirmation-text-mobile': 'Please confirm you have completed the transaction. Our accountants will check and update the payment status in 5-10 business days.',
                'confirm-payment': 'I confirm that I have completed the transaction',
                'confirm-payment-mobile': 'I confirm that I have completed the transaction',
                'qr-code-payment': 'QR Code Payment',
                'qr-code-payment-mobile': 'QR Code Payment',
                'generating-qr': 'Generating QR Code...',
                'generating-qr-mobile': 'Generating QR Code...',
                'qr-warning': 'This is a one-time code. Please do NOT reuse it in the future.',
                'qr-warning-mobile': 'This is a one-time code. Please do NOT reuse it in the future.',
                'understood-button': 'Understood'
            },
            vi: {
                'header-title-line1': 'Th√¥ng tin',
                'header-title-line2': ' h·ªçc ph√≠',
                'student-id-label': 'M√£ h·ªçc sinh:',
                'full-name-label': 'H·ªç v√† t√™n:',
                'class-label': 'L·ªõp:',
                'status-label': 'Tr·∫°ng th√°i:',
                'student-status': 'ƒêang h·ªçc',
                'payment-summary-title': 'T√≥m t·∫Øt h·ªçc ph√≠ c·∫ßn ƒë√≥ng',
                'payment-summary-title-desktop': 'T√≥m t·∫Øt h·ªçc ph√≠ c·∫ßn ƒë√≥ng',
                'total-outstanding-label': 'T·ªïng c·∫ßn ƒë√≥ng',
                'total-outstanding-label-desktop': 'T·ªïng c·∫ßn ƒë√≥ng',
                'pay-button-text': 'ƒê√≥ng h·ªçc ph√≠',
                'pay-button-text-desktop': 'ƒê√≥ng h·ªçc ph√≠',
                'instructions-note': 'Vui l√≤ng nh·∫•p v√†o ƒë√¢y ƒë·ªÉ xem h∆∞·ªõng d·∫´n',
                'instructions-note-desktop': 'Vui l√≤ng nh·∫•p v√†o ƒë√¢y ƒë·ªÉ xem h∆∞·ªõng d·∫´n',
                'tuition-info-title': 'Th√¥ng tin h·ªçc ph√≠',
                'unpaid-tab-title': 'H·ªçc ph√≠ c·∫ßn ƒë√≥ng',
                'unpaid-tab-title-desktop': 'H·ªçc ph√≠ c·∫ßn ƒë√≥ng',
                'processing-tab-title': 'Thanh to√°n ƒëang x·ª≠ l√Ω',
                'processing-tab-title-desktop': 'Thanh to√°n ƒëang x·ª≠ l√Ω',
                'paid-tab-title': 'H·ªçc ph√≠ ƒë√£ ho√†n th√†nh',
                'paid-tab-title-desktop': 'H·ªçc ph√≠ ƒë√£ ho√†n th√†nh',
                'payment-instructions-title': 'H∆∞·ªõng D·∫´n ƒê√≥ng H·ªçc Ph√≠',
                'total-amount-to-pay': 'T·ªïng H·ªçc Ph√≠ C·∫ßn ƒê√≥ng',
                'payment-notes-title': 'L∆∞u √Ω khi ƒë√≥ng h·ªçc ph√≠',
                'payment-notes-title-mobile': 'L∆∞u √Ω khi ƒë√≥ng h·ªçc ph√≠',
                'payment-notes-text': 'Vui l√≤ng b·∫•m n√∫t "T√¥i x√°c nh·∫≠n ƒë√£ ƒë√≥ng ph√≠" ph√≠a d∆∞·ªõi sau khi ho√†n t·∫•t thanh to√°n. Ch√∫ng t√¥i s·∫Ω ch·ªâ x·ª≠ l√Ω v√† c·∫≠p nh·∫≠t ph√≠ sau khi nh·∫≠n ƒë∆∞·ª£c x√°c nh·∫≠n.',
                'payment-notes-text-mobile': 'Vui l√≤ng b·∫•m n√∫t "T√¥i x√°c nh·∫≠n ƒë√£ ƒë√≥ng ph√≠" ph√≠a d∆∞·ªõi sau khi ho√†n t·∫•t thanh to√°n. Ch√∫ng t√¥i s·∫Ω ch·ªâ x·ª≠ l√Ω v√† c·∫≠p nh·∫≠t ph√≠ sau khi nh·∫≠n ƒë∆∞·ª£c x√°c nh·∫≠n.',
                'bank-transfer-title': 'Th√¥ng tin chuy·ªÉn kho·∫£n',
                'bank-transfer-title-mobile': 'Th√¥ng tin chuy·ªÉn kho·∫£n',
                'bank-name-label': 'T√™n ng√¢n h√†ng:',
                'bank-name-label-mobile': 'T√™n ng√¢n h√†ng:',
                'account-number-label': 'S·ªë t√†i kho·∫£n:',
                'account-number-label-mobile': 'S·ªë t√†i kho·∫£n:',
                'account-holder-label': 'Ch·ªß t√†i kho·∫£n:',
                'account-holder-label-mobile': 'Ch·ªß t√†i kho·∫£n:',
                'payment-reference-title': 'N·ªôi dung chuy·ªÉn kho·∫£n',
                'payment-reference-title-mobile': 'N·ªôi dung chuy·ªÉn kho·∫£n',
                'payment-reference-instruction': 'Vui l√≤ng ghi ch√≠nh x√°c n·ªôi dung n√†y khi chuy·ªÉn kho·∫£n:',
                'payment-reference-instruction-mobile': 'Vui l√≤ng ghi ch√≠nh x√°c n·ªôi dung n√†y khi chuy·ªÉn kho·∫£n:',
                'payment-confirmation-title': 'X√°c nh·∫≠n thanh to√°n',
                'payment-confirmation-title-mobile': 'X√°c nh·∫≠n thanh to√°n',
                'payment-confirmation-text': 'Vui l√≤ng x√°c nh·∫≠n b·∫°n ƒë√£ ho√†n th√†nh giao d·ªãch. K·∫ø to√°n s·∫Ω ki·ªÉm tra v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n sau t·ªëi ƒëa 5-10 ng√†y l√†m vi·ªác.',
                'payment-confirmation-text-mobile': 'Vui l√≤ng x√°c nh·∫≠n b·∫°n ƒë√£ ho√†n th√†nh giao d·ªãch. K·∫ø to√°n s·∫Ω ki·ªÉm tra v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n sau t·ªëi ƒëa 5-10 ng√†y l√†m vi·ªác.',
                'confirm-payment': '‚úÖ T√¥i x√°c nh·∫≠n ƒë√£ ho√†n th√†nh giao d·ªãch',
                'confirm-payment-mobile': '‚úÖ T√¥i x√°c nh·∫≠n ƒë√£ ho√†n th√†nh giao d·ªãch',
                'qr-code-payment': 'Thanh To√°n QR Code',
                'qr-code-payment-mobile': 'Thanh To√°n QR Code',
                'generating-qr': 'ƒêang t·∫°o m√£ QR...',
                'generating-qr-mobile': 'ƒêang t·∫°o m√£ QR...',
                'qr-warning': 'ƒê√¢y l√† m√£ m·ªôt l·∫ßn. Vui l√≤ng KH√îNG s·ª≠ d·ª•ng l·∫°i trong t∆∞∆°ng lai.',
                'qr-warning-mobile': 'ƒê√¢y l√† m√£ m·ªôt l·∫ßn. Vui l√≤ng KH√îNG s·ª≠ d·ª•ng l·∫°i trong t∆∞∆°ng lai.',
                'understood-button': 'ƒê√£ hi·ªÉu'
            }
        };

        function toggleLanguage(targetLang) {
            if (targetLang && targetLang !== currentLanguage) {
                currentLanguage = targetLang;
                updateLanguage();
                updateLanguageToggleButton();
            }
        }

        function updateLanguage() {
            const translation = translations[currentLanguage];
            for (const [key, value] of Object.entries(translation)) {
                const element = document.getElementById(key);
                if (element) {
                    element.textContent = value;
                }
            }
        }

        function updateLanguageToggleButton() {
            const englishText = document.getElementById('english-text');
            const vietnameseText = document.getElementById('vietnamese-text');
            
            if (currentLanguage === 'en') {
                englishText.classList.add('font-bold');
                englishText.classList.remove('opacity-70');
                vietnameseText.classList.remove('font-bold');
                vietnameseText.classList.add('opacity-70');
            } else {
                vietnameseText.classList.add('font-bold');
                vietnameseText.classList.remove('opacity-70');
                englishText.classList.remove('font-bold');
                englishText.classList.add('opacity-70');
            }
        }

        function toggleTab(tabId) {
            console.log('toggleTab called with:', tabId);
            
            const content = document.getElementById(tabId + '-content');
            const arrow = document.getElementById(tabId + '-arrow');
            
            console.log('Content element:', content);
            console.log('Arrow element:', arrow);
            
            if (!content || !arrow) {
                console.error('Tab elements not found:', tabId + '-content', tabId + '-arrow');
                // Let's also check what elements actually exist
                console.log('Available elements with "content" in ID:', 
                    Array.from(document.querySelectorAll('[id*="content"]')).map(el => el.id));
                console.log('Available elements with "arrow" in ID:', 
                    Array.from(document.querySelectorAll('[id*="arrow"]')).map(el => el.id));
                return;
            }
            
            console.log('Current content classes:', content.className);
            console.log('Current arrow classes:', arrow.className);
            
            if (content.classList.contains('expanded')) {
                console.log('Collapsing tab');
                content.classList.remove('expanded');
                arrow.classList.remove('rotate-180');
            } else {
                console.log('Expanding tab');
                content.classList.add('expanded');
                arrow.classList.add('rotate-180');
            }
            
            console.log('After toggle - content classes:', content.className);
            console.log('After toggle - arrow classes:', arrow.className);
        }

        // VietQR Generation Function
        function generateVietQR(amount, content) {
            const img = document.getElementById('qrCodeImage');
            const loading = document.getElementById('qrCodeLoading');
            if (!img || !loading) return;
            
            loading.style.display = 'flex';
            img.style.display = 'none';
            
            const bankId = '970407'; // Techcombank
            const accountNo = '51414131319';
            const template = 'compact';
            const url = `https://img.vietqr.io/image/${bankId}-${accountNo}-${template}.png?amount=${amount}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent('HOANG THANH TUNG')}`;
            
            img.onload = () => {
                loading.style.display = 'none';
                img.style.display = 'block';
                
                // Also update mobile QR code
                const qrLoadingMobile = document.getElementById('qrCodeLoadingMobile');
                const qrImageMobile = document.getElementById('qrCodeImageMobile');
                if (qrLoadingMobile && qrImageMobile) {
                    qrLoadingMobile.style.display = 'none';
                    qrImageMobile.src = img.src;
                    qrImageMobile.style.display = 'block';
                }
            };
            
            img.onerror = () => {
                loading.style.display = 'none';
                img.style.display = 'none';
                console.error('Failed to load VietQR image');
            };
            
            img.src = url;
        }

        function openPaymentModal() {
            document.getElementById('paymentModal').classList.remove('hidden');
            
            // Generate real VietQR code with student data
            if (studentData) {
                // Get total amount from the displayed value (will be updated when real tuition data is loaded)
                const totalAmountElement = document.getElementById('total-amount');
                const amountText = totalAmountElement ? totalAmountElement.textContent : 'Loading...';
                
                if (amountText !== 'Loading...') {
                    // Extract numeric value from amount text (e.g., "1,250,000 VND" -> 1250000)
                    const amount = parseInt(amountText.replace(/[^\d]/g, '')) || 0;
                    const content = `${studentData.fullName} - ${studentData.dateOfBirth} - ${getCurrentMonthYear()}`;
                    generateVietQR(amount, content);
                }
            }
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
            // Reset QR code state
            document.getElementById('qrCodeLoading').style.display = 'flex';
            document.getElementById('qrCodeImage').style.display = 'none';
            const qrLoadingMobile = document.getElementById('qrCodeLoadingMobile');
            const qrImageMobile = document.getElementById('qrCodeImageMobile');
            if (qrLoadingMobile && qrImageMobile) {
                qrLoadingMobile.style.display = 'flex';
                qrImageMobile.style.display = 'none';
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Show a brief success message
                const originalText = event.target.textContent;
                event.target.textContent = '‚úÖ Copied!';
                event.target.classList.add('bg-green-100', 'text-green-700');
                setTimeout(() => {
                    event.target.textContent = originalText;
                    event.target.classList.remove('bg-green-100', 'text-green-700');
                }, 1500);
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const originalText = event.target.textContent;
                event.target.textContent = '‚úÖ Copied!';
                setTimeout(() => {
                    event.target.textContent = originalText;
                }, 1500);
            });
        }

        async function confirmPayment() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚è≥ ƒêang x·ª≠ l√Ω...';
            button.classList.remove('bg-orange-600', 'hover:bg-orange-700');
            button.classList.add('bg-gray-400');
            button.disabled = true;
            
            try {
                // Update all informed tuitions to processing
                await updateTuitionStatus('informed', 'processing');
                
                // Show success message
                setTimeout(() => {
                    alert(currentLanguage === 'vi' ? 
                        'C·∫£m ∆°n b·∫°n ƒë√£ x√°c nh·∫≠n! H·ªçc ph√≠ ƒë√£ ƒë∆∞·ª£c chuy·ªÉn sang tr·∫°ng th√°i "ƒêang x·ª≠ l√Ω". Ch√∫ng t√¥i s·∫Ω x·ª≠ l√Ω thanh to√°n trong 5-10 ng√†y l√†m vi·ªác.' : 
                        'Thank you for confirming! Tuition has been moved to "Processing" status. We will process your payment within 5-10 business days.');
                    closePaymentModal();
                    
                    // Reset button state when modal is reopened
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.add('bg-orange-600', 'hover:bg-orange-700');
                        button.classList.remove('bg-gray-400');
                        button.disabled = false;
                    }, 1000);
                }, 1000);
                
            } catch (error) {
                console.error('Error updating payment status:', error);
                alert(currentLanguage === 'vi' ? 
                    'C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n. Vui l√≤ng th·ª≠ l·∫°i.' : 
                    'An error occurred while updating payment status. Please try again.');
                
                // Reset button state on error
                button.textContent = originalText;
                button.classList.add('bg-orange-600', 'hover:bg-orange-700');
                button.classList.remove('bg-gray-400');
                button.disabled = false;
            }
        }



        // Event listeners
        document.getElementById('english-text').addEventListener('click', () => toggleLanguage('en'));
        document.getElementById('vietnamese-text').addEventListener('click', () => toggleLanguage('vi'));
        document.getElementById('pay-button').addEventListener('click', openPaymentModal);
        document.getElementById('pay-button-desktop').addEventListener('click', openPaymentModal);

        // Close modal when clicking outside
        document.getElementById('paymentModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePaymentModal();
            }
        });

        // Initialize with unpaid tab expanded on desktop and Vietnamese as default
        document.addEventListener('DOMContentLoaded', function() {
            // Desktop unpaid tab starts expanded
            const desktopUnpaidContent = document.getElementById('unpaid-desktop-content');
            const desktopUnpaidArrow = document.getElementById('unpaid-desktop-arrow');
            if (desktopUnpaidContent && desktopUnpaidArrow) {
                desktopUnpaidContent.classList.add('expanded');
                desktopUnpaidArrow.classList.add('rotate-180');
            }
            
            // Initialize language toggle button appearance
            updateLanguageToggleButton();

            // Load student data from URL parameter (document ID)
            const studentDocumentId = getStudentIdFromUrl();
            if (studentDocumentId) {
                loadStudentData(studentDocumentId);
            } else {
                showErrorState('No student document ID provided in URL');
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'984b220bd4078494',t:'MTc1ODgwOTcxOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
